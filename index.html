<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hill Climb Canvas</title>
<link href="https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@700;800;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
<script>
(function(){
  try {
    let hostname = window.location.hostname;
    if(hostname.includes('poki.com')||window.location.search.includes('poki=true')){
      const s=document.createElement('script');s.src='https://game-cdn.poki.com/scripts/v2/poki-sdk.js';s.async=true;document.head.appendChild(s);
    }
    if(hostname.includes('crazygames.com')||window.location.search.includes('crazygames=true')){
      const s=document.createElement('script');s.src='https://sdk.crazygames.com/crazygames-sdk-v2.js';s.async=true;document.head.appendChild(s);
    }
  } catch(e) {}
})();
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',system-ui,sans-serif;background:#060b1a;color:#f5f5f5}
button{cursor:pointer;border:none;font-family:inherit}
/* ═══════════════════════════════════════════════════════════
   HILL CLIMB RACING — ENHANCED STYLESHEET
   100% original code — free to publish (no copyright claims)
═══════════════════════════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@700;800;900&family=Orbitron:wght@700;900&display=swap');

/* ── Reset ────────────────────────────────────────────── */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: 'Nunito', system-ui, -apple-system, sans-serif;
  background: #060b1a;
  color: #f5f5f5;
}

button {
  cursor: pointer;
  border: none;
  font-family: inherit;
}

/* ── Game root ────────────────────────────────────────── */
#game-root {
  position: relative;
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: stretch;
  justify-content: center;
  background:
    radial-gradient(ellipse at 30% 0%,   rgba(80,30,180,0.35) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 100%, rgba(20,80,200,0.35) 0%, transparent 55%),
    linear-gradient(160deg, #050c22 0%, #08152e 50%, #04091a 100%);
}

#game-canvas {
  width: 100%;
  height: 100%;
  display: block;
  background: transparent;
}

/* ── Screens ──────────────────────────────────────────── */
.screen {
  position: absolute;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
}
.screen.active { display: flex; }

/* ── Generic panel ────────────────────────────────────── */
.panel {
  background: rgba(8, 14, 35, 0.92);
  border-radius: 22px;
  padding: 24px 28px;
  min-width: min(90vw, 480px);
  box-shadow:
    0 24px 60px rgba(0,0,0,0.7),
    0 0 0 1px rgba(99,180,255,0.08),
    inset 0 1px 0 rgba(255,255,255,0.06);
  border: 1px solid rgba(99,180,255,0.14);
}

.panel h1.title {
  font-family: 'Boogaloo', cursive;
  font-size: 2.2rem;
  text-align: center;
  margin-bottom: 20px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: linear-gradient(90deg, #63caff, #a78bfa, #34d399, #63caff);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 4s linear infinite;
}

.panel h2 {
  text-align: center;
  margin-bottom: 16px;
  font-family: 'Orbitron', monospace;
  font-size: 1rem;
  letter-spacing: 0.1em;
  color: rgba(255,255,255,0.85);
}

.panel button {
  width: 100%;
  padding: 12px 14px;
  margin: 6px 0;
  border-radius: 999px;
  background: linear-gradient(135deg, #f97316, #ef4444);
  color: #fff;
  font-weight: 800;
  font-size: 0.95rem;
  letter-spacing: 0.06em;
  box-shadow: 0 5px 0 rgba(0,0,0,0.35), 0 0 20px rgba(249,115,22,0.25);
  transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.12s;
  position: relative; overflow: hidden;
}
.panel button::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.12) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: shimmer 2.5s linear infinite;
}
.panel button:hover  { filter: brightness(1.1); transform: translateY(-1px); }
.panel button:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.4); }

.btn-back {
  margin-top: 8px;
  background: linear-gradient(135deg, #475569, #334155) !important;
  box-shadow: 0 4px 0 rgba(0,0,0,0.3) !important;
}

/* ═══════════════════════════════════════════════════════
   LEVEL SELECT
═══════════════════════════════════════════════════════ */
#level-grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 7px;
  margin-bottom: 12px;
}

.level-section-header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--diff-color);
  margin: 4px 0 2px;
}
.level-section-header .diff-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--diff-color);
  flex-shrink: 0;
  box-shadow: 0 0 6px var(--diff-color);
}
.level-section-header .diff-line {
  flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--diff-color) 0%, transparent 100%);
  opacity: 0.35;
}

.panel-levels {
  min-width: min(96vw, 640px);
  max-width: min(96vw, 700px);
  max-height: 92vh;
  overflow-y: auto;
  padding: 20px 22px 16px;
  scrollbar-width: thin;
  scrollbar-color: rgba(99,180,255,0.2) transparent;
}
.panel-levels::-webkit-scrollbar { width: 4px; }
.panel-levels::-webkit-scrollbar-thumb { background: rgba(99,180,255,0.2); border-radius: 4px; }

.levels-header { text-align: center; margin-bottom: 10px; }
.levels-header h2 {
  font-family: 'Boogaloo', cursive;
  font-size: 1.6rem;
  font-weight: 400;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  background: linear-gradient(90deg, #60a5fa, #a78bfa, #34d399);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 2px;
}
.levels-subtitle {
  font-size: 0.7rem;
  opacity: 0.5;
  letter-spacing: 0.1em;
}

.level-tile {
  position: relative;
  padding: 7px 4px 6px;
  border-radius: 14px;
  font-size: 0.62rem;
  text-align: center;
  background: rgba(15,20,45,0.9);
  color: #f0f0f0;
  border: 1px solid rgba(255,255,255,0.07);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  cursor: pointer;
  transition: transform 0.14s cubic-bezier(.34,1.56,.64,1), box-shadow 0.15s ease, border-color 0.15s ease;
  overflow: hidden;
}
.level-tile::before {
  content: '';
  position: absolute; inset: 0; border-radius: inherit;
  background: radial-gradient(circle at 50% 0%, var(--diff-glow, transparent) 0%, transparent 65%);
  pointer-events: none;
}
.level-tile:not(.locked):hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 10px 26px var(--diff-glow, rgba(0,0,0,0.3)), 0 0 0 1px var(--diff-color, transparent);
  border-color: var(--diff-color);
  z-index: 2;
}
.level-tile:not(.locked):hover .lt-play-hint { opacity: 1; }
.level-tile:not(.locked):active { transform: translateY(0) scale(0.97); }

.level-tile::after {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
  border-radius: 14px 14px 0 0;
  background: var(--diff-color, transparent);
  opacity: 0.7;
  box-shadow: 0 0 8px var(--diff-color, transparent);
}

.level-tile.easy     { --diff-color: #4ade80; --diff-glow: rgba(74,222,128,0.25); }
.level-tile.normal   { --diff-color: #60a5fa; --diff-glow: rgba(96,165,250,0.25); }
.level-tile.hard     { --diff-color: #f87171; --diff-glow: rgba(248,113,113,0.25); }
.level-tile.advanced { --diff-color: #c084fc; --diff-glow: rgba(192,132,252,0.28); }
.level-tile.locked   { opacity: 0.45; filter: saturate(0.3); cursor: not-allowed; }

.lt-icon   { font-size: 1.1rem; line-height: 1; margin-bottom: 1px; }
.lt-lock   { opacity: 0.7; }
.lt-num    { font-size: 0.95rem; font-weight: 800; color: #fff; line-height: 1; font-family: 'Orbitron', monospace; }
.lt-name   { font-size: 0.52rem; opacity: 0.75; line-height: 1.1; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lt-stars  { display: flex; gap: 1px; justify-content: center; line-height: 1; }
.lt-stars .star       { font-size: 0.6rem; color: rgba(255,255,255,0.2); }
.lt-stars .star.earned { color: #fbbf24; text-shadow: 0 0 8px rgba(251,191,36,0.8); }
.lt-play-hint {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  border-radius: inherit;
  background: rgba(0,0,0,0.6);
  font-size: 0.72rem; font-weight: 700;
  color: var(--diff-color);
  opacity: 0; transition: opacity 0.15s;
  letter-spacing: 0.05em;
  backdrop-filter: blur(3px);
}

/* ═══════════════════════════════════════════════════════
   VEHICLE CAROUSEL / STATS (legacy)
═══════════════════════════════════════════════════════ */
#vehicle-carousel { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
#vehicle-stats    { margin-bottom: 10px; font-size: 0.8rem; }

.stat-row           { display: flex; align-items: center; margin: 2px 0; }
.stat-row span      { width: 90px; }
.stat-bar           { flex: 1; height: 6px; border-radius: 999px; overflow: hidden; background: rgba(255,255,255,0.1); }
.stat-bar-fill      { height: 100%; border-radius: inherit; background: linear-gradient(90deg, #4facfe, #00f2fe); }

#vehicle-actions { display: flex; gap: 8px; margin-bottom: 6px; }

/* ═══════════════════════════════════════════════════════
   HUD
═══════════════════════════════════════════════════════ */
#hud {
  position: absolute; inset: 0;
  pointer-events: none;
  display: flex; flex-direction: column;
  justify-content: space-between;
  padding: 10px;
}
#hud-top {
  display: flex; align-items: center; justify-content: space-between;
}
#hud-coins {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 10px; border-radius: 999px;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);
  pointer-events: auto;
  border: 1px solid rgba(255,215,0,0.2);
}
.icon-coin {
  width: 18px; height: 18px; border-radius: 999px;
  background: radial-gradient(circle at 30% 20%, #fff7c3 0, #ffd95e 45%, #f6a623 100%);
  box-shadow: 0 0 10px rgba(255,230,120,0.7);
}
#hud-distance {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  font-size: 0.8rem; pointer-events: auto;
}
.hud-button {
  pointer-events: auto; width: 36px; height: 36px; border-radius: 999px;
  background: rgba(0,0,0,0.5); color: #f5f5f5; font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.12);
}
#hud-bottom {
  display: flex; align-items: flex-end; justify-content: space-between;
  width: 100%; pointer-events: none;
}
.pedal {
  pointer-events: auto;
  width: 28vw; max-width: 160px; min-width: 90px;
  height: 70px; border-radius: 30px;
  background: radial-gradient(circle at 30% 10%, #ffffff 0, #e0e4ff 12%, #5861ff 70%, #242a84 100%);
  color: #111320; font-weight: 700;
  box-shadow: 0 10px 0 rgba(0,0,0,0.6);
  transform-origin: center bottom;
  transition: transform 0.05s ease, box-shadow 0.05s ease, filter 0.1s;
}
.pedal:active { transform: translateY(4px) scale(0.98); box-shadow: 0 5px 0 rgba(0,0,0,0.7); }
#hud-gauges  { display: flex; gap: 8px; align-items: center; justify-content: center; pointer-events: none; }

/* ── Low fuel flash ─────────────────────────────────── */
.flash-low-fuel { animation: lowFuelFlash 0.6s infinite alternate; }
@keyframes lowFuelFlash {
  from { box-shadow: 0 0 0 0 rgba(255,80,80,0.0); }
  to   { box-shadow: 0 0 25px 6px rgba(255,80,80,0.5); }
}

.ad-label {
  font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.18em; opacity: 0.65; margin-bottom: 4px;
}

@media (max-width: 640px) {
  .panel { min-width: 90vw; padding: 18px 18px; }
}

/* ═══════════════════════════════════════════════════════
   GARAGE SCREEN
═══════════════════════════════════════════════════════ */
#screen-garage { align-items: stretch; justify-content: stretch; padding: 0; }

.garage-wrap {
  display: flex; flex-direction: column;
  width: 100%; height: 100%;
  background:
    radial-gradient(ellipse at 30% 0%,   rgba(60,20,140,0.35)  0%, transparent 55%),
    radial-gradient(ellipse at 80% 100%, rgba(20,60,160,0.35)  0%, transparent 55%),
    linear-gradient(160deg, #050c22 0%, #08152e 50%, #04091a 100%);
  overflow: hidden;
}

.garage-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px 8px; flex-shrink: 0;
  border-bottom: 1px solid rgba(99,180,255,0.1);
  position: relative;
}
.garage-head::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(99,180,255,0.5), rgba(167,139,250,0.5), transparent);
}

.garage-title {
  font-family: 'Boogaloo', cursive;
  font-size: clamp(1.3rem, 3.5vw, 2rem);
  letter-spacing: 0.1em;
  background: linear-gradient(135deg, #fff 0%, #63caff 50%, #a78bfa 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
}

.garage-coins {
  font-family: 'Orbitron', monospace;
  font-size: 0.85rem; color: #ffd700;
  background: rgba(255,215,0,0.12);
  border: 1.5px solid rgba(255,215,0,0.3);
  padding: 6px 14px; border-radius: 22px;
  box-shadow: 0 0 14px rgba(255,215,0,0.15);
  text-shadow: 0 0 10px rgba(255,215,0,0.4);
}

.garage-tabs {
  display: flex; gap: 10px;
  padding: 12px 24px 10px; flex-shrink: 0;
}
.garage-tab {
  font-family: 'Orbitron', monospace;
  font-size: 0.65rem; letter-spacing: 0.14em;
  padding: 7px 20px;
  border: 1px solid rgba(255,255,255,0.1);
  background: transparent; color: rgba(255,255,255,0.45);
  cursor: pointer; text-transform: uppercase;
  border-radius: 6px; transition: all 0.2s;
}
.garage-tab.active, .garage-tab:hover {
  background: rgba(99,180,255,0.14);
  border-color: #63caff; color: #63caff;
  box-shadow: 0 0 12px rgba(99,180,255,0.15);
}

.garage-grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
  grid-auto-rows: minmax(290px, auto);
  gap: 14px;
  padding: 0 20px 16px;
  overflow-y: auto;
  align-content: start;
  scrollbar-width: thin;
  scrollbar-color: rgba(99,180,255,0.25) transparent;
}

.garage-footer {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 24px 16px; flex-shrink: 0;
  border-top: 1px solid rgba(99,180,255,0.1);
  background: rgba(0,0,0,0.3);
}
.garage-footer button {
  flex: 1; padding: 13px 10px; border-radius: 14px;
  font-family: 'Orbitron', monospace; font-size: 0.72rem;
  font-weight: 700; letter-spacing: 0.1em;
  cursor: pointer; border: none;
  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
}
.garage-footer button:hover  { transform: translateY(-2px); opacity: 0.92; }
.garage-footer button:active { transform: scale(0.97); }

#btn-watch-ad-coins {
  background: linear-gradient(135deg, #ff6b6b, #ff8e53);
  color: #fff;
  box-shadow: 0 5px 20px rgba(255,100,80,0.4);
}
.garage-footer .btn-back {
  background: rgba(255,255,255,0.07);
  color: rgba(255,255,255,0.75);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: none; flex: 0 0 auto; padding: 13px 26px;
}

/* ── Vehicle cards ───────────────────────────────────── */
.gcard {
  position: relative;
  background: linear-gradient(155deg, rgba(15,22,48,0.95) 0%, rgba(8,14,35,0.98) 100%);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 18px; overflow: hidden;
  min-height: 290px;
  display: flex; flex-direction: column;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.3s, border-color 0.3s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.gcard:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 0 20px 48px rgba(0,0,0,0.6), 0 0 30px rgba(99,180,255,0.12);
  border-color: rgba(99,180,255,0.2);
}
.gcard:active { transform: scale(0.96); transition: transform 0.08s ease; }

.gcard-selected {
  border-color: #34d399 !important;
  box-shadow: 0 0 0 2px rgba(52,211,153,0.35), 0 8px 30px rgba(52,211,153,0.15) !important;
}
.gcard-locked { opacity: 0.72; }

.gcard-bar    { height: 3px; }
.gcard-stage  {
  position: relative; height: 100px;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; background: rgba(0,0,0,0.3);
}
.gcard-svg {
  position: relative; z-index: 2;
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  filter: drop-shadow(0 8px 16px rgba(0,0,0,0.6));
  max-width: 95%;
}
.gcard-svg svg { max-width: 100%; height: auto; }
.gcard:hover .gcard-svg { transform: scale(1.08) translateY(-4px); }

.gcard-lock  {
  position: absolute; top: 8px; right: 10px;
  font-size: 1rem; opacity: 0.55; z-index: 3;
}
.gcard-selected-badge {
  position: absolute; top: 8px; left: 10px;
  font-size: 0.56rem; font-weight: 700; letter-spacing: 0.12em;
  background: rgba(52,211,153,0.2); color: #34d399;
  border: 1px solid rgba(52,211,153,0.4);
  padding: 3px 7px; border-radius: 20px; z-index: 3;
}

.gcard-body  {
  padding: 10px 12px 12px;
  display: flex; flex-direction: column; gap: 6px; flex: 1;
  background: linear-gradient(155deg, rgba(15,22,48,0.95) 0%, rgba(8,14,35,0.98) 100%);
}
.gcard-header {
  display: flex; align-items: flex-start; justify-content: space-between;
}
.gcard-name {
  font-family: 'Orbitron', monospace;
  font-size: 0.82rem; font-weight: 700; letter-spacing: 0.05em; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px;
}
.gcard-type   { font-size: 0.64rem; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.55); margin-top: 1px; }
.gcard-badge  { font-family: 'Orbitron', monospace; font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 20px; white-space: nowrap; flex-shrink: 0; }
.gcard-badge.gfree { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.3); }
.gcard-badge.gpaid { background: rgba(255,215,0,0.1);   color: #ffd700; border: 1px solid rgba(255,215,0,0.25); }

.gcard-stats  { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; }
.gcard-stat   { display: flex; flex-direction: column; gap: 3px; }
.gcard-stat-label { font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(255,255,255,0.7); font-weight: 700; }
.gcard-stat-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
.gcard-stat-fill  { height: 100%; border-radius: 3px; transition: width 0.45s ease; }

.gcard-action { margin-top: 2px; }
.gcard-btn {
  width: 100%; padding: 8px; border-radius: 10px;
  font-size: 0.7rem; font-weight: 700; letter-spacing: 0.07em;
  border: none; cursor: pointer;
  transition: opacity 0.2s, transform 0.15s, box-shadow 0.15s;
}
.gcard-btn:hover:not(:disabled) { transform: scale(1.04); opacity: 0.92; }
.gcard-btn-select   { background: linear-gradient(135deg, #63caff, #a78bfa); color: #fff; box-shadow: 0 4px 16px rgba(99,180,255,0.35); }
.gcard-btn-selected { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.4); cursor: default; }
.gcard-btn-unlock   { background: linear-gradient(135deg, #ffd200, #f7971e); color: #1a0a00; box-shadow: 0 4px 14px rgba(255,180,0,0.3); }
.gcard-btn-unlock.cant-afford { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.3); cursor: not-allowed; box-shadow: none; }

@keyframes gcard-shake {
  0%,100%{ transform: translateX(0); }
  20%    { transform: translateX(-7px); }
  40%    { transform: translateX(7px);  }
  60%    { transform: translateX(-5px); }
  80%    { transform: translateX(5px);  }
}
.gcard-shake { animation: gcard-shake 0.4s ease; border-color: #ef4444 !important; }

/* ═══════════════════════════════════════════════════════
   UNLOCK VEHICLE MODAL
═══════════════════════════════════════════════════════ */
.umodal-overlay {
  position: fixed; inset: 0; z-index: 9000;
  background: rgba(0,0,0,0.78);
  backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.umodal {
  position: relative;
  background: linear-gradient(160deg, #0d1628 0%, #18243e 100%);
  border: 1px solid rgba(99,180,255,0.15);
  border-radius: 24px;
  padding: 28px 26px 24px;
  width: 100%; max-width: 360px;
  display: flex; flex-direction: column; align-items: center; gap: 10px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(99,180,255,0.08);
  animation: umodal-in 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes umodal-in {
  from { transform: scale(0.8) translateY(30px); opacity: 0; }
  to   { transform: scale(1)   translateY(0);    opacity: 1; }
}
.umodal-close {
  position: absolute; top: 12px; right: 14px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(255,255,255,0.5);
  width: 30px; height: 30px; border-radius: 50%;
  font-size: 0.8rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s, color 0.2s;
}
.umodal-close:hover { background: rgba(255,80,80,0.25); color: #ff6b6b; }

.umodal-svg { width: 160px; height: 90px; display: flex; align-items: center; justify-content: center; filter: drop-shadow(0 8px 20px rgba(0,0,0,0.6)); }
.umodal-svg svg { max-width: 100%; max-height: 100%; }
.umodal-name { font-family: 'Orbitron', monospace; font-size: 1.05rem; font-weight: 900; letter-spacing: 0.08em; color: #fff; text-align: center; }
.umodal-type { font-size: 0.68rem; letter-spacing: 0.18em; text-transform: uppercase; color: rgba(255,255,255,0.45); }

.umodal-price-row { display: flex; align-items: center; gap: 10px; margin-top: 4px; }
.umodal-original  { font-family: 'Orbitron', monospace; font-size: 0.9rem; color: rgba(255,255,255,0.3); text-decoration: line-through; }
.umodal-current   { font-family: 'Orbitron', monospace; font-size: 1.35rem; font-weight: 900; color: #ffd700; letter-spacing: 0.04em; text-shadow: 0 0 10px rgba(255,215,0,0.4); }
.umodal-current.free { color: #34d399; text-shadow: 0 0 10px rgba(52,211,153,0.4); }

.umodal-adsaved { font-size: 0.65rem; color: #63caff; letter-spacing: 0.1em; min-height: 16px; }

.umodal-btns { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 6px; }
.umodal-btn  {
  width: 100%; padding: 13px 16px; border-radius: 14px;
  font-family: 'Orbitron', monospace; font-size: 0.75rem;
  font-weight: 700; letter-spacing: 0.09em;
  border: none; cursor: pointer;
  transition: transform 0.15s, opacity 0.15s, box-shadow 0.15s;
}
.umodal-btn:active { transform: scale(0.97); }
.umodal-btn-ad { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #63caff; border: 1px solid rgba(99,180,255,0.3); box-shadow: 0 4px 16px rgba(99,180,255,0.12); }
.umodal-btn-ad:hover { opacity: 0.88; border-color: #63caff; }
.umodal-btn-ad:disabled { opacity: 0.45; cursor: not-allowed; }
.umodal-btn-buy.afford    { background: linear-gradient(135deg, #f7971e, #ffd200); color: #1a0700; box-shadow: 0 6px 22px rgba(255,180,0,0.45); }
.umodal-btn-buy.afford:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,180,0,0.55); }
.umodal-btn-buy.no-afford { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.1); cursor: not-allowed; }

.umodal-hint { font-size: 0.6rem; color: rgba(255,255,255,0.3); letter-spacing: 0.1em; }

/* ═══════════════════════════════════════════════════════
   VEHICLE UPGRADE SCREEN — FULL SPECTACULAR REDESIGN
═══════════════════════════════════════════════════════ */

/* ── Keyframes ─────────────────────────────────────── */
@keyframes shimmer {
  0%   { background-position: -200% 0; }
  100% { background-position:  200% 0; }
}
@keyframes twinkle  { 0%,100%{ opacity:0.2; } 50%{ opacity:1; } }
@keyframes nebula   { 0%,100%{ opacity:0.5; transform:scale(1) rotate(0deg); } 50%{ opacity:0.8; transform:scale(1.06) rotate(8deg); } }
@keyframes coinSpin { from{ transform:rotateY(0deg); } to{ transform:rotateY(360deg); } }
@keyframes pulseBorder {
  0%,100%{ box-shadow: 0 0 0 0 rgba(99,200,255,0), inset 0 0 20px rgba(99,200,255,0.05); }
  50%    { box-shadow: 0 0 22px 4px rgba(99,200,255,0.25), inset 0 0 20px rgba(99,200,255,0.12); }
}
@keyframes fillUp  { from{ width:0%; } to{ width:var(--target-w); } }
@keyframes popIn   {
  0%  { transform:scale(0.6) translateY(20px); opacity:0; }
  70% { transform:scale(1.07) translateY(-4px); }
  100%{ transform:scale(1) translateY(0);    opacity:1; }
}
@keyframes upgr-float  { 0%,100%{ transform:translateY(0px); }  50%{ transform:translateY(-10px); } }
@keyframes upgr-glow   { 0%,100%{ filter:drop-shadow(0 20px 40px rgba(0,0,0,0.7)) drop-shadow(0 0 20px rgba(99,180,255,0.15)); } 50%{ filter:drop-shadow(0 20px 40px rgba(0,0,0,0.7)) drop-shadow(0 0 35px rgba(99,180,255,0.35)); } }
@keyframes upgr-shake  { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
@keyframes upgr-bounce { 0%,100%{transform:scale(1)} 40%{transform:scale(1.1) rotate(-2deg)} 70%{transform:scale(0.95)} }
@keyframes zoomPulse   { 0%,100%{transform:translateX(-50%) scale(1);} 50%{transform:translateX(-50%) scale(1.08);} }
@keyframes sparkle     { 0%{transform:scale(0) rotate(0deg);opacity:1;} 100%{transform:scale(1.5) rotate(180deg);opacity:0;} }
@keyframes starTwinkle { 0%,100%{opacity:0.15;} 50%{opacity:0.9;} }

/* ── Nebula BG elements ─────────────────────────────── */
.upgr-nebula {
  position: absolute; border-radius: 50%;
  pointer-events: none; filter: blur(70px);
  animation: nebula 9s ease-in-out infinite;
}
.upgr-nb1 { width:380px; height:280px; left:-80px; top:-40px; background:radial-gradient(ellipse, rgba(70,20,150,0.5) 0%, transparent 70%); }
.upgr-nb2 { width:320px; height:320px; right:-60px; bottom:60px; background:radial-gradient(ellipse, rgba(20,60,160,0.45) 0%, transparent 70%); animation-delay:-4s; }
.upgr-nb3 { width:220px; height:180px; left:40%; top:35%; background:radial-gradient(ellipse, rgba(20,100,80,0.3) 0%, transparent 70%); animation-delay:-6s; }

/* ── Stars layer ─────────────────────────────────────── */
.upgr-stars {
  position: absolute; inset: 0; pointer-events: none;
  background-image:
    radial-gradient(1px   1px   at 12% 18%, rgba(255,255,255,0.9) 0%, transparent 100%),
    radial-gradient(1px   1px   at 38% 55%, rgba(255,255,255,0.7) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 64% 8%,  rgba(180,220,255,0.8) 0%, transparent 100%),
    radial-gradient(1px   1px   at 82% 72%, rgba(255,255,255,0.6) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 9%  82%, rgba(255,220,180,0.7) 0%, transparent 100%),
    radial-gradient(1px   1px   at 91% 32%, rgba(255,255,255,0.8) 0%, transparent 100%),
    radial-gradient(1px   1px   at 53% 43%, rgba(180,255,220,0.6) 0%, transparent 100%),
    radial-gradient(2px   2px   at 28% 88%, rgba(255,255,255,0.5) 0%, transparent 100%),
    radial-gradient(1px   1px   at 72% 52%, rgba(255,255,255,0.9) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 4%  48%, rgba(200,180,255,0.8) 0%, transparent 100%),
    radial-gradient(1px   1px   at 96% 78%, rgba(255,255,255,0.6) 0%, transparent 100%),
    radial-gradient(1px   1px   at 46% 22%, rgba(255,255,255,0.7) 0%, transparent 100%);
  animation: starTwinkle 4s ease-in-out infinite;
}

/* ── Main container ──────────────────────────────────── */
#upgr-screen {
  position: fixed; inset: 0; z-index: 7500;
  background:
    radial-gradient(ellipse at 30% 0%,   rgba(80,30,180,0.4)  0%, transparent 55%),
    radial-gradient(ellipse at 80% 100%, rgba(20,80,200,0.4)  0%, transparent 55%),
    linear-gradient(160deg, #050c22 0%, #08152e 50%, #04091a 100%);
  display: flex; flex-direction: column; overflow: hidden;
  font-family: 'Nunito', sans-serif;
}

/* ── Top bar ─────────────────────────────────────────── */
.upgr-topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px 12px;
  background: rgba(0,0,0,0.5);
  border-bottom: 1px solid rgba(99,180,255,0.15);
  flex-shrink: 0; position: relative; z-index: 2;
}
.upgr-topbar::after {
  content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(99,180,255,0.65), rgba(167,139,250,0.65), transparent);
}

.upgr-back-btn {
  width: 48px; height: 48px; border-radius: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
  border: 1.5px solid rgba(255,255,255,0.2);
  color: #fff; font-size: 1.8rem; font-weight: 900; line-height: 1;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  text-shadow: 0 0 12px rgba(255,255,255,0.5);
}
.upgr-back-btn:hover  { background: rgba(99,180,255,0.22); border-color: rgba(99,180,255,0.7); transform: scale(1.08); box-shadow: 0 0 18px rgba(99,180,255,0.35); }
.upgr-back-btn:active { transform: scale(0.93); }

.upgr-title-zone  { display: flex; flex-direction: column; align-items: center; }
.upgr-screen-label {
  font-family: 'Orbitron', monospace; font-size: 0.5rem;
  font-weight: 700; letter-spacing: 0.28em; color: rgba(99,180,255,0.6);
  text-transform: uppercase;
}
.upgr-screen-title {
  font-family: 'Boogaloo', cursive; font-size: 1.55rem;
  background: linear-gradient(90deg, #63caff, #a78bfa, #34d399, #63caff);
  background-size: 300% 100%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 4s linear infinite;
  letter-spacing: 0.06em;
}

.upgr-coin-display {
  display: flex; align-items: center; gap: 8px;
  font-family: 'Orbitron', monospace; font-size: 1.12rem; font-weight: 900;
  color: #ffd700;
  background: linear-gradient(135deg, rgba(255,215,0,0.16), rgba(200,140,0,0.1));
  border: 1.5px solid rgba(255,215,0,0.4);
  padding: 8px 16px; border-radius: 24px;
  box-shadow: 0 0 16px rgba(255,215,0,0.18), inset 0 1px 0 rgba(255,255,255,0.1);
  text-shadow: 0 0 10px rgba(255,215,0,0.5);
  animation: pulseBorder 3s ease-in-out infinite;
}
.upgr-coin-display svg { animation: coinSpin 3s linear infinite; display: block; }

/* ── Tiles panel ─────────────────────────────────────── */
.upgr-tiles-panel {
  padding: 16px 14px 14px;
  background: linear-gradient(180deg, rgba(10,25,70,0.97) 0%, rgba(6,14,42,0.93) 100%);
  border-bottom: 2px solid rgba(80,130,220,0.2);
  flex-shrink: 0; position: relative; z-index: 2;
}
.upgr-tiles-row {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
}

/* ── Tiles ───────────────────────────────────────────── */
.upgr-tile {
  position: relative;
  background: linear-gradient(155deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03));
  border: 1.5px solid rgba(255,255,255,0.13);
  border-radius: 18px;
  padding: 14px 8px 12px;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  cursor: pointer; user-select: none; overflow: hidden;
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), border-color 0.2s, box-shadow 0.2s;
  animation: popIn 0.5s cubic-bezier(.34,1.56,.64,1) both;
}
.upgr-tile:nth-child(1){ animation-delay:0.05s; }
.upgr-tile:nth-child(2){ animation-delay:0.12s; }
.upgr-tile:nth-child(3){ animation-delay:0.19s; }
.upgr-tile:nth-child(4){ animation-delay:0.26s; }

/* Sheen */
.upgr-tile::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.07), transparent 60%);
  border-radius: inherit; pointer-events: none;
}
/* Top accent stripe */
.upgr-tile::after {
  content: ''; position: absolute; top: 0; left: 20%; right: 20%;
  height: 2px; border-radius: 0 0 4px 4px;
  background: var(--tile-color, rgba(99,180,255,0.7));
  box-shadow: 0 0 8px var(--tile-color, rgba(99,180,255,0.5));
}

.upgr-tile[data-key="engine"]     { --tile-color: #f97316; }
.upgr-tile[data-key="suspension"] { --tile-color: #a78bfa; }
.upgr-tile[data-key="tires"]      { --tile-color: #34d399; }
.upgr-tile[data-key="fuel"]       { --tile-color: #fb923c; }

.upgr-tile:hover:not(.upgr-tile-max) {
  transform: translateY(-6px) scale(1.04);
  border-color: var(--tile-color, rgba(99,180,255,0.6));
  box-shadow: 0 16px 36px rgba(0,0,0,0.6), 0 0 22px var(--tile-color, rgba(99,180,255,0.2));
}
.upgr-tile:active { transform: translateY(0) scale(0.95); }

.upgr-tile-max {
  border-color: rgba(52,211,153,0.6) !important;
  background: linear-gradient(155deg, rgba(52,211,153,0.1), rgba(10,60,40,0.14)) !important;
  --tile-color: #34d399;
}

/* Icon box */
.upgr-tile-icon {
  width: 52px; height: 52px; border-radius: 14px;
  background: rgba(0,0,0,0.32);
  border: 1px solid rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  transition: box-shadow 0.2s;
  box-shadow: inset 0 0 12px rgba(0,0,0,0.4);
}
.upgr-tile:hover .upgr-tile-icon {
  box-shadow: 0 0 16px var(--tile-color, rgba(99,180,255,0.4)), inset 0 0 12px rgba(0,0,0,0.4);
}
.upgr-tile-icon svg { width: 32px; height: 32px; }

.upgr-tile-label {
  font-family: 'Orbitron', monospace; font-size: 0.5rem; font-weight: 800;
  letter-spacing: 0.15em; color: rgba(255,255,255,0.75); text-align: center;
}
.upgr-tile-lvl    { font-family: 'Boogaloo', cursive; font-size: 1.25rem; color: #fff; line-height: 1; }
.upgr-tile-max-lv { font-size: 0.7rem; color: rgba(255,255,255,0.4); font-family: 'Nunito', sans-serif; }

.upgr-tile-bar {
  width: 90%; height: 5px; background: rgba(255,255,255,0.08);
  border-radius: 4px; overflow: hidden;
}
.upgr-tile-fill {
  height: 100%; width: var(--target-w, 0%); border-radius: 4px;
  background: linear-gradient(90deg, var(--tile-color, #63caff), rgba(255,255,255,0.6));
  box-shadow: 0 0 6px var(--tile-color, rgba(99,180,255,0.6));
  animation: fillUp 0.65s ease both; animation-delay: 0.3s;
  transition: width 0.35s ease;
}
.upgr-tile-max .upgr-tile-fill { background: linear-gradient(90deg, #34d399, #a7f3d0); }

.upgr-tile-cost {
  display: flex; align-items: center; gap: 4px;
  font-family: 'Orbitron', monospace; font-size: 0.6rem; font-weight: 700;
  padding: 4px 9px; border-radius: 10px;
  background: rgba(0,0,0,0.38); min-height: 22px;
  justify-content: center; white-space: nowrap;
}
.upgr-tile-cost.can-afford { color: #ffd700; }
.upgr-tile-cost.no-coins   { color: rgba(255,255,255,0.3); }
.upgr-tile-cost.maxed      { background: transparent; }

.upgr-max-badge {
  font-family: 'Orbitron', monospace; font-size: 0.58rem;
  font-weight: 900; color: #34d399; letter-spacing: 0.12em;
  text-shadow: 0 0 8px rgba(52,211,153,0.65);
}

.upgr-tile-shake  { animation: upgr-shake  0.4s ease; border-color: #ef4444 !important; }
.upgr-tile-bounce { animation: upgr-bounce 0.38s ease; }

/* ── Vehicle stage ───────────────────────────────────── */
.upgr-stage {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 16px 20px; position: relative; overflow: hidden;
}
/* Ground glow */
.upgr-stage::before {
  content: ''; position: absolute;
  bottom: 22%; left: 50%; transform: translateX(-50%);
  width: 300px; height: 55px;
  background: radial-gradient(ellipse, rgba(99,180,255,0.28) 0%, transparent 70%);
  border-radius: 50%; pointer-events: none;
  animation: zoomPulse 3.5s ease-in-out infinite;
}
/* Grid floor */
.upgr-stage::after {
  content: ''; position: absolute;
  bottom: 0; left: 0; right: 0; height: 38%;
  background:
    linear-gradient(to bottom, transparent 0%, rgba(5,20,60,0.85) 100%),
    repeating-linear-gradient(90deg, rgba(99,180,255,0.04) 0px, rgba(99,180,255,0.04) 1px, transparent 1px, transparent 62px),
    repeating-linear-gradient(0deg,  rgba(99,180,255,0.04) 0px, rgba(99,180,255,0.04) 1px, transparent 1px, transparent 42px);
  pointer-events: none;
}

.upgr-svg-wrap {
  max-width: 360px; width: 90%;
  animation: upgr-float 3.5s ease-in-out infinite, upgr-glow 3.5s ease-in-out infinite;
  z-index: 2; position: relative;
}
.upgr-svg-wrap svg { max-width: 100%; height: auto; }

.upgr-vname-bar {
  display: flex; align-items: center; gap: 10px;
  margin-top: 22px;
  background: rgba(0,0,0,0.52);
  border: 1px solid rgba(99,180,255,0.22);
  padding: 10px 26px; border-radius: 36px;
  backdrop-filter: blur(14px);
  box-shadow: 0 4px 24px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.04);
  z-index: 2; position: relative;
}
.upgr-check-icon  { font-size: 1.1rem; color: #34d399; font-weight: 900; transition: opacity 0.25s; text-shadow: 0 0 10px rgba(52,211,153,0.7); }
.upgr-vname {
  font-family: 'Orbitron', monospace; font-size: 0.95rem; font-weight: 900;
  letter-spacing: 0.18em; color: #fff;
  text-shadow: 0 0 16px rgba(255,255,255,0.3);
}

/* ── Select button ───────────────────────────────────── */
.upgr-select-btn {
  margin: 0 18px 20px;
  padding: 17px 24px; border-radius: 18px;
  font-family: 'Orbitron', monospace; font-size: 0.95rem; font-weight: 900; letter-spacing: 0.2em;
  border: none; cursor: pointer;
  transition: all 0.2s cubic-bezier(.34,1.56,.64,1);
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff;
  box-shadow: 0 8px 28px rgba(34,197,94,0.55), inset 0 1px 0 rgba(255,255,255,0.2), 0 0 0 1px rgba(34,197,94,0.3);
  flex-shrink: 0; position: relative; overflow: hidden; z-index: 2;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.upgr-select-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: shimmer 2.5s linear infinite;
}
.upgr-select-btn:hover  { transform: translateY(-3px) scale(1.02); box-shadow: 0 14px 36px rgba(34,197,94,0.65), inset 0 1px 0 rgba(255,255,255,0.2); }
.upgr-select-btn:active { transform: scale(0.97); }

.upgr-selected-active {
  background: rgba(52,211,153,0.12) !important;
  color: #34d399 !important;
  border: 1.5px solid rgba(52,211,153,0.45) !important;
  box-shadow: 0 0 20px rgba(52,211,153,0.22) !important;
  cursor: default !important; letter-spacing: 0.13em !important;
}
.upgr-selected-active::before { display: none; }

/* ── Burst sparkles ─────────────────────────────────── */
.burst-particle {
  position: fixed; pointer-events: none; z-index: 9999;
  border-radius: 50%;
  animation: sparkle 0.8s ease-out both;
}

/* ── Scrollbar ───────────────────────────────────────── */
::-webkit-scrollbar       { width: 4px; }
::-webkit-scrollbar-thumb { background: rgba(99,180,255,0.25); border-radius: 4px; }
</style>
</head>
<body>
<div id="game-root">
  <canvas id="game-canvas"></canvas>

  <div id="screen-main-menu" class="screen active">
    <div class="panel">
      <h1 class="title">Hill Climb Canvas</h1>
      <button id="btn-play">&#x25B6; Play</button>
      <button id="btn-garage">&#x1F3CE;&#xFE0F; Garage</button>
      <button id="btn-levels">&#x1F30D; Levels</button>
      <button id="btn-settings">&#x2699;&#xFE0F; Settings</button>
      <button id="btn-leaderboard">&#x1F3C6; Leaderboard</button>
    </div>
  </div>

  <div id="screen-level-select" class="screen">
    <div class="panel panel-levels">
      <div class="levels-header">
        <h2>Select Level</h2>
        <p class="levels-subtitle">Choose your challenge</p>
      </div>
      <div id="level-grid"></div>
      <button class="btn-back" data-target="screen-main-menu">Back</button>
    </div>
  </div>

  <div id="screen-garage" class="screen">
    <div class="garage-wrap">
      <div class="garage-head">
        <h1 class="garage-title">GARAGE</h1>
        <div class="garage-coins" id="garage-coins">&#x26A1; 0 coins</div>
      </div>
      <div class="garage-tabs">
        <button class="garage-tab active" data-filter="all">All</button>
        <button class="garage-tab" data-filter="car">Cars</button>
        <button class="garage-tab" data-filter="bike">Bikes</button>
      </div>
      <div class="garage-grid" id="garage-grid"></div>
      <div class="garage-footer">
        <button id="btn-watch-ad-coins">&#x1F3A5; Watch Ad for 50 Coins</button>
        <button class="btn-back" data-target="screen-main-menu">&#x2190; Back</button>
      </div>
    </div>
  </div>

  <div id="screen-pause" class="screen">
    <div class="panel">
      <h2>Paused</h2>
      <button id="btn-resume">Resume</button>
      <button id="btn-restart">Restart</button>
      <button id="btn-quit">Quit</button>
    </div>
  </div>

  <div id="screen-ad" class="screen">
    <div class="panel">
      <h2>Ad Break</h2>
      <p style="font-size:0.8rem;opacity:0.8;margin-bottom:8px">Thanks for playing! Your support keeps this game free.</p>
      <div id="ad-slot-interstitial" style="width:100%;min-height:120px;margin:8px 0;background:rgba(0,0,0,0.35);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;opacity:0.7;">Interstitial ad goes here</div>
      <button id="btn-ad-continue">Continue</button>
    </div>
  </div>

  <div id="screen-gameover" class="screen">
    <div class="panel">
      <h2 id="gameover-title">Game Over</h2>
      <p id="gameover-summary"></p>
      <p id="gameover-stars"></p>
      <button id="btn-gameover-restart">Restart</button>
      <button id="btn-gameover-ad-coins" style="background:linear-gradient(135deg,#667eea,#764ba2)">Watch Ad for 50 Coins</button>
      <button id="btn-gameover-levels">Level Select</button>
      <button id="btn-gameover-main">Main Menu</button>
    </div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div id="hud-top">
      <div id="hud-coins">
        <div class="icon-coin"></div>
        <span id="hud-coin-count">0</span>
      </div>
      <div id="hud-distance">
        <span id="hud-distance-current">0m</span>
        <span id="hud-distance-best">Best: 0m</span>
      </div>
      <button id="btn-pause" class="hud-button">II</button>
    </div>
    <div id="hud-bottom">
      <button id="btn-brake" class="pedal pedal-left">Brake</button>
      <div id="hud-gauges">
        <canvas id="gauge-rpm" width="90" height="90"></canvas>
        <canvas id="gauge-fuel" width="90" height="90"></canvas>
        <canvas id="gauge-boost" width="90" height="90"></canvas>
      </div>
      <button id="btn-gas" class="pedal pedal-right">Gas</button>
    </div>
  </div>
</div>

<script>
// ===== storage.js =====
// storage.js — LocalStorage wrapper for game persistence
// Enhanced version — 100% original code, free to publish (no copyright claims)

class Storage {
  constructor(ls) {
    this.ls  = ls;
    this.key = "hillclimb_canvas_save_v1";

    // Load saved state, fall back to fresh defaults, then persist
    this.state = this._load() || this._createDefaultState();
    this._migrate();   // future-proof: fill in any missing fields
    this._save();
  }

  /* ─── Default state factory ──────────────────────── */
  _createDefaultState() {
    return {
      coins: 0,
      unlockedVehicles: {
        rusty_hatchback: true,
        monster_truck:   true,
        dirt_bike:       true,
      },
      bestDistances:      {},
      levelStars:         {},
      bestDistanceOverall:0,
      lastSelectedVehicle:"rusty_hatchback",
      lastSelectedLevel:  1,
      vehicleDiscounts:   {},
      vehicleUpgrades:    {},
    };
  }

  /* ─── Migration: fill fields added after initial release ─ */
  _migrate() {
    if (!this.state.vehicleDiscounts) this.state.vehicleDiscounts = {};
    if (!this.state.vehicleUpgrades)  this.state.vehicleUpgrades  = {};
    if (this.state.bestDistanceOverall === undefined) this.state.bestDistanceOverall = 0;
  }

  /* ─── Load / save ────────────────────────────────── */
  _load() {
    try {
      const raw = this.ls.getItem(this.key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      // Sanity check: must be a plain object
      if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) return null;
      return parsed;
    } catch {
      return null;
    }
  }

  _save() {
    try {
      this.ls.setItem(this.key, JSON.stringify(this.state));
    } catch {
      // Silently ignore quota errors — progress is kept in memory for this session
    }
  }

  /* ─── Full state accessor ────────────────────────── */
  getAll() {
    return this.state;
  }

  /* ─── Coins ──────────────────────────────────────── */
  getCoins() {
    return this.state.coins || 0;
  }

  setCoins(value) {
    this.state.coins = Math.max(0, Math.floor(value));
    this._save();
  }

  addCoins(amount) {
    this.setCoins(this.getCoins() + amount);
  }

  /* ─── Vehicles ───────────────────────────────────── */
  isVehicleUnlocked(id) {
    return !!this.state.unlockedVehicles[id];
  }

  unlockVehicle(id) {
    this.state.unlockedVehicles[id] = true;
    this._save();
  }

  /* ─── Best distances ─────────────────────────────── */
  getBestDistance(levelId) {
    return this.state.bestDistances[levelId] || 0;
  }

  setBestDistance(levelId, distance) {
    const prev = this.getBestDistance(levelId);
    if (distance > prev) {
      this.state.bestDistances[levelId]    = distance;
      this.state.bestDistanceOverall       = Math.max(this.state.bestDistanceOverall || 0, distance);
      this._save();
    }
  }

  getBestDistanceOverall() {
    return this.state.bestDistanceOverall || 0;
  }

  /* ─── Level stars ────────────────────────────────── */
  getLevelStars(levelId) {
    return this.state.levelStars[levelId] || 0;
  }

  setLevelStars(levelId, stars) {
    const current = this.getLevelStars(levelId);
    if (stars > current) {
      this.state.levelStars[levelId] = Math.min(3, stars);
      this._save();
    }
  }

  getTotalStars() {
    return Object.values(this.state.levelStars || {}).reduce((acc, s) => acc + (s || 0), 0);
  }

  /* ─── Selection memory ───────────────────────────── */
  setLastSelected(levelId, vehicleId) {
    this.state.lastSelectedLevel   = levelId;
    this.state.lastSelectedVehicle = vehicleId;
    this._save();
  }

  /* ─── Vehicle discounts (ad rewards) ────────────── */
  getVehicleDiscount(id) {
    return (this.state.vehicleDiscounts && this.state.vehicleDiscounts[id]) || 0;
  }

  addVehicleDiscount(id, amount) {
    if (!this.state.vehicleDiscounts) this.state.vehicleDiscounts = {};
    this.state.vehicleDiscounts[id] = (this.state.vehicleDiscounts[id] || 0) + amount;
    this._save();
  }

  /* ─── Vehicle upgrades ───────────────────────────── */
  getUpgradeLevel(vehicleId, type) {
    const vu = this.state.vehicleUpgrades || {};
    return (vu[vehicleId] && vu[vehicleId][type]) || 0;
  }

  /**
   * Increment one upgrade level and deduct the coin cost.
   * Returns true if successful, false if insufficient coins.
   */
  upgradeVehicle(vehicleId, type, cost) {
    if (this.getCoins() < cost) return false;

    if (!this.state.vehicleUpgrades)            this.state.vehicleUpgrades = {};
    if (!this.state.vehicleUpgrades[vehicleId]) this.state.vehicleUpgrades[vehicleId] = {};

    this.state.vehicleUpgrades[vehicleId][type] =
      (this.state.vehicleUpgrades[vehicleId][type] || 0) + 1;

    this.setCoins(this.getCoins() - cost); // setCoins calls _save()
    return true;
  }

  /** Return a summary of all upgrades for a given vehicle. */
  getVehicleUpgrades(vehicleId) {
    return (this.state.vehicleUpgrades && this.state.vehicleUpgrades[vehicleId]) || {};
  }

  /* ─── Reset (for debug / fresh-start button) ─────── */
  reset() {
    this.state = this._createDefaultState();
    this._save();
  }
}
// ===== audio.js =====
// audio.js - simple Web Audio API sounds

class AudioManager {
  constructor() {
    this.ctx = null;
    this.engineOsc = null;
    this.engineOsc2 = null;
    this.engineGain = null;
    this.engineGain2 = null;
    this.engineFilter = null;
    this.engineLFO = null;
    this.engineLFOGain = null;
    this.suspended = false;
    // Music system
    this._musicConfig = null;
    this._musicBeat = 0;
    this._musicNextTime = 0;
    this._musicIntervalId = null;
    this._musicMasterGain = null;
    this._padOscs = null;
    this._padGains = null;

    document.addEventListener("pointerdown", () => this._lazyInit(), {
      once: true,
    });
  }

  _lazyInit() {
    if (this.ctx) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    this.ctx = new AudioCtx();
  }

  startEngine() {
    if (!this.ctx) this._lazyInit();
    if (!this.ctx) return;
    if (this.engineOsc) return;

    // --- Base oscillator: sawtooth for fundamental engine tone ---
    this.engineOsc = this.ctx.createOscillator();
    this.engineOsc.type = "sawtooth";
    this.engineOsc.frequency.value = 55;

    // --- Second oscillator: square wave one octave up for harmonic richness ---
    this.engineOsc2 = this.ctx.createOscillator();
    this.engineOsc2.type = "square";
    this.engineOsc2.frequency.value = 110;

    // --- Low-pass filter to smooth harsh edges and add warmth ---
    this.engineFilter = this.ctx.createBiquadFilter();
    this.engineFilter.type = "lowpass";
    this.engineFilter.frequency.value = 400;
    this.engineFilter.Q.value = 1.5;

    // --- LFO for engine rumble/vibration ---
    this.engineLFO = this.ctx.createOscillator();
    this.engineLFOGain = this.ctx.createGain();
    this.engineLFO.type = "sine";
    this.engineLFO.frequency.value = 8; // 8 Hz rumble
    this.engineLFOGain.gain.value = 6;   // ±6 Hz wobble on base freq
    this.engineLFO.connect(this.engineLFOGain);
    this.engineLFOGain.connect(this.engineOsc.frequency);

    // --- Gain nodes per oscillator ---
    this.engineGain = this.ctx.createGain();
    this.engineGain.gain.value = 0.0;
    this.engineGain2 = this.ctx.createGain();
    this.engineGain2.gain.value = 0.0;

    // --- Routing ---
    this.engineOsc.connect(this.engineFilter);
    this.engineFilter.connect(this.engineGain);
    this.engineGain.connect(this.ctx.destination);

    this.engineOsc2.connect(this.engineGain2);
    this.engineGain2.connect(this.ctx.destination);

    this.engineOsc.start();
    this.engineOsc2.start();
    this.engineLFO.start();
  }

  updateEngine(rpm, gasPressed) {
    if (!this.engineOsc || !this.engineGain || !this.ctx) return;
    const norm = Math.max(0, Math.min(1, rpm / 600));

    // Base freq: 55 Hz idle → 160 Hz at full throttle (rich, low car sound)
    const baseFreq = 55 + norm * 105;
    const harmFreq = baseFreq * 2;

    // Filter opens up as RPM rises, giving that throat-opening sound
    const filterFreq = 300 + norm * 1200;

    // Volume reacts to gas input
    const targetGain  = gasPressed ? 0.28 + norm * 0.14 : 0.10 + norm * 0.06;
    const targetGain2 = gasPressed ? 0.10 + norm * 0.08 : 0.03 + norm * 0.03;

    // LFO rumble intensifies at low RPM, softens at high RPM
    if (this.engineLFO) this.engineLFO.frequency.setTargetAtTime(6 + norm * 10, this.ctx.currentTime, 0.1);
    if (this.engineLFOGain) this.engineLFOGain.gain.setTargetAtTime(8 - norm * 6, this.ctx.currentTime, 0.1);

    const t = this.ctx.currentTime;
    this.engineOsc.frequency.setTargetAtTime(baseFreq, t, 0.04);
    this.engineOsc2.frequency.setTargetAtTime(harmFreq, t, 0.04);
    if (this.engineFilter) this.engineFilter.frequency.setTargetAtTime(filterFreq, t, 0.06);
    this.engineGain.gain.setTargetAtTime(targetGain, t, 0.07);
    this.engineGain2.gain.setTargetAtTime(targetGain2, t, 0.07);
  }

  stopEngine() {
    if (!this.engineOsc) return;
    [this.engineOsc, this.engineOsc2, this.engineLFO].forEach(osc => {
      if (!osc) return;
      try { osc.stop(); } catch { /* ignore */ }
      osc.disconnect();
    });
    [this.engineGain, this.engineGain2, this.engineFilter, this.engineLFOGain].forEach(node => {
      if (!node) return;
      node.disconnect();
    });
    this.engineOsc = null;
    this.engineOsc2 = null;
    this.engineLFO = null;
    this.engineLFOGain = null;
    this.engineFilter = null;
    this.engineGain = null;
    this.engineGain2 = null;
  }

  // ─────────────────────────────────────────────────────────────────
  // BACKGROUND MUSIC  (look-ahead Web Audio scheduler)
  // ─────────────────────────────────────────────────────────────────

  startMusic(theme) {
    this.stopMusic();
    if (!this.ctx) this._lazyInit();
    if (!this.ctx || this.suspended) return;

    this._musicConfig = this._getMusicConfig(theme);
    this._musicBeat = 0;
    this._musicNextTime = this.ctx.currentTime + 0.4;

    this._musicMasterGain = this.ctx.createGain();
    this._musicMasterGain.gain.setValueAtTime(0, this.ctx.currentTime);
    this._musicMasterGain.gain.linearRampToValueAtTime(0.15, this.ctx.currentTime + 2.5);
    this._musicMasterGain.connect(this.ctx.destination);

    this._startMusicPad();
    // Fire every 50 ms, schedule notes 200 ms ahead (classic look-ahead scheduler)
    this._musicIntervalId = setInterval(() => this._musicTick(), 50);
  }

  stopMusic() {
    if (this._musicIntervalId) {
      clearInterval(this._musicIntervalId);
      this._musicIntervalId = null;
    }
    if (this._musicMasterGain && this.ctx) {
      try {
        this._musicMasterGain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.4);
        const ref = this._musicMasterGain;
        setTimeout(() => { try { ref.disconnect(); } catch(e) {} }, 1200);
      } catch(e) {
        try { this._musicMasterGain.disconnect(); } catch(e2) {}
      }
      this._musicMasterGain = null;
    }
    if (this._padOscs) {
      this._padOscs.forEach(o => { try { o.stop(); o.disconnect(); } catch(e) {} });
      this._padOscs = null;
    }
    if (this._padGains) {
      this._padGains.forEach(g => { try { g.disconnect(); } catch(e) {} });
      this._padGains = null;
    }
    this._musicConfig = null;
  }

  _startMusicPad() {
    if (!this.ctx || !this._musicMasterGain) return;
    const cfg = this._musicConfig;
    this._padOscs = [];
    this._padGains = [];
    cfg.padNotes.forEach(freq => {
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, this.ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.20 / cfg.padNotes.length, this.ctx.currentTime + 3.0);
      osc.connect(gain);
      gain.connect(this._musicMasterGain);
      osc.start();
      this._padOscs.push(osc);
      this._padGains.push(gain);
    });
  }

  _musicTick() {
    if (!this.ctx || !this._musicConfig || !this._musicMasterGain) return;
    if (this.ctx.state === 'suspended') return;
    const lookAhead = 0.2;
    while (this._musicNextTime < this.ctx.currentTime + lookAhead) {
      this._scheduleMusicNote(this._musicNextTime);
      this._musicBeat = (this._musicBeat + 1) % this._musicConfig.notes.length;
      this._musicNextTime += this._musicConfig.tempo;
    }
  }

  _scheduleMusicNote(time) {
    const cfg = this._musicConfig;
    const freq = cfg.notes[this._musicBeat];
    if (!freq || !this._musicMasterGain) return; // 0 = rest
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = cfg.type;
    osc.frequency.value = freq;
    const vel = cfg.velocities[this._musicBeat] || 0.15;
    gain.gain.setValueAtTime(0.001, time);
    gain.gain.linearRampToValueAtTime(vel, time + 0.025);
    gain.gain.exponentialRampToValueAtTime(0.001, time + cfg.tempo * 0.78);
    osc.connect(gain);
    gain.connect(this._musicMasterGain);
    osc.start(time);
    osc.stop(time + cfg.tempo + 0.05);
  }

  _getMusicConfig(theme) {
    const easy   = ['pastelFields','pastelHills','beach','farm','cliffs','meadow','plains','orchard','lake','forest'];
    const normal = ['mountain','desert','jungle','snow','canyon','arctic','rainforest','swamp','storm','volcano'];
    const hard   = ['asteroid','cave','underwater','space','lava'];

    if (easy.includes(theme)) {
      return {
        // C major pentatonic ascending/descending — bright & cheerful
        notes:      [261.63, 329.63, 392.00, 523.25, 392.00, 329.63, 261.63, 0,
                     293.66, 369.99, 440.00, 587.33, 440.00, 369.99, 293.66, 0],
        velocities: [0.18, 0.14, 0.16, 0.20, 0.14, 0.12, 0.16, 0,
                     0.16, 0.12, 0.18, 0.20, 0.14, 0.12, 0.14, 0],
        tempo: 0.28, type: 'sine',
        padNotes: [65.41, 98.00, 130.81],   // C2 G2 C3
      };
    }
    if (normal.includes(theme)) {
      return {
        // D Dorian — adventurous, slightly mysterious
        notes:      [293.66, 0, 369.99, 440.00, 0, 493.88, 440.00, 369.99,
                     329.63, 0, 293.66, 0,  369.99, 440.00, 493.88, 0],
        velocities: [0.20, 0, 0.15, 0.18, 0, 0.16, 0.15, 0.14,
                     0.18, 0, 0.16, 0,  0.14, 0.18, 0.20, 0],
        tempo: 0.34, type: 'triangle',
        padNotes: [73.42, 110.00, 146.83],  // D2 A2 D3
      };
    }
    if (hard.includes(theme)) {
      return {
        // A minor pentatonic — sparse & tense
        notes:      [220.00, 0, 0, 261.63, 0, 293.66, 0, 329.63,
                     0, 0, 220.00, 0,  246.94, 0, 0, 207.65],
        velocities: [0.22, 0, 0, 0.16, 0, 0.18, 0, 0.16,
                     0, 0, 0.20, 0,  0.15, 0, 0, 0.18],
        tempo: 0.42, type: 'triangle',
        padNotes: [55.00, 82.41, 110.00],   // A1 E2 A2
      };
    }
    // Advanced — dark & dramatic (F# diminished feel)
    return {
      notes:      [185.00, 0, 0, 220.00, 0, 207.65, 0, 0,
                   185.00, 0, 174.61, 0,  0, 185.00, 0, 0],
      velocities: [0.22, 0, 0, 0.18, 0, 0.16, 0, 0,
                   0.20, 0, 0.18, 0,  0, 0.14, 0, 0],
      tempo: 0.52, type: 'sawtooth',
      padNotes: [46.25, 69.30, 92.50],      // F#1 C#2 F#2
    };
  }

  _oneShot({ freq = 440, duration = 0.15, type = "sine", volume = 0.4 }) {
    if (!this.ctx) this._lazyInit();
    if (!this.ctx) return;
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    const t = this.ctx.currentTime;
    gain.gain.setValueAtTime(volume, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
    osc.start(t);
    osc.stop(t + duration + 0.05);
  }

  playCoin() {
    this._oneShot({ freq: 1200, duration: 0.18, type: "square", volume: 0.3 });
  }

  playFuel() {
    this._oneShot({ freq: 500, duration: 0.25, type: "sawtooth", volume: 0.35 });
  }

  playBoost() {
    this._oneShot({ freq: 900, duration: 0.3, type: "triangle", volume: 0.35 });
  }

  playCrash() {
    this._noiseBurst(0.25, 0.6);
  }

  playWin() {
    if (!this.ctx) this._lazyInit();
    if (!this.ctx) return;
    const notes = [660, 880, 990];
    notes.forEach((freq, i) => {
      setTimeout(() => {
        this._oneShot({ freq, duration: 0.18, type: "square", volume: 0.28 });
      }, i * 140);
    });
  }

  _noiseBurst(duration, volume) {
    if (!this.ctx) this._lazyInit();
    if (!this.ctx) return;
    const bufferSize = this.ctx.sampleRate * duration;
    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
      data[i] = (Math.random() * 2 - 1) * 0.6;
    }
    const source = this.ctx.createBufferSource();
    source.buffer = buffer;
    const gain = this.ctx.createGain();
    gain.gain.value = volume;
    source.connect(gain);
    gain.connect(this.ctx.destination);
    const t = this.ctx.currentTime;
    gain.gain.setValueAtTime(volume, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
    source.start(t);
    source.stop(t + duration + 0.05);
  }

  suspend() {
    if (!this.ctx) return;
    if (this.ctx.state === "running") {
      this.ctx.suspend();
      this.suspended = true;
    }
  }

  resume() {
    if (!this.ctx) this._lazyInit();
    if (!this.ctx) return;
    if (this.ctx.state === "suspended") {
      this.ctx.resume();
      this.suspended = false;
    }
  }
}


// ===== particles.js =====
// particles.js - simple particle systems (exhaust, sparkles, dust)

class ParticleSystem {
  constructor() {
    this.particles = [];
  }

  spawnExhaust(x, y) {
    for (let i = 0; i < 3; i++) {
      this.particles.push({
        type: "smoke",
        x: x + (Math.random() - 0.5) * 8,
        y: y + (Math.random() - 0.5) * 4,
        vx: -20 - Math.random() * 10,
        vy: -10 - Math.random() * 10,
        life: 0.6 + Math.random() * 0.4,
        age: 0,
      });
    }
  }

  spawnSparkle(x, y) {
    for (let i = 0; i < 6; i++) {
      const a = Math.random() * Math.PI * 2;
      const s = 40 + Math.random() * 40;
      this.particles.push({
        type: "spark",
        x,
        y,
        vx: Math.cos(a) * s,
        vy: Math.sin(a) * s,
        life: 0.4 + Math.random() * 0.3,
        age: 0,
      });
    }
  }

  update(dt) {
    const alive = [];
    for (const p of this.particles) {
      p.age += dt;
      if (p.age > p.life) continue;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      if (p.type === "smoke") {
        p.vx *= 0.96;
        p.vy *= 0.96;
      } else {
        p.vy += 60 * dt;
      }
      alive.push(p);
    }
    this.particles = alive;
  }

  draw(ctx, cameraX, cameraY) {
    for (const p of this.particles) {
      const t = p.age / p.life;
      const alpha = 1 - t;
      const x = p.x - cameraX;
      const y = p.y - cameraY;
      if (p.type === "smoke") {
        ctx.fillStyle = `rgba(220,220,220,${alpha * 0.5})`;
        ctx.beginPath();
        ctx.arc(x, y, 8 + t * 8, 0, Math.PI * 2);
        ctx.fill();
      } else if (p.type === "spark") {
        ctx.fillStyle = `rgba(255,230,120,${alpha})`;
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }
}


// ===== vehicles.js =====

const vehicles = [
  {
    id:"rusty_hatchback", name:"Rusty Hatchback", type:"car",
    stats:{speed:5,acceleration:5,fuelEfficiency:5,grip:5,traction:5,torque:0.030,fuelCapacity:100},
    cost:0, defaultUnlocked:true,
    bodyWidth:110, bodyHeight:35, wheelBase:75, wheelRadius:16, wheelYOffset:18, suspensionLength:26,
    physics:{density:0.004},
    palette:{body:"#c8914a",accent:"#7a3b2e"}
  },
  {
    id:"monster_truck", name:"Monster Truck", type:"car",
    stats:{speed:3,acceleration:4,fuelEfficiency:4,grip:9,traction:9,torque:0.050,fuelCapacity:80},
    cost:500, defaultUnlocked:true,
    bodyWidth:104, bodyHeight:30, wheelBase:96, wheelRadius:26, wheelYOffset:30, suspensionLength:38,
    physics:{density:0.007},
    palette:{body:"#2e6fd4",accent:"#0a1a3a"}
  },
  {
    id:"rally_racer", name:"Rally Racer", type:"car",
    stats:{speed:8,acceleration:7,fuelEfficiency:4,grip:4,traction:4,torque:0.042,fuelCapacity:90},
    cost:900, defaultUnlocked:false,
    bodyWidth:115, bodyHeight:30, wheelBase:82, wheelRadius:17, wheelYOffset:16, suspensionLength:28,
    physics:{density:0.0038},
    palette:{body:"#e63030",accent:"#ff9900"}
  },
  {
    id:"muscle_car", name:"Muscle Car", type:"car",
    stats:{speed:9,acceleration:7,fuelEfficiency:3,grip:5,traction:5,torque:0.048,fuelCapacity:85},
    cost:1100, defaultUnlocked:false,
    bodyWidth:118, bodyHeight:32, wheelBase:88, wheelRadius:18, wheelYOffset:18, suspensionLength:27,
    physics:{density:0.0045},
    palette:{body:"#f79820",accent:"#a04000"}
  },
  {
    id:"jeep_4x4", name:"Jeep 4x4", type:"car",
    stats:{speed:5,acceleration:5,fuelEfficiency:5,grip:8,traction:8,torque:0.040,fuelCapacity:110},
    cost:1000, defaultUnlocked:false,
    bodyWidth:112, bodyHeight:38, wheelBase:80, wheelRadius:22, wheelYOffset:22, suspensionLength:34,
    physics:{density:0.005},
    palette:{body:"#2a8c6e",accent:"#0d3d2a"}
  },
  {
    id:"sports_coupe", name:"Sports Coupe", type:"car",
    stats:{speed:10,acceleration:8,fuelEfficiency:3,grip:5,traction:4,torque:0.046,fuelCapacity:80},
    cost:1300, defaultUnlocked:false,
    bodyWidth:120, bodyHeight:28, wheelBase:88, wheelRadius:16, wheelYOffset:14, suspensionLength:24,
    physics:{density:0.0035},
    palette:{body:"#00aaee",accent:"#003388"}
  },
  {
    id:"dune_buggy", name:"Dune Buggy", type:"car",
    stats:{speed:7,acceleration:9,fuelEfficiency:6,grip:7,traction:7,torque:0.044,fuelCapacity:90},
    cost:1200, defaultUnlocked:false,
    bodyWidth:100, bodyHeight:28, wheelBase:78, wheelRadius:22, wheelYOffset:20, suspensionLength:32,
    physics:{density:0.004},
    palette:{body:"#e8c030",accent:"#a06010"}
  },
  {
    id:"tank", name:"Tank", type:"car",
    stats:{speed:3,acceleration:3,fuelEfficiency:2,grip:10,traction:10,torque:0.065,fuelCapacity:70},
    cost:2000, defaultUnlocked:false,
    bodyWidth:130, bodyHeight:38, wheelBase:90, wheelRadius:16, wheelYOffset:20, suspensionLength:24,
    physics:{density:0.010},
    palette:{body:"#5a7040",accent:"#283018"}
  },
  {
    id:"pickup_truck", name:"Pickup Truck", type:"car",
    stats:{speed:6,acceleration:6,fuelEfficiency:5,grip:7,traction:7,torque:0.038,fuelCapacity:110},
    cost:1000, defaultUnlocked:false,
    bodyWidth:116, bodyHeight:36, wheelBase:84, wheelRadius:18, wheelYOffset:20, suspensionLength:30,
    physics:{density:0.005},
    palette:{body:"#cc3344",accent:"#6a0010"}
  },
  {
    id:"electric_car", name:"Electric Car", type:"car",
    stats:{speed:8,acceleration:8,fuelEfficiency:10,grip:6,traction:6,torque:0.044,fuelCapacity:120},
    cost:1500, defaultUnlocked:false,
    bodyWidth:112, bodyHeight:30, wheelBase:82, wheelRadius:16, wheelYOffset:15, suspensionLength:25,
    physics:{density:0.0038},
    palette:{body:"#30c8cc",accent:"#1050aa"}
  },
  {
    id:"dirt_bike", name:"Dirt Bike", type:"bike",
    stats:{speed:7,acceleration:8,fuelEfficiency:7,grip:7,traction:6,torque:0.032,fuelCapacity:70},
    cost:0, defaultUnlocked:true,
    bodyWidth:70, bodyHeight:28, wheelBase:70, wheelRadius:18, wheelYOffset:18, suspensionLength:28,
    physics:{density:0.003},
    palette:{body:"#e87030",accent:"#c02010"}
  },
  {
    id:"chopper", name:"Chopper", type:"bike",
    stats:{speed:5,acceleration:4,fuelEfficiency:5,grip:6,traction:6,torque:0.028,fuelCapacity:90},
    cost:700, defaultUnlocked:false,
    bodyWidth:90, bodyHeight:26, wheelBase:90, wheelRadius:18, wheelYOffset:18, suspensionLength:24,
    physics:{density:0.0038},
    palette:{body:"#c01030",accent:"#1a0420"}
  },
  {
    id:"sport_bike", name:"Sport Bike", type:"bike",
    stats:{speed:10,acceleration:10,fuelEfficiency:5,grip:7,traction:6,torque:0.038,fuelCapacity:75},
    cost:1600, defaultUnlocked:false,
    bodyWidth:72, bodyHeight:26, wheelBase:72, wheelRadius:17, wheelYOffset:16, suspensionLength:26,
    physics:{density:0.003},
    palette:{body:"#1a30c0",accent:"#00cccc"}
  },
  {
    id:"scrambler", name:"Scrambler", type:"bike",
    stats:{speed:7,acceleration:7,fuelEfficiency:7,grip:7,traction:7,torque:0.030,fuelCapacity:80},
    cost:900, defaultUnlocked:false,
    bodyWidth:74, bodyHeight:28, wheelBase:72, wheelRadius:18, wheelYOffset:18, suspensionLength:28,
    physics:{density:0.003},
    palette:{body:"#28a060",accent:"#a0d030"}
  },
  {
    id:"mini_moto", name:"Mini Moto", type:"bike",
    stats:{speed:6,acceleration:8,fuelEfficiency:8,grip:6,traction:6,torque:0.026,fuelCapacity:60},
    cost:600, defaultUnlocked:false,
    bodyWidth:60, bodyHeight:22, wheelBase:58, wheelRadius:14, wheelYOffset:14, suspensionLength:20,
    physics:{density:0.0028},
    palette:{body:"#7050d0",accent:"#c060ff"}
  },
  {
    id:"enduro_bike", name:"Enduro Bike", type:"bike",
    stats:{speed:7,acceleration:7,fuelEfficiency:9,grip:7,traction:7,torque:0.030,fuelCapacity:100},
    cost:1100, defaultUnlocked:false,
    bodyWidth:76, bodyHeight:28, wheelBase:74, wheelRadius:20, wheelYOffset:20, suspensionLength:32,
    physics:{density:0.003},
    palette:{body:"#e060a0",accent:"#ff9060"}
  },
  {
    id:"cafe_racer", name:"Cafe Racer", type:"bike",
    stats:{speed:8,acceleration:7,fuelEfficiency:6,grip:8,traction:7,torque:0.032,fuelCapacity:75},
    cost:1000, defaultUnlocked:false,
    bodyWidth:74, bodyHeight:26, wheelBase:72, wheelRadius:17, wheelYOffset:16, suspensionLength:25,
    physics:{density:0.0032},
    palette:{body:"#d4aa00",accent:"#3a5010"}
  },
  {
    id:"bmx", name:"BMX", type:"bike",
    stats:{speed:5,acceleration:8,fuelEfficiency:10,grip:6,traction:5,torque:0.022,fuelCapacity:60},
    cost:500, defaultUnlocked:false,
    bodyWidth:60, bodyHeight:22, wheelBase:56, wheelRadius:15, wheelYOffset:15, suspensionLength:20,
    physics:{density:0.0025},
    palette:{body:"#ff5588",accent:"#ffbb44"}
  },
  {
    id:"cruiser_bike", name:"Cruiser", type:"bike",
    stats:{speed:6,acceleration:5,fuelEfficiency:6,grip:8,traction:8,torque:0.028,fuelCapacity:90},
    cost:950, defaultUnlocked:false,
    bodyWidth:88, bodyHeight:26, wheelBase:86, wheelRadius:17, wheelYOffset:17, suspensionLength:24,
    physics:{density:0.0035},
    palette:{body:"#d0c040",accent:"#604000"}
  },
  {
    id:"supermoto", name:"Supermoto", type:"bike",
    stats:{speed:8,acceleration:8,fuelEfficiency:7,grip:8,traction:7,torque:0.034,fuelCapacity:75},
    cost:1300, defaultUnlocked:false,
    bodyWidth:72, bodyHeight:26, wheelBase:70, wheelRadius:17, wheelYOffset:16, suspensionLength:26,
    physics:{density:0.003},
    palette:{body:"#f0f0f0",accent:"#2040c0"}
  },
];

// ─── Per-vehicle unique SVG generators ───────────────────────────────────────

function L(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return `rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`}
function D(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return `rgb(${Math.max(0,r-a)},${Math.max(0,g-a)},${Math.max(0,b-a)})`}
function A(hex,op){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return `rgba(${r},${g},${b},${op})`}

function wheel(cx,cy,r,acc,id,i){
  const spokes=[0,51,102,153,204,255].map(a=>{
    const rad=a*Math.PI/180,x1=cx+Math.cos(rad)*r*0.18,y1=cy+Math.sin(rad)*r*0.18,x2=cx+Math.cos(rad)*r*0.58,y2=cy+Math.sin(rad)*r*0.58;
    return `<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" stroke="${acc}" stroke-width="1.8"/>`;
  }).join('');
  return `<circle cx="${cx}" cy="${cy}" r="${r+2}" fill="#181818"/>
  <circle cx="${cx}" cy="${cy}" r="${r}" fill="#222" stroke="#333" stroke-width="1.5" stroke-dasharray="4 3"/>
  <circle cx="${cx}" cy="${cy}" r="${r*0.64}" fill="#3a3a3a"/>
  ${spokes}
  <circle cx="${cx}" cy="${cy}" r="${r*0.18}" fill="${acc}"/>
  <ellipse cx="${cx-r*0.12}" cy="${cy-r*0.12}" rx="${r*0.2}" ry="${r*0.12}" fill="rgba(255,255,255,0.3)" transform="rotate(-30,${cx},${cy})"/>`;
}

function bigWheel(cx,cy,r,acc){
  // chunky off-road wheel
  const spokes=[0,40,80,120,160,200,240,280,320].map(a=>{
    const rad=a*Math.PI/180,x1=cx+Math.cos(rad)*r*0.25,y1=cy+Math.sin(rad)*r*0.25,x2=cx+Math.cos(rad)*r*0.7,y2=cy+Math.sin(rad)*r*0.7;
    return `<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" stroke="${acc}" stroke-width="2.5"/>`;
  }).join('');
  return `<circle cx="${cx}" cy="${cy}" r="${r+4}" fill="#111"/>
  <circle cx="${cx}" cy="${cy}" r="${r}" fill="#1a1a1a" stroke="#444" stroke-width="3" stroke-dasharray="6 4"/>
  <circle cx="${cx}" cy="${cy}" r="${r*0.6}" fill="#444"/>
  ${spokes}
  <circle cx="${cx}" cy="${cy}" r="${r*0.2}" fill="${acc}"/>`;
}

function trackSegment(x,y,w,h,color){
  return `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="4" fill="${color}"/>
  <line x1="${x+10}" y1="${y}" x2="${x+10}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+20}" y1="${y}" x2="${x+20}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+30}" y1="${y}" x2="${x+30}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+40}" y1="${y}" x2="${x+40}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+50}" y1="${y}" x2="${x+50}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+60}" y1="${y}" x2="${x+60}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+70}" y1="${y}" x2="${x+70}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>
  <line x1="${x+80}" y1="${y}" x2="${x+80}" y2="${y+h}" stroke="rgba(0,0,0,0.4)" stroke-width="3"/>`;
}

// ──────────────────────────────────────────────────────────────────────────────
// CAR SVGs
// ──────────────────────────────────────────────────────────────────────────────

function svgRustyHatchback(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="200" height="110" viewBox="0 0 200 110" xmlns="http://www.w3.org/2000/svg">
  <!-- Boxy hatchback - tall roofline, square rear, short hood -->
  <defs>
    <linearGradient id="rh_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,50)}"/><stop offset="100%" stop-color="${D(b,30)}"/></linearGradient>
  </defs>
  <!-- body -->
  <rect x="30" y="55" width="148" height="32" rx="5" fill="url(#rh_b)"/>
  <!-- cab - tall and boxy -->
  <rect x="42" y="25" width="98" height="34" rx="4" fill="${L(b,20)}"/>
  <!-- windshield - almost vertical -->
  <polygon points="56,26 96,26 96,55 42,55" fill="rgba(160,220,255,0.45)"/>
  <!-- rear window - vertical -->
  <rect x="102" y="28" width="30" height="25" rx="2" fill="rgba(160,220,255,0.35)"/>
  <!-- roof rack detail -->
  <rect x="48" y="24" width="90" height="4" rx="2" fill="${D(b,50)}"/>
  <!-- rust spots -->
  <ellipse cx="45" cy="72" rx="5" ry="3" fill="${D(b,40)}" opacity="0.7"/>
  <ellipse cx="160" cy="60" rx="4" ry="2" fill="${D(b,40)}" opacity="0.7"/>
  <ellipse cx="80" cy="80" rx="3" ry="2" fill="${D(b,40)}" opacity="0.7"/>
  <!-- dent mark -->
  <path d="M50,65 Q55,60 60,65" stroke="${D(b,60)}" stroke-width="1.5" fill="none"/>
  <!-- door line -->
  <line x1="95" y1="55" x2="95" y2="87" stroke="${D(b,40)}" stroke-width="1" opacity="0.6"/>
  <!-- headlight (square) -->
  <rect x="168" y="60" width="14" height="9" rx="1" fill="${L(a,80)}" opacity="0.9"/>
  <rect x="170" y="62" width="8" height="5" rx="1" fill="rgba(255,255,200,0.9)"/>
  <!-- taillight (square, red) -->
  <rect x="30" y="60" width="11" height="9" rx="1" fill="rgba(220,30,30,0.85)"/>
  <!-- bumpers -->
  <rect x="28" y="80" width="8" height="7" rx="2" fill="${D(a,10)}"/>
  <rect x="172" y="78" width="10" height="8" rx="2" fill="${D(a,10)}"/>
  <!-- exhaust -->
  <rect x="35" y="84" width="12" height="4" rx="2" fill="#555"/>
  <ellipse cx="35" cy="86" rx="3" ry="2" fill="#222"/>
  ${wheel(58,88,16,a,'rh',0)}
  ${wheel(150,88,16,a,'rh',1)}
  </svg>`;
}

function svgMonsterTruck(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="200" height="120" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="mt_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,60)}"/><stop offset="100%" stop-color="${D(b,30)}"/></linearGradient>
  </defs>
  <!-- Huge wheels with suspension, tiny cab on top -->
  <!-- Suspension arms -->
  <line x1="52" y1="70" x2="52" y2="50" stroke="#555" stroke-width="5" stroke-linecap="round"/>
  <line x1="148" y1="70" x2="148" y2="50" stroke="#555" stroke-width="5" stroke-linecap="round"/>
  <!-- Axle bars -->
  <rect x="45" y="48" width="110" height="6" rx="3" fill="#444"/>
  <!-- Body - sits high up -->
  <rect x="48" y="20" width="104" height="36" rx="6" fill="url(#mt_b)"/>
  <!-- Cab on top -->
  <rect x="60" y="8" width="80" height="18" rx="5" fill="${L(b,25)}"/>
  <!-- Windshield -->
  <polygon points="68,9 132,9 128,22 72,22" fill="rgba(160,220,255,0.5)"/>
  <!-- Scoop on hood -->
  <rect x="72" y="20" width="16" height="8" rx="2" fill="${D(a,10)}"/>
  <rect x="74" y="22" width="12" height="4" rx="1" fill="#1a1a1a"/>
  <!-- Exhaust stacks (x2 vertical) -->
  <rect x="62" y="5" width="6" height="16" rx="3" fill="#888"/>
  <rect x="72" y="3" width="6" height="18" rx="3" fill="#888"/>
  <!-- Headlights (round) -->
  <circle cx="148" cy="38" r="7" fill="${L(a,60)}"/>
  <circle cx="148" cy="38" r="4" fill="rgba(255,255,200,0.9)"/>
  <circle cx="136" cy="38" r="5" fill="${L(a,40)}"/>
  <!-- Taillights -->
  <circle cx="56" cy="38" r="6" fill="rgba(220,30,30,0.9)"/>
  <!-- Giant off-road wheels -->
  ${bigWheel(52,88,26,a)}
  ${bigWheel(148,88,26,a)}
  <!-- Mud flaps -->
  <rect x="22" y="82" width="6" height="14" rx="1" fill="#333"/>
  <rect x="172" y="82" width="6" height="14" rx="1" fill="#333"/>
  </svg>`;
}

function svgRallyRacer(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="210" height="105" viewBox="0 0 210 105" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="rr_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,55)}"/><stop offset="100%" stop-color="${D(b,20)}"/></linearGradient>
  </defs>
  <!-- Very low, wide, sporty - wide arches, rear spoiler -->
  <!-- Body shell - wedge shape -->
  <polygon points="25,75 55,52 155,48 195,58 198,78 22,78" fill="url(#rr_b)"/>
  <!-- Cab -->
  <polygon points="70,53 72,32 145,30 150,48" fill="${L(b,20)}"/>
  <!-- Windshield (raked) -->
  <polygon points="78,33 140,31 142,48 73,50" fill="rgba(160,220,255,0.5)"/>
  <!-- Side stripe -->
  <polygon points="30,72 200,72 200,78 25,78" fill="${a}" opacity="0.7"/>
  <!-- Number plate on door -->
  <rect x="98" y="58" width="30" height="16" rx="2" fill="white" opacity="0.9"/>
  <text x="113" y="70" text-anchor="middle" font-size="9" font-weight="bold" fill="${b}" font-family="Orbitron,monospace">03</text>
  <!-- Rear spoiler -->
  <rect x="24" y="47" width="6" height="14" rx="1" fill="${D(b,20)}"/>
  <rect x="18" y="45" width="20" height="4" rx="2" fill="${D(a,10)}"/>
  <!-- Rally lights bar on roof -->
  <rect x="88" y="29" width="40" height="6" rx="2" fill="#222"/>
  <circle cx="96" cy="32" r="2.5" fill="#ffcc00"/>
  <circle cx="105" cy="32" r="2.5" fill="#ffcc00"/>
  <circle cx="114" cy="32" r="2.5" fill="#ffcc00"/>
  <circle cx="123" cy="32" r="2.5" fill="#ffcc00"/>
  <!-- Headlights (round, 2) -->
  <circle cx="190" cy="63" r="6" fill="${L(a,70)}"/>
  <circle cx="190" cy="63" r="3.5" fill="rgba(255,255,200,0.9)"/>
  <circle cx="178" cy="63" r="5" fill="${L(a,40)}"/>
  <!-- Taillights (strip) -->
  <rect x="24" y="61" width="3" height="14" fill="rgba(220,30,30,0.9)"/>
  <!-- Wide wheel arches -->
  <ellipse cx="72" cy="78" rx="22" ry="6" fill="${D(b,50)}" opacity="0.5"/>
  <ellipse cx="158" cy="78" rx="22" ry="6" fill="${D(b,50)}" opacity="0.5"/>
  <!-- Dual exhaust -->
  <rect x="195" y="73" width="14" height="4" rx="2" fill="#777"/>
  <rect x="195" y="79" width="14" height="4" rx="2" fill="#777"/>
  ${wheel(72,83,17,a,'rr',0)}
  ${wheel(158,83,17,a,'rr',1)}
  </svg>`;
}

function svgMuscleCar(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="215" height="108" viewBox="0 0 215 108" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="mc_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,65)}"/><stop offset="100%" stop-color="${D(b,25)}"/></linearGradient>
  </defs>
  <!-- Long hood, fastback roofline, short deck -->
  <!-- Long body -->
  <polygon points="15,80 30,62 80,55 130,48 195,55 210,65 210,82 15,82" fill="url(#mc_b)"/>
  <!-- Long hood (flat) -->
  <rect x="130" y="54" width="80" height="14" rx="3" fill="${L(b,30)}"/>
  <!-- Power hood scoop -->
  <ellipse cx="165" cy="54" rx="20" ry="6" fill="${D(b,15)}"/>
  <ellipse cx="165" cy="54" rx="12" ry="3" fill="#111"/>
  <!-- Fastback cab (sloping rear) -->
  <polygon points="80,56 83,30 148,28 152,48" fill="${L(b,18)}"/>
  <!-- Windshield (raked) -->
  <polygon points="90,31 145,29 148,47 83,50" fill="rgba(160,220,255,0.5)"/>
  <!-- Rear fastback slope -->
  <polygon points="30,62 82,56 80,80 16,80" fill="${L(b,8)}"/>
  <!-- Rear window (small, sloped) -->
  <polygon points="42,63 78,57 78,72 44,76" fill="rgba(160,220,255,0.35)"/>
  <!-- Stripe (classic muscle stripe) -->
  <polygon points="15,68 210,68 210,74 15,74" fill="${a}" opacity="0.6"/>
  <!-- Front grille -->
  <rect x="202" y="62" width="6" height="14" rx="1" fill="#111"/>
  <line x1="202" y1="66" x2="208" y2="66" stroke="#333" stroke-width="1"/>
  <line x1="202" y1="70" x2="208" y2="70" stroke="#333" stroke-width="1"/>
  <line x1="202" y1="74" x2="208" y2="74" stroke="#333" stroke-width="1"/>
  <!-- Headlights (round, quad) -->
  <circle cx="200" cy="62" r="5" fill="${L(a,80)}"/>
  <circle cx="200" cy="62" r="2.5" fill="rgba(255,255,220,0.9)"/>
  <circle cx="200" cy="71" r="5" fill="${L(a,60)}"/>
  <!-- Taillights -->
  <rect x="18" y="62" width="5" height="16" fill="rgba(220,40,40,0.9)"/>
  <!-- Dual side exhaust pipes -->
  <rect x="136" y="80" width="20" height="4" rx="2" fill="#888"/>
  <ellipse cx="135" cy="82" rx="3" ry="2" fill="#333"/>
  <rect x="136" y="85" width="20" height="4" rx="2" fill="#888"/>
  <ellipse cx="135" cy="87" rx="3" ry="2" fill="#333"/>
  ${wheel(62,85,18,a,'mc',0)}
  ${wheel(170,85,18,a,'mc',1)}
  </svg>`;
}

function svgJeep4x4(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="200" height="112" viewBox="0 0 200 112" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="jx_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,55)}"/><stop offset="100%" stop-color="${D(b,25)}"/></linearGradient>
  </defs>
  <!-- Boxy, upright, tall clearance, flat roof, spare tire on back -->
  <!-- Main body - very boxy -->
  <rect x="28" y="48" width="144" height="38" rx="3" fill="url(#jx_b)"/>
  <!-- Flat roof cab -->
  <rect x="38" y="20" width="124" height="32" rx="2" fill="${L(b,20)}"/>
  <!-- Windshield (nearly vertical) -->
  <rect x="50" y="22" width="96" height="28" rx="2" fill="rgba(160,220,255,0.45)"/>
  <!-- Windshield divider -->
  <line x1="100" y1="22" x2="100" y2="50" stroke="${D(b,30)}" stroke-width="2"/>
  <!-- Spare tire on back -->
  <circle cx="30" cy="65" r="16" fill="#1a1a1a"/>
  <circle cx="30" cy="65" r="11" fill="#333" stroke="#555" stroke-width="1.5" stroke-dasharray="4 3"/>
  <circle cx="30" cy="65" r="5" fill="#666"/>
  <!-- Snorkel on front-right -->
  <rect x="166" y="14" width="6" height="40" rx="3" fill="#555"/>
  <rect x="163" y="14" width="12" height="6" rx="3" fill="#444"/>
  <!-- Roof rack -->
  <rect x="44" y="19" width="116" height="4" rx="2" fill="${D(b,40)}"/>
  <line x1="66" y1="19" x2="66" y2="23" stroke="${D(b,50)}" stroke-width="1.5"/>
  <line x1="90" y1="19" x2="90" y2="23" stroke="${D(b,50)}" stroke-width="1.5"/>
  <line x1="114" y1="19" x2="114" y2="23" stroke="${D(b,50)}" stroke-width="1.5"/>
  <line x1="138" y1="19" x2="138" y2="23" stroke="${D(b,50)}" stroke-width="1.5"/>
  <!-- Headlights (round) -->
  <circle cx="166" cy="62" r="8" fill="${L(a,70)}"/>
  <circle cx="166" cy="62" r="4.5" fill="rgba(255,255,220,0.9)"/>
  <!-- Taillights (square) -->
  <rect x="20" y="58" width="10" height="12" rx="1" fill="rgba(220,30,30,0.9)"/>
  <!-- Door handle lines -->
  <line x1="70" y1="64" x2="100" y2="64" stroke="${D(b,40)}" stroke-width="1" opacity="0.7"/>
  <line x1="108" y1="64" x2="138" y2="64" stroke="${D(b,40)}" stroke-width="1" opacity="0.7"/>
  <!-- Front winch -->
  <rect x="170" y="75" width="8" height="8" rx="1" fill="#555"/>
  <!-- Bull bar -->
  <rect x="168" y="48" width="4" height="38" rx="2" fill="#666"/>
  ${bigWheel(65,90,22,a)}
  ${bigWheel(155,90,22,a)}
  </svg>`;
}

function svgSportsCoupe(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="215" height="100" viewBox="0 0 215 100" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sc_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,70)}"/><stop offset="100%" stop-color="${D(b,15)}"/></linearGradient>
    <linearGradient id="sc_shine" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.5)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></linearGradient>
  </defs>
  <!-- Ultra-low supercar silhouette, huge greenhouse, aerodynamic -->
  <!-- Body - very low, sharp wedge -->
  <polygon points="12,80 28,68 60,58 150,52 205,60 213,72 213,82 12,82" fill="url(#sc_b)"/>
  <!-- Swooping canopy -->
  <path d="M72,59 Q90,35 148,33 Q162,33 168,50 L152,52 Q140,40 94,44 Q80,46 70,58 Z" fill="${L(b,22)}"/>
  <!-- Windshield (very raked) -->
  <path d="M80,59 Q96,40 148,37 L152,52 L72,59 Z" fill="rgba(160,220,255,0.55)"/>
  <!-- Rear window -->
  <polygon points="70,59 80,47 90,46 88,58" fill="rgba(160,220,255,0.4)"/>
  <!-- Shine on body -->
  <polygon points="30,70 205,63 205,68 30,76" fill="url(#sc_shine)" opacity="0.6"/>
  <!-- Side air intake -->
  <path d="M182,66 L194,64 L194,74 L182,74 Z" fill="#111"/>
  <rect x="182" y="67" width="12" height="2" fill="#333"/>
  <rect x="182" y="70" width="12" height="2" fill="#333"/>
  <!-- Door crease -->
  <line x1="70" y1="66" x2="185" y2="62" stroke="${L(b,40)}" stroke-width="1.5" opacity="0.8"/>
  <!-- Rear diffuser -->
  <rect x="15" y="73" width="14" height="10" rx="1" fill="#1a1a1a"/>
  <line x1="18" y1="73" x2="18" y2="83" stroke="#333" stroke-width="1"/>
  <line x1="22" y1="73" x2="22" y2="83" stroke="#333" stroke-width="1"/>
  <line x1="26" y1="73" x2="26" y2="83" stroke="#333" stroke-width="1"/>
  <!-- Headlights (thin, aggressive) -->
  <polygon points="205,62 213,65 213,70 205,67" fill="${L(a,80)}" opacity="0.95"/>
  <polygon points="205,63 212,65 212,68 205,66" fill="rgba(255,255,220,0.9)"/>
  <!-- Tail lights (LED strip) -->
  <rect x="15" y="62" width="3" height="10" fill="${a}" opacity="0.9"/>
  <!-- Lip spoiler front -->
  <rect x="205" y="79" width="9" height="4" rx="1" fill="${D(b,30)}"/>
  <!-- Rear wing small -->
  <rect x="18" y="56" width="3" height="10" rx="1" fill="${D(b,40)}"/>
  <rect x="12" y="54" width="16" height="3" rx="1" fill="${D(b,20)}"/>
  <!-- Exhaust (x2 center) -->
  <ellipse cx="110" cy="83" rx="5" ry="3" fill="#333"/>
  <ellipse cx="122" cy="83" rx="5" ry="3" fill="#333"/>
  ${wheel(70,82,16,a,'sp',0)}
  ${wheel(168,82,16,a,'sp',1)}
  </svg>`;
}

function svgDuneBuggy(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="195" height="108" viewBox="0 0 195 108" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="db_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,60)}"/><stop offset="100%" stop-color="${D(b,20)}"/></linearGradient>
  </defs>
  <!-- Open frame, tubular roll cage, exposed engine, no doors -->
  <!-- Roll cage tubes -->
  <line x1="68" y1="30" x2="68" y2="75" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="130" y1="30" x2="130" y2="75" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="68" y1="30" x2="130" y2="30" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <!-- Diagonal braces -->
  <line x1="68" y1="30" x2="130" y2="55" stroke="${D(b,20)}" stroke-width="3"/>
  <line x1="130" y1="30" x2="68" y2="55" stroke="${D(b,20)}" stroke-width="3"/>
  <!-- Low body pan -->
  <rect x="48" y="68" width="100" height="16" rx="3" fill="url(#db_b)"/>
  <!-- Front nose (fiberglass shell) -->
  <path d="M148,68 Q175,65 188,75 L188,80 L148,82 Z" fill="${L(b,20)}"/>
  <!-- Rear engine exposed -->
  <rect x="30" y="50" width="28" height="22" rx="2" fill="${D(b,10)}"/>
  <rect x="33" y="53" width="22" height="14" rx="1" fill="${a}" opacity="0.5"/>
  <!-- Engine fins -->
  <line x1="35" y1="53" x2="35" y2="67" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="39" y1="53" x2="39" y2="67" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="43" y1="53" x2="43" y2="67" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="47" y1="53" x2="47" y2="67" stroke="${D(b,40)}" stroke-width="1.5"/>
  <!-- Seats (bucket) -->
  <rect x="72" y="48" width="24" height="22" rx="3" fill="${D(b,20)}"/>
  <rect x="102" y="48" width="24" height="22" rx="3" fill="${D(b,20)}"/>
  <rect x="74" y="46" width="20" height="6" rx="2" fill="${D(b,10)}"/>
  <rect x="104" y="46" width="20" height="6" rx="2" fill="${D(b,10)}"/>
  <!-- Steering wheel -->
  <circle cx="132" cy="52" r="10" fill="none" stroke="#333" stroke-width="3"/>
  <line x1="122" y1="52" x2="142" y2="52" stroke="#333" stroke-width="2"/>
  <line x1="132" y1="42" x2="132" y2="62" stroke="#333" stroke-width="2"/>
  <!-- Headlights (round, on nose) -->
  <circle cx="185" cy="72" r="7" fill="${L(a,70)}"/>
  <circle cx="185" cy="72" r="4" fill="rgba(255,255,220,0.9)"/>
  <!-- Flag mount -->
  <line x1="55" y1="28" x2="55" y2="15" stroke="#888" stroke-width="2"/>
  <polygon points="55,15 70,18 55,22" fill="${a}"/>
  <!-- Exhaust (side, rear) -->
  <path d="M30,62 Q18,64 15,72" stroke="#888" stroke-width="4" fill="none" stroke-linecap="round"/>
  <ellipse cx="15" cy="73" rx="4" ry="2.5" fill="#444"/>
  ${bigWheel(55,86,22,a)}
  ${bigWheel(155,86,22,a)}
  </svg>`;
}

function svgTank(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="215" height="105" viewBox="0 0 215 105" xmlns="http://www.w3.org/2000/svg">
  <!-- Tank - flat hull, tracks, turret, cannon -->
  <!-- Track (left) -->
  ${trackSegment(8,68,199,22,D(b,30))}
  <rect x="8" y="66" width="199" height="4" rx="2" fill="${D(b,40)}"/>
  <rect x="8" y="88" width="199" height="4" rx="2" fill="${D(b,40)}"/>
  <!-- Road wheels -->
  ${[28,54,80,106,132,158,184].map(x=>`<circle cx="${x}" cy="79" r="10" fill="#333" stroke="#555" stroke-width="1.5"/><circle cx="${x}" cy="79" r="5" fill="#444"/>`).join('')}
  <!-- Hull -->
  <polygon points="12,44 30,36 185,36 200,44 200,68 12,68" fill="${b}"/>
  <!-- Hull top shine -->
  <polygon points="30,36 185,36 182,42 33,42" fill="rgba(255,255,255,0.15)"/>
  <!-- Turret -->
  <ellipse cx="108" cy="36" rx="42" ry="18" fill="${L(b,15)}"/>
  <ellipse cx="108" cy="34" rx="36" ry="14" fill="${L(b,20)}"/>
  <!-- Hatch -->
  <ellipse cx="118" cy="30" rx="10" ry="6" fill="${D(b,20)}"/>
  <ellipse cx="118" cy="29" rx="7" ry="4" fill="${D(b,40)}"/>
  <!-- Periscope -->
  <rect x="100" y="22" width="5" height="10" rx="2" fill="#555"/>
  <rect x="99" y="22" width="7" height="3" rx="1" fill="#666"/>
  <!-- Cannon barrel -->
  <rect x="148" y="29" width="60" height="8" rx="3" fill="${D(b,15)}"/>
  <rect x="204" y="28" width="8" height="10" rx="2" fill="${D(b,30)}"/>
  <rect x="148" y="31" width="56" height="4" rx="2" fill="${D(b,30)}"/>
  <!-- Antenna -->
  <line x1="82" y1="22" x2="80" y2="5" stroke="#888" stroke-width="2"/>
  <!-- Machine gun -->
  <rect x="146" y="22" width="20" height="4" rx="2" fill="#555"/>
  <!-- Hull vents -->
  <rect x="40" y="50" width="20" height="6" rx="1" fill="${D(b,40)}"/>
  <line x1="43" y1="50" x2="43" y2="56" stroke="${D(b,50)}" stroke-width="1.5"/>
  <line x1="47" y1="50" x2="47" y2="56" stroke="${D(b,50)}" stroke-width="1.5"/>
  <line x1="51" y1="50" x2="51" y2="56" stroke="${D(b,50)}" stroke-width="1.5"/>
  <!-- Headlight -->
  <circle cx="30" cy="52" r="6" fill="${L(a,70)}"/>
  <circle cx="30" cy="52" r="3" fill="rgba(255,255,220,0.9)"/>
  </svg>`;
}

function svgPickupTruck(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="215" height="108" viewBox="0 0 215 108" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="pt_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,55)}"/><stop offset="100%" stop-color="${D(b,20)}"/></linearGradient>
  </defs>
  <!-- Cab + open bed, high ride -->
  <!-- Truck bed (flat open) -->
  <rect x="22" y="52" width="90" height="32" rx="3" fill="${D(b,15)}"/>
  <!-- Bed floor -->
  <rect x="24" y="64" width="86" height="18" rx="1" fill="${D(b,40)}"/>
  <!-- Bed rails -->
  <rect x="22" y="52" width="4" height="32" rx="1" fill="${D(b,20)}"/>
  <rect x="108" y="52" width="4" height="32" rx="1" fill="${D(b,20)}"/>
  <!-- Tailgate -->
  <rect x="22" y="80" width="90" height="4" rx="1" fill="${D(b,10)}"/>
  <!-- Cab -->
  <rect x="112" y="48" width="90" height="36" rx="5" fill="url(#pt_b)"/>
  <!-- Cab roof -->
  <rect x="120" y="26" width="76" height="26" rx="4" fill="${L(b,20)}"/>
  <!-- Windshield -->
  <polygon points="128,27 192,27 194,48 120,48" fill="rgba(160,220,255,0.5)"/>
  <!-- Rear window (small) -->
  <rect x="122" y="30" width="18" height="16" rx="2" fill="rgba(160,220,255,0.35)"/>
  <!-- Hood -->
  <rect x="190" y="46" width="22" height="20" rx="2" fill="${L(b,25)}"/>
  <!-- Grille -->
  <rect x="206" y="48" width="6" height="14" rx="1" fill="#111"/>
  <line x1="206" y1="52" x2="212" y2="52" stroke="#333" stroke-width="1"/>
  <line x1="206" y1="56" x2="212" y2="56" stroke="#333" stroke-width="1"/>
  <line x1="206" y1="60" x2="212" y2="60" stroke="#333" stroke-width="1"/>
  <!-- Headlights -->
  <rect x="200" y="50" width="7" height="9" rx="2" fill="${L(a,80)}"/>
  <rect x="201" y="52" width="4" height="5" rx="1" fill="rgba(255,255,220,0.9)"/>
  <!-- Taillights (strip on bed) -->
  <rect x="24" y="54" width="4" height="10" fill="rgba(220,30,30,0.9)"/>
  <!-- Step bar -->
  <rect x="138" y="82" width="40" height="4" rx="2" fill="#555"/>
  <!-- Tow hook -->
  <rect x="14" y="76" width="10" height="8" rx="2" fill="#555"/>
  <circle cx="14" cy="80" r="4" fill="none" stroke="#888" stroke-width="2"/>
  <!-- Exhaust -->
  <rect x="106" y="82" width="10" height="4" rx="2" fill="#888"/>
  ${wheel(56,85,18,a,'pi',0)}
  ${wheel(170,85,18,a,'pi',1)}
  </svg>`;
}

function svgElectricCar(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="210" height="102" viewBox="0 0 210 102" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="ec_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,70)}"/><stop offset="100%" stop-color="${D(b,10)}"/></linearGradient>
    <linearGradient id="ec_s" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.55)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></linearGradient>
  </defs>
  <!-- Aerodynamic teardrop, very smooth, no panel gaps -->
  <!-- Main body - smooth aero shape -->
  <path d="M25,80 Q22,65 38,56 Q68,42 110,40 Q150,40 178,50 Q200,58 205,70 Q208,80 205,82 L25,82 Z" fill="url(#ec_b)"/>
  <!-- Smooth canopy integrated with body -->
  <path d="M62,56 Q76,35 128,33 Q158,33 172,50 L165,52 Q152,38 126,38 Q80,38 68,57 Z" fill="${L(b,22)}"/>
  <!-- Panoramic glass (huge) -->
  <path d="M70,57 Q84,40 128,38 Q155,38 166,50 L162,52 L68,57 Z" fill="rgba(160,220,255,0.6)"/>
  <!-- Glass tint reflection -->
  <path d="M80,57 Q90,44 120,42 L125,44 Q96,46 82,58 Z" fill="rgba(255,255,255,0.2)"/>
  <!-- Body shine -->
  <path d="M40,60 Q110,48 175,54 Q178,58 175,60 Q110,54 40,65 Z" fill="url(#ec_s)" opacity="0.5"/>
  <!-- Flush charge port (glowing) -->
  <circle cx="26" cy="66" r="6" fill="${a}" opacity="0.8"/>
  <circle cx="26" cy="66" r="3" fill="rgba(255,255,255,0.7)"/>
  <!-- LED headlight strip -->
  <path d="M196,62 Q205,65 206,72 L200,73 Q200,68 195,66 Z" fill="${L(a,80)}" opacity="0.9"/>
  <!-- LED taillight strip -->
  <path d="M26,65 Q24,70 25,78" stroke="${a}" stroke-width="3" fill="none" opacity="0.9"/>
  <!-- Aero underbody (flat) -->
  <rect x="30" y="80" width="178" height="4" rx="2" fill="${D(b,30)}"/>
  <!-- No grille (electric) - smooth nose -->
  <path d="M200,67 Q207,70 207,76 L200,76 Z" fill="${D(b,15)}"/>
  <!-- Charging indicator dots -->
  <circle cx="36" cy="66" r="2" fill="${a}" opacity="0.7"/>
  <circle cx="43" cy="64" r="2" fill="${a}" opacity="0.5"/>
  <circle cx="50" cy="62" r="2" fill="${a}" opacity="0.3"/>
  ${wheel(72,83,16,a,'el',0)}
  ${wheel(164,83,16,a,'el',1)}
  </svg>`;
}

// ──────────────────────────────────────────────────────────────────────────────
// BIKE SVGs
// ──────────────────────────────────────────────────────────────────────────────

function svgDirtBike(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="180" height="115" viewBox="0 0 180 115" xmlns="http://www.w3.org/2000/svg">
  <!-- High seat, long travel suspension visible, knobbly tires, upright -->
  <!-- Rear suspension linkage -->
  <line x1="52" y1="60" x2="68" y2="88" stroke="#666" stroke-width="4" stroke-linecap="round"/>
  <line x1="68" y1="72" x2="58" y2="88" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <!-- Frame backbone -->
  <line x1="52" y1="38" x2="120" y2="52" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="52" y1="38" x2="62" y2="62" stroke="${D(b,10)}" stroke-width="4" stroke-linecap="round"/>
  <line x1="62" y1="62" x2="120" y2="52" stroke="${D(b,15)}" stroke-width="3"/>
  <!-- Swingarm -->
  <line x1="62" y1="62" x2="52" y2="88" stroke="${D(b,5)}" stroke-width="5" stroke-linecap="round"/>
  <!-- Front fork (long travel) -->
  <line x1="120" y1="52" x2="128" y2="20" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <line x1="120" y1="52" x2="134" y2="88" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <!-- Fork springs detail -->
  <rect x="126" y="22" width="4" height="20" rx="2" fill="#999"/>
  <line x1="126" y1="26" x2="130" y2="26" stroke="#bbb" stroke-width="1"/>
  <line x1="126" y1="30" x2="130" y2="30" stroke="#bbb" stroke-width="1"/>
  <line x1="126" y1="34" x2="130" y2="34" stroke="#bbb" stroke-width="1"/>
  <!-- Fuel tank / seat unit (tall) -->
  <path d="M52,36 Q58,22 78,20 Q90,20 100,26 Q115,32 120,50 L62,62 Z" fill="${b}"/>
  <!-- Tank shine -->
  <path d="M60,36 Q66,26 80,24 Q92,24 98,30 Z" fill="rgba(255,255,255,0.25)"/>
  <!-- Seat (tall, narrow) -->
  <rect x="48" y="36" width="16" height="28" rx="4" fill="${D(b,25)}"/>
  <!-- Number plate front -->
  <rect x="124" y="42" width="18" height="14" rx="2" fill="white" opacity="0.9"/>
  <text x="133" y="52" text-anchor="middle" font-size="7" font-weight="bold" fill="${b}" font-family="Orbitron,monospace">7</text>
  <!-- Handlebars (wide motocross) -->
  <line x1="110" y1="20" x2="148" y2="20" stroke="#888" stroke-width="4" stroke-linecap="round"/>
  <line x1="126" y1="20" x2="126" y2="28" stroke="#666" stroke-width="3" stroke-linecap="round"/>
  <!-- Hand grips -->
  <rect x="110" y="18" width="8" height="5" rx="2" fill="#222"/>
  <rect x="142" y="18" width="8" height="5" rx="2" fill="#222"/>
  <!-- Headlight (round) -->
  <circle cx="136" cy="44" r="10" fill="${L(a,60)}"/>
  <circle cx="136" cy="44" r="6" fill="rgba(255,255,220,0.9)"/>
  <!-- Exhaust (upswept) -->
  <path d="M80,62 Q70,70 60,80 Q50,88 45,85" stroke="#888" stroke-width="6" fill="none" stroke-linecap="round"/>
  <ellipse cx="43" cy="84" rx="5" ry="3" fill="#555"/>
  <!-- Knobbly wheels (bigger tread pattern) -->
  ${bigWheel(52,92,22,a)}
  ${bigWheel(134,92,22,a)}
  </svg>`;
}

function svgChopper(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="200" height="105" viewBox="0 0 200 105" xmlns="http://www.w3.org/2000/svg">
  <!-- Very extended front fork at angle, ape hanger bars, low seat, long stretched frame -->
  <!-- Extended front fork (highly raked) -->
  <line x1="142" y1="48" x2="178" y2="12" stroke="#888" stroke-width="5" stroke-linecap="round"/>
  <line x1="148" y1="52" x2="184" y2="14" stroke="#aaa" stroke-width="3" stroke-linecap="round"/>
  <!-- Ape hanger handlebars (tall) -->
  <line x1="142" y1="48" x2="130" y2="20" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <line x1="130" y1="20" x2="160" y2="20" stroke="#888" stroke-width="4" stroke-linecap="round"/>
  <circle cx="128" cy="20" r="4" fill="#333"/>
  <circle cx="162" cy="20" r="4" fill="#333"/>
  <!-- Long frame backbone (stretched) -->
  <line x1="48" y1="66" x2="148" y2="52" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="48" y1="66" x2="58" y2="84" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="142" y1="56" x2="148" y2="80" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <!-- Engine (v-twin look) -->
  <rect x="90" y="55" width="40" height="28" rx="4" fill="${D(b,10)}"/>
  <polygon points="95,55 115,42 118,55" fill="${b}" opacity="0.8"/>
  <polygon points="115,55 132,42 135,55" fill="${b}" opacity="0.8"/>
  <!-- Engine fins -->
  <line x1="97" y1="45" x2="97" y2="55" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="101" y1="43" x2="101" y2="55" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="105" y1="42" x2="105" y2="55" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="109" y1="42" x2="109" y2="55" stroke="${D(b,40)}" stroke-width="1.5"/>
  <!-- Chrome cylinders -->
  <rect x="118" y="44" width="14" height="11" rx="2" fill="#bbb"/>
  <rect x="133" y="44" width="14" height="11" rx="2" fill="#aaa"/>
  <!-- Fuel tank (teardrop) -->
  <ellipse cx="112" cy="56" rx="25" ry="9" fill="${b}"/>
  <ellipse cx="112" cy="54" rx="18" ry="5" fill="rgba(255,255,255,0.2)"/>
  <!-- Low seat (long, stretched) -->
  <rect x="52" y="62" width="60" height="8" rx="4" fill="${D(b,30)}"/>
  <rect x="52" y="60" width="60" height="5" rx="3" fill="${D(b,15)}"/>
  <!-- Sissy bar -->
  <line x1="52" y1="60" x2="48" y2="40" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="48" y1="40" x2="56" y2="40" stroke="#888" stroke-width="2" stroke-linecap="round"/>
  <!-- Fat rear fender (big) -->
  <path d="M25,68 Q26,50 48,52 Q58,52 60,68 Z" fill="${D(b,15)}" opacity="0.8"/>
  <!-- Front fender (small) -->
  <path d="M160,80 Q162,70 168,68 Q174,70 172,80 Z" fill="${D(b,15)}" opacity="0.8"/>
  <!-- Side exhaust (long pipes) -->
  <path d="M128,80 Q115,84 100,84 Q70,84 50,82" stroke="#bbb" stroke-width="6" fill="none" stroke-linecap="round"/>
  <path d="M128,86 Q115,90 100,90 Q70,90 50,88" stroke="#999" stroke-width="5" fill="none" stroke-linecap="round"/>
  <!-- Headlight (small teardrop) -->
  <ellipse cx="180" cy="18" rx="9" ry="7" fill="${L(a,70)}"/>
  <ellipse cx="180" cy="17" rx="5" ry="4" fill="rgba(255,255,220,0.9)"/>
  <!-- Taillight (small red) -->
  <circle cx="44" cy="62" r="4" fill="rgba(220,30,30,0.9)"/>
  <!-- Fat rear wheel, thin front -->
  ${wheel(48,86,20,a,'ch',0)}
  ${wheel(168,86,16,a,'ch',1)}
  </svg>`;
}

function svgSportBike(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="185" height="105" viewBox="0 0 185 105" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sb_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,65)}"/><stop offset="100%" stop-color="${D(b,15)}"/></linearGradient>
  </defs>
  <!-- Full fairing, crouched rider position, aggressive front -->
  <!-- Frame -->
  <line x1="62" y1="60" x2="118" y2="46" stroke="#444" stroke-width="4"/>
  <line x1="62" y1="60" x2="68" y2="82" stroke="#444" stroke-width="4"/>
  <!-- Front fork -->
  <line x1="118" y1="46" x2="126" y2="28" stroke="#888" stroke-width="4" stroke-linecap="round"/>
  <line x1="118" y1="46" x2="128" y2="82" stroke="#888" stroke-width="4" stroke-linecap="round"/>
  <!-- Swingarm -->
  <line x1="62" y1="62" x2="68" y2="82" stroke="#555" stroke-width="4"/>
  <!-- Full fairing (upper) -->
  <path d="M100,46 Q118,28 136,32 Q148,38 150,50 Q148,60 134,65 Q118,68 100,64 Z" fill="url(#sb_b)"/>
  <!-- Windscreen (tinted) -->
  <path d="M118,32 Q130,28 138,34 Q142,40 136,46 Q126,42 118,45 Z" fill="rgba(40,80,160,0.6)"/>
  <!-- Fairing side panel -->
  <path d="M62,58 Q80,44 120,44 Q130,44 136,50 Q134,64 120,66 Q80,68 62,68 Z" fill="${L(b,10)}" opacity="0.9"/>
  <!-- Tank/bodywork seam -->
  <line x1="70" y1="50" x2="120" y2="46" stroke="${D(b,20)}" stroke-width="1" opacity="0.7"/>
  <!-- Seat hump -->
  <ellipse cx="70" cy="54" rx="15" ry="7" fill="${D(b,20)}"/>
  <!-- Belly pan -->
  <path d="M68,68 Q95,74 128,74 L128,78 Q95,80 68,74 Z" fill="${D(b,15)}"/>
  <!-- Front nose (pointed) -->
  <path d="M134,50 Q148,48 156,56 Q154,64 140,66 Z" fill="${b}"/>
  <!-- Headlight (thin LED) -->
  <path d="M148,50 Q158,54 158,60 L152,60 Q152,57 145,55 Z" fill="${L(a,70)}"/>
  <!-- Taillight (LED) -->
  <rect x="58" y="53" width="3" height="8" fill="${a}" opacity="0.9"/>
  <!-- Clip-on handlebars (low, sporty) -->
  <line x1="120" y1="35" x2="130" y2="33" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <line x1="126" y1="28" x2="134" y2="33" stroke="#777" stroke-width="2.5" stroke-linecap="round"/>
  <!-- Exhaust (under-engine) -->
  <path d="M90,68 Q75,74 70,80 Q66,84 62,84" stroke="#aaa" stroke-width="5" fill="none" stroke-linecap="round"/>
  <ellipse cx="61" cy="84" rx="5" ry="3" fill="#444"/>
  <!-- Number decal -->
  <ellipse cx="104" cy="56" rx="10" ry="6" fill="white" opacity="0.8"/>
  <text x="104" y="59" text-anchor="middle" font-size="7" font-weight="bold" fill="${b}" font-family="Orbitron,monospace">46</text>
  ${wheel(68,86,18,a,'sp',0)}
  ${wheel(128,86,17,a,'sp',1)}
  </svg>`;
}

function svgScrambler(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="178" height="105" viewBox="0 0 178 105" xmlns="http://www.w3.org/2000/svg">
  <!-- Upright, round headlight, simple tubular frame, knobbly tires -->
  <!-- Simple frame -->
  <line x1="58" y1="56" x2="110" y2="46" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="58" y1="56" x2="60" y2="82" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="60" y1="70" x2="110" y2="56" stroke="${D(b,15)}" stroke-width="3"/>
  <line x1="110" y1="46" x2="116" y2="82" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <!-- Fork stays -->
  <line x1="110" y1="46" x2="114" y2="26" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <!-- Round tank (classic) -->
  <ellipse cx="90" cy="52" rx="26" ry="12" fill="${b}"/>
  <ellipse cx="90" cy="50" rx="18" ry="7" fill="rgba(255,255,255,0.2)"/>
  <!-- Seat (padded, flat) -->
  <rect x="54" y="48" width="40" height="10" rx="5" fill="${D(b,25)}"/>
  <rect x="54" y="46" width="40" height="6" rx="4" fill="${D(b,10)}"/>
  <!-- Engine (simple block) -->
  <rect x="76" y="56" width="34" height="24" rx="3" fill="${D(b,10)}"/>
  <rect x="79" y="59" width="28" height="16" rx="2" fill="${a}" opacity="0.4"/>
  <!-- Engine fins -->
  <line x1="80" y1="59" x2="80" y2="75" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="85" y1="59" x2="85" y2="75" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="90" y1="59" x2="90" y2="75" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="95" y1="59" x2="95" y2="75" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="100" y1="59" x2="100" y2="75" stroke="${D(b,40)}" stroke-width="1.5"/>
  <!-- Upright handlebars -->
  <line x1="106" y1="26" x2="130" y2="24" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <rect x="126" y="22" width="8" height="5" rx="2" fill="#222"/>
  <rect x="104" y="22" width="8" height="5" rx="2" fill="#222"/>
  <!-- Round headlight -->
  <circle cx="122" cy="44" r="12" fill="#222"/>
  <circle cx="122" cy="44" r="9" fill="${L(a,60)}"/>
  <circle cx="122" cy="44" r="5" fill="rgba(255,255,220,0.9)"/>
  <!-- Exhausts (dual, upswept) -->
  <path d="M86,78 Q75,82 65,88 Q57,92 52,90" stroke="#aaa" stroke-width="5" fill="none" stroke-linecap="round"/>
  <ellipse cx="51" cy="90" rx="5" ry="3" fill="#444"/>
  <path d="M86,82 Q76,86 66,92 Q58,96 53,94" stroke="#999" stroke-width="4" fill="none" stroke-linecap="round"/>
  <!-- Mudguard (front) -->
  <path d="M108,68 Q116,62 124,68 Q120,76 114,76 Z" fill="${D(b,15)}"/>
  ${bigWheel(60,88,20,a)}
  ${bigWheel(116,88,20,a)}
  </svg>`;
}

function svgMiniMoto(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="155" height="90" viewBox="0 0 155 90" xmlns="http://www.w3.org/2000/svg">
  <!-- Very small, compact pitbike/mini moto, tiny wheels -->
  <!-- Compact frame -->
  <line x1="52" y1="52" x2="96" y2="44" stroke="${D(b,10)}" stroke-width="4" stroke-linecap="round"/>
  <line x1="52" y1="52" x2="54" y2="72" stroke="${D(b,10)}" stroke-width="4" stroke-linecap="round"/>
  <line x1="54" y1="62" x2="96" y2="52" stroke="${D(b,15)}" stroke-width="2.5"/>
  <line x1="96" y1="44" x2="100" y2="72" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <line x1="96" y1="44" x2="100" y2="28" stroke="#777" stroke-width="3" stroke-linecap="round"/>
  <!-- Small round tank -->
  <ellipse cx="80" cy="48" rx="18" ry="9" fill="${b}"/>
  <ellipse cx="80" cy="46" rx="12" ry="5" fill="rgba(255,255,255,0.25)"/>
  <!-- Small seat -->
  <rect x="48" y="44" width="30" height="8" rx="4" fill="${D(b,25)}"/>
  <rect x="48" y="43" width="30" height="5" rx="3" fill="${D(b,10)}"/>
  <!-- Tiny engine -->
  <rect x="68" y="52" width="24" height="18" rx="2" fill="${D(b,10)}"/>
  <rect x="70" y="54" width="20" height="12" rx="1" fill="${a}" opacity="0.45"/>
  <!-- Small handlebars -->
  <line x1="96" y1="28" x2="112" y2="26" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <rect x="108" y="24" width="6" height="4" rx="2" fill="#222"/>
  <rect x="96" y="24" width="6" height="4" rx="2" fill="#222"/>
  <!-- Tiny headlight -->
  <circle cx="106" cy="38" r="8" fill="#222"/>
  <circle cx="106" cy="38" r="6" fill="${L(a,60)}"/>
  <circle cx="106" cy="38" r="3" fill="rgba(255,255,220,0.9)"/>
  <!-- Exhaust (small) -->
  <path d="M74,68 Q65,72 58,76 Q52,78 50,76" stroke="#999" stroke-width="4" fill="none" stroke-linecap="round"/>
  <ellipse cx="49" cy="76" rx="4" ry="2.5" fill="#444"/>
  <!-- Small wheels (13px) -->
  ${wheel(54,76,14,a,'mm',0)}
  ${wheel(100,76,14,a,'mm',1)}
  </svg>`;
}

function svgEnduroBike(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="188" height="112" viewBox="0 0 188 112" xmlns="http://www.w3.org/2000/svg">
  <!-- Tall adventure bike, panniers on sides, high mudguard, rally style -->
  <!-- Frame -->
  <line x1="60" y1="58" x2="118" y2="46" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="60" y1="58" x2="62" y2="86" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="62" y1="72" x2="118" y2="58" stroke="${D(b,15)}" stroke-width="3"/>
  <line x1="118" y1="46" x2="124" y2="86" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <line x1="118" y1="46" x2="122" y2="18" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <!-- Side panniers -->
  <rect x="34" y="60" width="26" height="28" rx="3" fill="${D(b,20)}"/>
  <rect x="36" y="62" width="22" height="24" rx="2" fill="${D(b,10)}" opacity="0.7"/>
  <circle cx="57" cy="74" r="4" fill="#666"/>
  <rect x="148" y="60" width="24" height="28" rx="3" fill="${D(b,20)}"/>
  <rect x="150" y="62" width="20" height="24" rx="2" fill="${D(b,10)}" opacity="0.7"/>
  <circle cx="167" cy="74" r="4" fill="#666"/>
  <!-- Tall windscreen / beak -->
  <path d="M116,18 Q122,8 134,10 Q140,14 138,24 L122,28 Z" fill="rgba(160,220,255,0.5)"/>
  <!-- Rally tank (angular) -->
  <path d="M60,56 Q72,38 100,36 Q118,36 120,46 L118,58 L60,62 Z" fill="${b}"/>
  <path d="M68,54 Q78,42 100,40 Q112,40 116,46 Z" fill="rgba(255,255,255,0.18)"/>
  <!-- Seat (tall/narrow) -->
  <rect x="52" y="54" width="15" height="30" rx="4" fill="${D(b,25)}"/>
  <!-- Engine -->
  <rect x="78" y="58" width="36" height="26" rx="3" fill="${D(b,10)}"/>
  <rect x="81" y="61" width="30" height="18" rx="2" fill="${a}" opacity="0.35"/>
  <!-- High exhaust (upswept to right) -->
  <path d="M86,82 Q78,88 70,96 Q63,102 58,100" stroke="#aaa" stroke-width="5" fill="none" stroke-linecap="round"/>
  <path d="M86,87 Q79,94 72,100" stroke="#999" stroke-width="4" fill="none" stroke-linecap="round"/>
  <!-- Rally headlight (square) -->
  <rect x="122" y="24" width="22" height="16" rx="3" fill="#111"/>
  <rect x="124" y="26" width="18" height="12" rx="2" fill="${L(a,60)}" opacity="0.9"/>
  <rect x="127" y="28" width="10" height="7" rx="1" fill="rgba(255,255,220,0.9)"/>
  <!-- Wide handlebars -->
  <line x1="112" y1="18" x2="148" y2="16" stroke="#888" stroke-width="3.5" stroke-linecap="round"/>
  <rect x="144" y="14" width="8" height="5" rx="2" fill="#222"/>
  <rect x="110" y="14" width="8" height="5" rx="2" fill="#222"/>
  <!-- Tall front mudguard -->
  <path d="M116,58 Q124,48 128,58 Q128,70 124,75 Q120,76 116,68 Z" fill="${D(b,15)}"/>
  ${bigWheel(62,92,22,a)}
  ${bigWheel(124,92,22,a)}
  </svg>`;
}

function svgCafeRacer(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="180" height="100" viewBox="0 0 180 100" xmlns="http://www.w3.org/2000/svg">
  <!-- Retro cafe racer: elongated tank, low clip-ons, seat hump, round headlight -->
  <!-- Frame -->
  <line x1="55" y1="56" x2="120" y2="48" stroke="${D(b,10)}" stroke-width="4" stroke-linecap="round"/>
  <line x1="55" y1="56" x2="57" y2="80" stroke="${D(b,10)}" stroke-width="4" stroke-linecap="round"/>
  <line x1="57" y1="68" x2="120" y2="56" stroke="${D(b,15)}" stroke-width="3"/>
  <line x1="120" y1="48" x2="124" y2="80" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <line x1="120" y1="48" x2="124" y2="26" stroke="#777" stroke-width="3.5" stroke-linecap="round"/>
  <!-- Long elongated tank (cafe racer) -->
  <path d="M55,54 Q68,36 105,34 Q122,34 124,48 L120,56 L55,62 Z" fill="${b}"/>
  <path d="M65,52 Q76,40 105,38 Q118,38 120,46 Z" fill="rgba(255,255,255,0.2)"/>
  <!-- Pinstripe on tank -->
  <path d="M68,55 Q88,44 120,48" stroke="${a}" stroke-width="1.5" fill="none" opacity="0.7"/>
  <!-- Seat hump (cafe racer signature) -->
  <path d="M38,56 Q46,44 58,44 Q64,44 64,56 Q64,68 58,70 Q46,70 38,64 Z" fill="${D(b,20)}"/>
  <!-- Low clip-on bars -->
  <line x1="118" y1="28" x2="134" y2="30" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <rect x="130" y="28" width="7" height="4" rx="2" fill="#222"/>
  <!-- Round headlight (classic) -->
  <circle cx="130" cy="44" r="13" fill="#1a1a1a"/>
  <circle cx="130" cy="44" r="10" fill="${L(a,60)}"/>
  <circle cx="130" cy="44" r="6" fill="rgba(255,255,220,0.9)"/>
  <!-- Fender ring -->
  <circle cx="130" cy="44" r="12" fill="none" stroke="#888" stroke-width="2"/>
  <!-- Exhaust (classic wrapped pipes) -->
  <path d="M90,70 Q78,76 65,82 Q55,86 50,84" stroke="#bbb" stroke-width="5" fill="none" stroke-linecap="round"/>
  <ellipse cx="49" cy="84" rx="4" ry="2.5" fill="#555"/>
  <!-- Heat wrap texture -->
  <path d="M58,81 Q62,76 66,80" stroke="#888" stroke-width="1" fill="none"/>
  <path d="M64,82 Q68,77 72,81" stroke="#888" stroke-width="1" fill="none"/>
  <path d="M70,83 Q74,78 78,82" stroke="#888" stroke-width="1" fill="none"/>
  <!-- Small taillight -->
  <rect x="38" y="58" width="5" height="4" rx="1" fill="rgba(220,30,30,0.9)"/>
  <!-- Rearset pegs (high) -->
  <line x1="72" y1="72" x2="64" y2="76" stroke="#888" stroke-width="2.5"/>
  ${wheel(57,84,18,a,'cr',0)}
  ${wheel(124,84,17,a,'cr',1)}
  </svg>`;
}

function svgBMX(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="155" height="95" viewBox="0 0 155 95" xmlns="http://www.w3.org/2000/svg">
  <!-- BMX: small fat frame, no motor, thick tires, pegs, no seat (trick style) -->
  <!-- Thick tubular frame (diamond) -->
  <line x1="50" y1="54" x2="90" y2="40" stroke="${b}" stroke-width="6" stroke-linecap="round"/>
  <line x1="50" y1="54" x2="52" y2="76" stroke="${b}" stroke-width="6" stroke-linecap="round"/>
  <line x1="90" y1="40" x2="92" y2="76" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <line x1="90" y1="40" x2="90" y2="22" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <!-- Chain stay -->
  <line x1="50" y1="56" x2="90" y2="54" stroke="${D(b,10)}" stroke-width="4"/>
  <!-- Seat stay -->
  <line x1="50" y1="54" x2="92" y2="70" stroke="${D(b,10)}" stroke-width="3.5"/>
  <!-- Seat tube (with no seat, just stump) -->
  <line x1="68" y1="40" x2="68" y2="56" stroke="${b}" stroke-width="5" stroke-linecap="round"/>
  <!-- Tiny saddle (minimal) -->
  <ellipse cx="68" cy="38" rx="8" ry="3" fill="#222"/>
  <!-- Handle bars (wide BMX) -->
  <line x1="82" y1="22" x2="116" y2="18" stroke="#888" stroke-width="4" stroke-linecap="round"/>
  <line x1="82" y1="22" x2="90" y2="40" stroke="#666" stroke-width="3" stroke-linecap="round"/>
  <rect x="112" y="16" width="8" height="5" rx="2" fill="#222"/>
  <rect x="80" y="16" width="8" height="5" rx="2" fill="#222"/>
  <!-- Crossbar -->
  <line x1="86" y1="26" x2="110" y2="22" stroke="#666" stroke-width="2.5"/>
  <!-- Pegs (4 pegs) -->
  <rect x="38" y="73" width="12" height="5" rx="2" fill="#aaa"/>
  <rect x="96" y="73" width="12" height="5" rx="2" fill="#aaa"/>
  <rect x="38" y="52" width="12" height="5" rx="2" fill="#aaa"/>
  <rect x="96" y="52" width="12" height="5" rx="2" fill="#aaa"/>
  <!-- Chain (simple line) -->
  <line x1="68" y1="58" x2="50" y2="76" stroke="#555" stroke-width="2" stroke-dasharray="3 2"/>
  <line x1="68" y1="58" x2="92" y2="76" stroke="#555" stroke-width="2" stroke-dasharray="3 2"/>
  <!-- Chain sprocket -->
  <circle cx="68" cy="58" r="8" fill="none" stroke="#666" stroke-width="2.5"/>
  <circle cx="68" cy="58" r="4" fill="#444"/>
  <!-- Spoke brakes -->
  <path d="M80,36 Q88,30 94,36" stroke="#888" stroke-width="2" fill="none"/>
  <!-- Fat tires (small wheels but thick) -->
  ${wheel(50,78,17,a,'bx',0)}
  ${wheel(92,78,17,a,'bx',1)}
  </svg>`;
}

function svgCruiserBike(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="195" height="100" viewBox="0 0 195 100" xmlns="http://www.w3.org/2000/svg">
  <!-- Long, low cruiser: huge fenders, forward controls, wide bars, teardrop tank -->
  <!-- Long low frame -->
  <line x1="45" y1="62" x2="140" y2="52" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="45" y1="62" x2="50" y2="80" stroke="${D(b,10)}" stroke-width="5" stroke-linecap="round"/>
  <line x1="140" y1="52" x2="146" y2="80" stroke="#777" stroke-width="5" stroke-linecap="round"/>
  <line x1="140" y1="52" x2="142" y2="30" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <!-- Teardrop tank (classic) -->
  <path d="M82,50 Q94,38 118,38 Q136,38 140,52 L136,58 Q120,62 82,62 Z" fill="${b}"/>
  <path d="M92,50 Q100,42 118,42 Q130,42 134,50 Z" fill="rgba(255,255,255,0.22)"/>
  <!-- V-twin engine (large) -->
  <rect x="80" y="56" width="46" height="22" rx="4" fill="${D(b,10)}"/>
  <polygon points="86,56 98,42 100,56" fill="${b}" opacity="0.9"/>
  <polygon points="106,56 120,42 122,56" fill="${b}" opacity="0.9"/>
  <!-- Engine fins -->
  <line x1="88" y1="44" x2="88" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="92" y1="42" x2="92" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="96" y1="42" x2="96" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="108" y1="42" x2="108" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="112" y1="42" x2="112" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <line x1="116" y1="44" x2="116" y2="56" stroke="${D(b,40)}" stroke-width="1.5"/>
  <!-- Wide seat (long) -->
  <rect x="38" y="56" width="48" height="10" rx="5" fill="${D(b,30)}"/>
  <rect x="38" y="54" width="48" height="6" rx="4" fill="${D(b,12)}"/>
  <!-- Large rear fender -->
  <path d="M22,62 Q26,44 46,46 Q58,46 58,62 Q58,80 46,82 Q26,82 22,70 Z" fill="${D(b,15)}"/>
  <!-- Chrome fender trim -->
  <path d="M24,66 Q26,50 46,50 Q55,50 55,62" stroke="#ccc" stroke-width="1.5" fill="none"/>
  <!-- Front fender (large) -->
  <path d="M136,68 Q140,55 148,54 Q158,55 158,68 Q158,78 148,80 Q138,80 136,72 Z" fill="${D(b,15)}"/>
  <!-- Forward controls -->
  <line x1="80" y1="76" x2="56" y2="84" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <rect x="52" y="82" width="8" height="5" rx="2" fill="#666"/>
  <!-- Wide pullback bars -->
  <line x1="136" y1="30" x2="125" y2="22" stroke="#888" stroke-width="3.5" stroke-linecap="round"/>
  <line x1="125" y1="22" x2="155" y2="22" stroke="#aaa" stroke-width="4" stroke-linecap="round"/>
  <circle cx="123" cy="22" r="5" fill="#333"/>
  <circle cx="157" cy="22" r="5" fill="#333"/>
  <!-- Chrome exhaust (long) -->
  <path d="M124,76 Q100,82 78,82 Q55,82 38,80" stroke="#bbb" stroke-width="6" fill="none" stroke-linecap="round"/>
  <ellipse cx="37" cy="80" rx="5" ry="3" fill="#555"/>
  <!-- Headlight (round, chrome) -->
  <circle cx="152" cy="44" r="12" fill="#222"/>
  <circle cx="152" cy="44" r="9" fill="${L(a,60)}"/>
  <circle cx="152" cy="44" r="5" fill="rgba(255,255,220,0.9)"/>
  <circle cx="152" cy="44" r="11" fill="none" stroke="#aaa" stroke-width="2"/>
  <!-- Taillight -->
  <circle cx="40" cy="60" r="5" fill="rgba(220,30,30,0.9)"/>
  ${wheel(46,84,18,a,'cu',0)}
  ${wheel(148,84,17,a,'cu',1)}
  </svg>`;
}

function svgSupermoto(v) {
  const b=v.palette.body,a=v.palette.accent;
  return `<svg width="175" height="100" viewBox="0 0 175 100" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sm_b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${L(b,60)}"/><stop offset="100%" stop-color="${D(b,20)}"/></linearGradient>
  </defs>
  <!-- Motard/supermoto: minimal fairing, flat track bars, SM wheels -->
  <!-- Trellis frame (visible triangles) -->
  <line x1="55" y1="54" x2="104" y2="44" stroke="${a}" stroke-width="3" stroke-linecap="round"/>
  <line x1="55" y1="54" x2="60" y2="78" stroke="${a}" stroke-width="3" stroke-linecap="round"/>
  <line x1="75" y1="54" x2="60" y2="78" stroke="${a}" stroke-width="2.5"/>
  <line x1="75" y1="54" x2="60" y2="54" stroke="${a}" stroke-width="2"/>
  <line x1="104" y1="44" x2="110" y2="78" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <line x1="104" y1="44" x2="108" y2="24" stroke="#777" stroke-width="4" stroke-linecap="round"/>
  <!-- Small tank/fairing -->
  <path d="M56,52 Q70,36 98,36 Q110,36 112,48 L104,54 L56,58 Z" fill="url(#sm_b)"/>
  <path d="M66,50 Q76,40 98,40 Q108,40 108,46 Z" fill="rgba(255,255,255,0.2)"/>
  <!-- Number board -->
  <rect x="112" y="32" width="24" height="16" rx="2" fill="${a}"/>
  <text x="124" y="43" text-anchor="middle" font-size="8" font-weight="bold" fill="${b}" font-family="Orbitron,monospace">1</text>
  <!-- Compact seat (narrow) -->
  <rect x="46" y="48" width="16" height="12" rx="4" fill="#333"/>
  <rect x="46" y="47" width="16" height="7" rx="3" fill="#444"/>
  <!-- Flat track handlebars -->
  <line x1="100" y1="24" x2="126" y2="22" stroke="#888" stroke-width="3" stroke-linecap="round"/>
  <rect x="122" y="20" width="7" height="4" rx="2" fill="#222"/>
  <rect x="100" y="20" width="7" height="4" rx="2" fill="#222"/>
  <!-- SM headlight (oval) -->
  <ellipse cx="118" cy="42" rx="10" ry="8" fill="#111"/>
  <ellipse cx="118" cy="42" rx="7" ry="5" fill="${L(a,60)}" opacity="0.9"/>
  <ellipse cx="118" cy="42" rx="4" ry="3" fill="rgba(255,255,220,0.9)"/>
  <!-- Radiator (visible) -->
  <rect x="100" y="46" width="14" height="14" rx="2" fill="#222"/>
  <line x1="102" y1="48" x2="102" y2="58" stroke="#555" stroke-width="1.5"/>
  <line x1="106" y1="48" x2="106" y2="58" stroke="#555" stroke-width="1.5"/>
  <line x1="110" y1="48" x2="110" y2="58" stroke="#555" stroke-width="1.5"/>
  <!-- Exhaust (short, upswept) -->
  <path d="M80,70 Q70,78 62,84 Q55,88 50,86" stroke="#bbb" stroke-width="5" fill="none" stroke-linecap="round"/>
  <ellipse cx="49" cy="86" rx="5" ry="3" fill="#444"/>
  <!-- Rear sprocket visible -->
  <circle cx="60" cy="78" r="8" fill="none" stroke="${a}" stroke-width="2" stroke-dasharray="4 2"/>
  <!-- Taillight (LED) -->
  <rect x="46" y="52" width="3" height="6" fill="${a}" opacity="0.9"/>
  <!-- Rearset footpegs -->
  <line x1="80" y1="74" x2="68" y2="80" stroke="#888" stroke-width="2.5"/>
  ${wheel(60,84,18,a,'sm',0)}
  ${wheel(110,84,17,a,'sm',1)}
  </svg>`;
}

// ─── Dispatch table ───────────────────────────────────────────────────────────
const svgMap = {
  rusty_hatchback: svgRustyHatchback,
  monster_truck:   svgMonsterTruck,
  rally_racer:     svgRallyRacer,
  muscle_car:      svgMuscleCar,
  jeep_4x4:        svgJeep4x4,
  sports_coupe:    svgSportsCoupe,
  dune_buggy:      svgDuneBuggy,
  tank:            svgTank,
  pickup_truck:    svgPickupTruck,
  electric_car:    svgElectricCar,
  dirt_bike:       svgDirtBike,
  chopper:         svgChopper,
  sport_bike:      svgSportBike,
  scrambler:       svgScrambler,
  mini_moto:       svgMiniMoto,
  enduro_bike:     svgEnduroBike,
  cafe_racer:      svgCafeRacer,
  bmx:             svgBMX,
  cruiser_bike:    svgCruiserBike,
  supermoto:       svgSupermoto,
};

const statColors = {
  speed:          'linear-gradient(90deg,#f7971e,#ffd200)',
  acceleration:   'linear-gradient(90deg,#11998e,#38ef7d)',
  fuelEfficiency: 'linear-gradient(90deg,#36d1dc,#5b86e5)',
  grip:           'linear-gradient(90deg,#a18cd1,#fbc2eb)',
  traction:       'linear-gradient(90deg,#ff512f,#dd2476)',
};

function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};}
function glowColor(v){const{r,g,b}=hexToRgb(v.palette.body);return `rgba(${r},${g},${b},0.22)`;}
function cardGradient(v){return `linear-gradient(135deg, ${v.palette.body}, ${v.palette.accent})`;}

function createCard(v) {
  const card = document.createElement('div');
  card.className = `card ${v.defaultUnlocked ? '' : 'locked'}`;
  card.dataset.type = v.type;
  card.style.setProperty('--card-glow', glowColor(v));
  card.style.setProperty('--card-glow-color', `radial-gradient(ellipse, ${glowColor(v)} 0%, transparent 70%)`);

  const statKeys = ['speed','acceleration','fuelEfficiency','grip','traction'];
  const statLabels = {speed:'Speed',acceleration:'Accel',fuelEfficiency:'Efficiency',grip:'Grip',traction:'Traction'};

  const svgFn = svgMap[v.id];
  const svgHTML = svgFn ? svgFn(v) : '<svg width="180" height="100"></svg>';

  card.innerHTML = `
    <div class="card-accent-bar" style="background:${cardGradient(v)}"></div>
    <div class="vehicle-stage">
      ${v.defaultUnlocked ? '' : '<div class="lock-overlay">🔒</div>'}
      <div class="vehicle-svg">${svgHTML}</div>
    </div>
    <div class="card-body">
      <div class="card-header">
        <div>
          <div class="vehicle-name">${v.name}</div>
          <div class="vehicle-type">${v.type === 'car' ? '🚗 Car' : '🏍️ Bike'}</div>
        </div>
        <div class="cost-badge ${v.cost === 0 ? 'free' : 'paid'}">
          ${v.cost === 0 ? 'FREE' : `⚡ ${v.cost}`}
        </div>
      </div>
      <div class="stats">
        ${statKeys.map(k => `
          <div class="stat">
            <div class="stat-label">${statLabels[k]}</div>
            <div class="stat-bar-track">
              <div class="stat-bar-fill" style="width:${v.stats[k]*10}%;background:${statColors[k]}"></div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  return card;
}

const grid = document.getElementById('grid');
if (grid) {
  vehicles.forEach(v => grid.appendChild(createCard(v)));
}

function filter(type, event) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (event) event.target.classList.add('active');
  document.querySelectorAll('.card').forEach(card => {
    if (type === 'all' || card.dataset.type === type) {
      card.classList.remove('hidden');
    } else {
      card.classList.add('hidden');
    }
  });
}

function getDefaultVehicleId() {
  return "rusty_hatchback";
}

// Expose filter to global scope for onclick handlers in vehicles.html
if (typeof window !== 'undefined') window.filter = filter;
// ===== levels.js =====
// levels.js - level metadata and helpers

const levels = [
  // Easy 1–10
  level(1, "Country Road", "easy", 2600, 0.7, 80, 0.18, 0.09, 0.05, 1.2, "pastelFields"),
  level(2, "Grassy Hill", "easy", 2700, 0.8, 90, 0.2, 0.09, 0.05, 1.2, "pastelHills"),
  level(3, "Sunny Beach", "easy", 2600, 0.6, 60, 0.19, 0.1, 0.05, 1.1, "beach"),
  level(4, "Farm Fields", "easy", 2600, 0.7, 70, 0.18, 0.09, 0.05, 1.2, "farm"),
  level(5, "Seaside Cliffs", "easy", 2800, 0.9, 100, 0.17, 0.08, 0.05, 1.2, "cliffs"),
  level(6, "Meadow Run", "easy", 2600, 0.7, 70, 0.18, 0.09, 0.05, 1.2, "meadow"),
  level(7, "Rolling Plains", "easy", 2700, 0.8, 90, 0.17, 0.09, 0.05, 1.2, "plains"),
  level(8, "Orchard Path", "easy", 2600, 0.7, 70, 0.18, 0.09, 0.05, 1.2, "orchard"),
  level(9, "Lakeside Drive", "easy", 2700, 0.7, 70, 0.18, 0.08, 0.05, 1.2, "lake"),
  level(10, "Gentle Forest", "easy", 2800, 0.8, 80, 0.17, 0.08, 0.05, 1.2, "forest"),
  // Normal 11–20
  level(11, "Rocky Mountain", "normal", 3200, 1.1, 120, 0.15, 0.07, 0.05, 1.3, "mountain"),
  level(12, "Desert Dunes", "normal", 3300, 1.0, 140, 0.15, 0.07, 0.06, 1.2, "desert"),
  level(13, "Jungle Trail", "normal", 3200, 1.0, 110, 0.15, 0.07, 0.05, 1.3, "jungle"),
  level(14, "Snowy Pass", "normal", 3200, 1.0, 120, 0.14, 0.06, 0.05, 1.25, "snow"),
  level(15, "Canyon Run", "normal", 3300, 1.1, 130, 0.14, 0.06, 0.05, 1.3, "canyon"),
  level(16, "Volcanic Ridge", "normal", 3400, 1.2, 140, 0.13, 0.06, 0.06, 1.35, "volcano"),
  level(17, "Arctic Tundra", "normal", 3400, 1.1, 130, 0.13, 0.06, 0.05, 1.2, "arctic"),
  level(18, "Rainforest Rush", "normal", 3300, 1.0, 120, 0.14, 0.06, 0.06, 1.3, "rainforest"),
  level(19, "Muddy Swamp", "normal", 3200, 1.0, 120, 0.15, 0.07, 0.06, 1.3, "swamp"),
  level(20, "Stormy Cliffs", "normal", 3500, 1.1, 140, 0.13, 0.05, 0.06, 1.35, "storm"),
  // Hard 21–25
  level(21, "Asteroid Field", "hard", 3800, 1.4, 170, 0.11, 0.05, 0.07, 0.8, "asteroid"),
  level(22, "Underground Cave", "hard", 3600, 1.3, 160, 0.11, 0.05, 0.07, 1.4, "cave"),
  level(23, "Underwater Tunnel", "hard", 3600, 1.2, 150, 0.11, 0.05, 0.07, 0.7, "underwater"),
  level(24, "Space Launch", "hard", 3800, 1.4, 170, 0.10, 0.05, 0.07, 0.6, "space"),
  level(25, "Lava World", "hard", 3800, 1.4, 170, 0.10, 0.05, 0.07, 1.5, "lava"),
  // Advanced 26–30
  level(26, "Nightmare Highway", "advanced", 4000, 1.5, 180, 0.09, 0.04, 0.08, 1.3, "nightmare"),
  level(27, "Chaos Canyon", "advanced", 4000, 1.5, 180, 0.09, 0.04, 0.08, 1.4, "chaos"),
  level(28, "Zero Gravity Moon", "advanced", 4000, 1.5, 180, 0.09, 0.04, 0.08, 0.4, "moon"),
  level(29, "Inferno Descent", "advanced", 4000, 1.5, 190, 0.09, 0.04, 0.08, 1.6, "inferno"),
  level(30, "The Final Summit", "advanced", 4200, 1.6, 200, 0.08, 0.04, 0.08, 1.5, "final"),
];

function level(
  id,
  name,
  difficulty,
  length,
  terrainFrequency,
  terrainAmplitude,
  coinDensity,
  fuelDensity,
  boostDensity,
  gravity,
  theme
) {
  return {
    id,
    name,
    difficulty,
    length,
    terrainFrequency,
    terrainAmplitude,
    coinDensity,
    fuelDensity,
    boostDensity,
    gravity,
    theme,
    seed: id * 9973,
  };
}

function getLevelById(id) {
  return levels.find((l) => l.id === id) || levels[0];
}


// ===== platform.js =====
// platform.js - Platform detection and SDK integration for Poki.com and CrazyGames.com

class PlatformIntegration {
  constructor() {
    this.platform = this.detectPlatform();
    this.sdk = null;
    this.initialized = false;
    this.audioManager = null;
  }

  detectPlatform() {
    try {
      // Check if Poki SDK is loaded
      if (typeof PokiSDK !== 'undefined') {
        return 'poki';
      }
      // Check if CrazyGames SDK is loaded
      if (typeof CrazySDK !== 'undefined') {
        return 'crazygames';
      }
      // Check if running on Poki (safe check)
      try {
        if (window.parent !== window && window.parent.location.hostname.includes('poki.com')) {
          return 'poki';
        }
      } catch (e) {
        // Cross-origin, ignore
      }
      // Check if running on CrazyGames (safe check)
      try {
        if (window.parent !== window && window.parent.location.hostname.includes('crazygames.com')) {
          return 'crazygames';
        }
      } catch (e) {
        // Cross-origin, ignore
      }
    } catch (error) {
      console.warn('Platform detection error:', error);
    }
    return 'standalone';
  }

  async init(audioManager) {
    this.audioManager = audioManager;
    
    if (this.platform === 'poki') {
      await this.initPoki();
    } else if (this.platform === 'crazygames') {
      await this.initCrazyGames();
    }
    
    this.initialized = true;
    return this.platform;
  }

  async initPoki() {
    return new Promise((resolve) => {
      if (typeof PokiSDK === 'undefined') {
        console.warn('Poki SDK not loaded');
        resolve();
        return;
      }

      PokiSDK.init().then(() => {
        console.log('Poki SDK initialized');
        this.sdk = PokiSDK;
        PokiSDK.gameLoadingFinished();
        resolve();
      }).catch((err) => {
        console.error('Poki SDK init failed:', err);
        resolve();
      });
    });
  }

  async initCrazyGames() {
    return new Promise((resolve) => {
      if (typeof CrazySDK === 'undefined') {
        console.warn('CrazyGames SDK not loaded');
        resolve();
        return;
      }

      CrazySDK.init().then(() => {
        console.log('CrazyGames SDK initialized');
        this.sdk = CrazySDK;
        resolve();
      }).catch((err) => {
        console.error('CrazyGames SDK init failed:', err);
        resolve();
      });
    });
  }

  gameplayStart() {
    if (!this.initialized) return;
    
    if (this.platform === 'poki' && this.sdk) {
      this.sdk.gameplayStart();
    }
  }

  gameplayStop() {
    if (!this.initialized) return;
    
    if (this.platform === 'poki' && this.sdk) {
      this.sdk.gameplayStop();
    }
  }

  requestInterstitialAd(callback) {
    if (!this.initialized || !this.sdk) {
      // Fallback: just call callback immediately
      callback();
      return;
    }

    if (this.platform === 'poki') {
      // Poki commercial break - may or may not show an ad
      this.sdk.commercialBreak().then(() => {
        callback();
      }).catch(() => {
        callback();
      });
    } else if (this.platform === 'crazygames') {
      // CrazyGames midgame ad
      this.sdk.ad.requestAd({
        adStarted: () => {
          // Pause audio/game when ad starts
          if (this.audioManager) {
            this.audioManager.suspend();
          }
          window.dispatchEvent(new Event('game:ad-started'));
        },
        adFinished: () => {
          // Resume audio/game when ad finishes
          if (this.audioManager) {
            this.audioManager.resume();
          }
          window.dispatchEvent(new Event('game:ad-finished'));
          callback();
        },
        adError: () => {
          // Ad failed to load, continue anyway
          callback();
        }
      });
    } else {
      // Standalone: no ads
      callback();
    }
  }

  requestRewardedAd(options = {}) {
    return new Promise((resolve) => {
      if (!this.initialized || !this.sdk) {
        resolve({ success: false });
        return;
      }

      if (this.platform === 'poki') {
        this.sdk.rewardedBreak({
          size: options.size || 'medium',
          onStart: () => {
            if (this.audioManager) {
              this.audioManager.suspend();
            }
            window.dispatchEvent(new Event('game:ad-started'));
          }
        }).then((success) => {
          if (this.audioManager) {
            this.audioManager.resume();
          }
          window.dispatchEvent(new Event('game:ad-finished'));
          resolve({ success });
        }).catch(() => {
          if (this.audioManager) {
            this.audioManager.resume();
          }
          resolve({ success: false });
        });
      } else if (this.platform === 'crazygames') {
        this.sdk.ad.requestRewardedAd({
          adStarted: () => {
            if (this.audioManager) {
              this.audioManager.suspend();
            }
            window.dispatchEvent(new Event('game:ad-started'));
          },
          adFinished: (adWatched) => {
            if (this.audioManager) {
              this.audioManager.resume();
            }
            window.dispatchEvent(new Event('game:ad-finished'));
            resolve({ success: adWatched });
          },
          adError: () => {
            if (this.audioManager) {
              this.audioManager.resume();
            }
            resolve({ success: false });
          }
        });
      } else {
        resolve({ success: false });
      }
    });
  }

  getPlatform() {
    return this.platform;
  }

  isPlatform() {
    return this.platform !== 'standalone';
  }
}

// ===== physics.js =====
// Physics and terrain setup using Matter.js

const {
  Engine,
  World,
  Bodies,
  Body,
  Composite,
  Constraint,
  Events,
} = Matter;

function createEngine() {
  const engine = Engine.create();
  engine.timing.timeScale = 1;
  return engine;
}

function createWorld(engine) {
  return engine.world;
}

function setWorldGravity(world, gravity) {
  world.gravity.y = gravity;
}

function createTerrainForLevel(world, level) {
  const segments = [];
  const coins = [];
  const fuels = [];
  const boosts = [];

  const length = level.length;
  const step = 40;
  const baseY = 400;

  let x = 0;
  let lastY = baseY;

  const rng = makeRng(level.seed);

  while (x < length) {
    const nx = x / length;
    const noise =
      perlin1D(nx * level.terrainFrequency, rng) * level.terrainAmplitude;
    const y = baseY + noise;

    const body = Bodies.rectangle(
      x + step / 2,
      (lastY + y) / 2,
      step * 1.1,
      Math.abs(y - lastY) + 20,
      {
        isStatic: true,
        friction: 0.9,
        render: { visible: false },
      }
    );

    Body.rotate(
      body,
      Math.atan2(y - lastY, step)
    );

    World.add(world, body);
    segments.push(body);

    if (rng() < level.coinDensity && x > 100 && x < length - 200) {
      const cy = Math.min(lastY, y) - 40 - rng() * 30;
      const coin = Bodies.circle(x + step / 2, cy, 10, {
        isSensor: true,
        isStatic: true,
        label: "coin",
      });
      World.add(world, coin);
      coins.push(coin);
    }

    if (rng() < level.fuelDensity && x > 200 && x < length - 400) {
      const fy = Math.min(lastY, y) - 30;
      const fuel = Bodies.rectangle(x + step / 2, fy, 24, 32, {
        isSensor: true,
        isStatic: true,
        label: "fuel",
      });
      World.add(world, fuel);
      fuels.push(fuel);
    }

    if (rng() < level.boostDensity && x > 200 && x < length - 400) {
      const by = Math.min(lastY, y) - 30;
      const boost = Bodies.rectangle(x + step / 2, by, 24, 24, {
        isSensor: true,
        isStatic: true,
        label: "boost",
      });
      World.add(world, boost);
      boosts.push(boost);
    }

    lastY = y;
    x += step;
  }

  const finishX = length;
  const finish = Bodies.rectangle(finishX, baseY - 120, 20, 200, {
    isStatic: true,
    isSensor: true,
    label: "finish",
  });
  World.add(world, finish);

  return {
    terrainBodies: segments,
    coinBodies: coins,
    fuelBodies: fuels,
    boostBodies: boosts,
    finishX,
  };
}

function attachVehicleToWorld(world, vehicle, level) {
  const x = 80;
  const y = 350;

  const chassis = Bodies.rectangle(x, y, vehicle.bodyWidth, vehicle.bodyHeight, {
    density: vehicle.physics.density,
    friction: 0.8,
    frictionAir: 0.02,
    restitution: 0.1,
    label: "chassis",
  });

  const wheelOffsetX = vehicle.wheelBase / 2;
  const wheelRadius = vehicle.wheelRadius;

  const wheelA = Bodies.circle(x - wheelOffsetX, y + vehicle.wheelYOffset, wheelRadius, {
    friction: 1.0,
    restitution: 0.1,
    label: "wheel",
  });

  const wheelB = Bodies.circle(x + wheelOffsetX, y + vehicle.wheelYOffset, wheelRadius, {
    friction: 1.0,
    restitution: 0.1,
    label: "wheel",
  });

  const suspensionStiffness = 0.8;

  const springA = Constraint.create({
    bodyA: chassis,
    pointA: { x: -wheelOffsetX, y: vehicle.wheelYOffset },
    bodyB: wheelA,
    stiffness: suspensionStiffness,
    damping: 0.3,
    length: vehicle.suspensionLength,
  });

  const springB = Constraint.create({
    bodyA: chassis,
    pointA: { x: wheelOffsetX, y: vehicle.wheelYOffset },
    bodyB: wheelB,
    stiffness: suspensionStiffness,
    damping: 0.3,
    length: vehicle.suspensionLength,
  });

  World.add(world, [chassis, wheelA, wheelB, springA, springB]);

  return {
    chassis,
    wheelA,
    wheelB,
    springA,
    springB,
  };
}

function stepPhysics(engine, world, vehicleInstance, runData, control, dt) {
  const { chassis, wheelA, wheelB } = vehicleInstance;
  const vehicle = runData.vehicle;

  const torqueBase = vehicle.stats.torque;
  const gasTorque = control.gas ? torqueBase : 0;
  const brakeTorque = control.brake ? -torqueBase * 0.6 : 0;
  const boostTorque = control.boost ? torqueBase * 1.5 : 0;

  const totalTorque = gasTorque + brakeTorque + boostTorque;

  Body.applyForce(wheelA, wheelA.position, {
    x: totalTorque / wheelA.circleRadius,
    y: 0,
  });
  Body.applyForce(wheelB, wheelB.position, {
    x: totalTorque / wheelB.circleRadius,
    y: 0,
  });

  const rpm =
    (Math.abs(wheelA.angularVelocity) + Math.abs(wheelB.angularVelocity)) * 20;

  const slopeFactor = Math.sin(chassis.angle);
  const fuelDrain =
    (Math.abs(totalTorque) * 0.00004 +
      0.03 * (1 + Math.abs(slopeFactor))) /
    vehicle.stats.fuelEfficiency;
  let fuel = Math.max(0, runData.fuel - fuelDrain * (dt * 60));

  let boost = runData.boost;
  let usedBoost = false;
  if (control.boost && boost > 0) {
    boost = Math.max(0, boost - 20 * dt);
    usedBoost = true;
  }

  Engine.update(engine, dt * 1000);

  let collectedCoins = 0;
  let collectedFuel = false;
  let collectedBoost = false;
  let ended = false;
  let reachedFinish = false;
  let cause = null;

  const vehicleX = chassis.position.x;
  const vehicleY = chassis.position.y;

  const bodies = Composite.allBodies(world);
  for (const body of bodies) {
    if (!body.isSensor) continue;
    const dx = body.position.x - vehicleX;
    const dy = body.position.y - vehicleY;
    const dist2 = dx * dx + dy * dy;
    if (dist2 > 60 * 60) continue;

    if (body.label === "coin") {
      World.remove(world, body);
      body.label = "collected";
      collectedCoins += 1;
    } else if (body.label === "fuel") {
      World.remove(world, body);
      body.label = "collected";
      fuel = Math.min(vehicle.stats.fuelCapacity, fuel + 30);
      collectedFuel = true;
    } else if (body.label === "boost") {
      World.remove(world, body);
      body.label = "collected";
      boost = Math.min(100, boost + 40);
      collectedBoost = true;
    } else if (body.label === "finish") {
      reachedFinish = true;
      ended = true;
      cause = "finish";
    }
  }

  const headPoint = {
    x: chassis.position.x,
    y: chassis.position.y - vehicle.bodyHeight / 2,
  };
  if (headPoint.y > 460 || chassis.angle > Math.PI * 0.8 || chassis.angle < -Math.PI * 0.8) {
    ended = true;
    cause = "flip";
  }

  if (fuel <= 0 && !ended) {
    ended = true;
    cause = "fuel";
  }

  const distance = Math.max(0, vehicleX);

  return {
    rpm,
    fuel,
    boost,
    collectedCoins,
    collectedFuel,
    collectedBoost,
    usedBoost,
    lowFuel: fuel < vehicle.stats.fuelCapacity * 0.2,
    distance,
    ended,
    reachedFinish,
    cause,
    finishX: runData.finishX,
  };
}

function makeRng(seed) {
  let s = seed >>> 0;
  return function () {
    s = (s * 1664525 + 1013904223) >>> 0;
    return s / 0xffffffff;
  };
}

function perlin1D(x, rng) {
  const x0 = Math.floor(x);
  const x1 = x0 + 1;
  const t = x - x0;
  const g0 = gradient(x0, rng);
  const g1 = gradient(x1, rng);
  const v0 = g0 * (x - x0);
  const v1 = g1 * (x - x1);
  const w = t * t * (3 - 2 * t);
  return v0 * (1 - w) + v1 * w;
}

const gradientCache = new Map();
function gradient(xi, rng) {
  if (gradientCache.has(xi)) return gradientCache.get(xi);
  const g = (rng() * 2 - 1);
  gradientCache.set(xi, g);
  return g;
}


// ===== renderer.js =====
// renderer.js — Canvas rendering for world, vehicle, terrain, pickups
// Enhanced version: each vehicle drawn to match its unique garage artwork
// 100% original code — free to publish (no copyright claims)

const { Composite } = Matter;

// ── Colour helpers (mirror vehicles.js) ──────────────────
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return { r, g, b };
}
function L(hex, a) {               // lighten
  const c = hexToRgb(hex);
  return `rgb(${Math.min(255,c.r+a)},${Math.min(255,c.g+a)},${Math.min(255,c.b+a)})`;
}
function D(hex, a) {               // darken
  const c = hexToRgb(hex);
  return `rgb(${Math.max(0,c.r-a)},${Math.max(0,c.g-a)},${Math.max(0,c.b-a)})`;
}
function A(hex, op) {              // with alpha
  const c = hexToRgb(hex);
  return `rgba(${c.r},${c.g},${c.b},${op})`;
}

class GameRenderer {
  constructor(ctx, world, particles) {
    this.ctx      = ctx;
    this.world    = world;
    this.particles= particles;
    this.width    = ctx.canvas.clientWidth  || ctx.canvas.width;
    this.height   = ctx.canvas.clientHeight || ctx.canvas.height;
    this._currentVehicle = null;
    // Cache pre-parsed Image objects for each vehicle id
    this._svgCache = {};
  }

  resize(width, height) {
    this.width  = width;
    this.height = height;
  }

  clearFrame() {
    const ctx = this.ctx;
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,this.width,this.height);
    this._drawBackground({ theme:'pastelFields', cameraX:0, cameraY:0 });
  }

  update(dt, { cameraX, cameraY, levelTheme, vehicle }) {
    this._currentVehicle = vehicle || this._currentVehicle;
    const ctx = this.ctx;
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,this.width,this.height);

    this._drawBackground({ theme:levelTheme, cameraX, cameraY });

    ctx.save();
    ctx.translate(this.width/2, this.height*0.6);

    const allBodies = Composite.allBodies(this.world);

    // ── Terrain ────────────────────────────────────────────
    ctx.fillStyle = '#202633';
    for (const body of allBodies) {
      if (!body.isStatic || body.isSensor) continue;
      ctx.save();
      ctx.translate(body.position.x - cameraX, body.position.y - cameraY);
      ctx.rotate(body.angle);
      const w = body.bounds.max.x - body.bounds.min.x;
      const h = body.bounds.max.y - body.bounds.min.y;
      this._drawRoundedRect(ctx, -w/2, -h/2, w, h, 8);
      ctx.fill();
      ctx.restore();
    }

    // ── Pickups / finish ────────────────────────────────────
    for (const body of allBodies) {
      if (body.isStatic && !body.isSensor) continue;
      if (!body.label) continue;
      const x = body.position.x - cameraX;
      const y = body.position.y - cameraY;
      if      (body.label==='coin')   this._drawCoin(ctx, x, y);
      else if (body.label==='fuel')   this._drawFuel(ctx, x, y);
      else if (body.label==='boost')  this._drawBoost(ctx, x, y);
      else if (body.label==='finish') this._drawFinishFlag(ctx, x, y);
    }

    // ── Vehicle ─────────────────────────────────────────────
    const vehicleBodies = allBodies.filter(
      b => b.label==='chassis' || b.label==='wheel'
    );
    this._drawVehicle(ctx, vehicleBodies, cameraX, cameraY, this._currentVehicle);

    this.particles.update(dt);
    this.particles.draw(ctx, cameraX, cameraY);

    ctx.restore();
  }

  // ── Low-level helpers ────────────────────────────────────
  _drawRoundedRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x+radius, y);
    ctx.lineTo(x+width-radius, y);
    ctx.quadraticCurveTo(x+width, y, x+width, y+radius);
    ctx.lineTo(x+width, y+height-radius);
    ctx.quadraticCurveTo(x+width, y+height, x+width-radius, y+height);
    ctx.lineTo(x+radius, y+height);
    ctx.quadraticCurveTo(x, y+height, x, y+height-radius);
    ctx.lineTo(x, y+radius);
    ctx.quadraticCurveTo(x, y, x+radius, y);
    ctx.closePath();
  }

  // ═══════════════════════════════════════════════════════════
  // VEHICLE DRAWING  — unique shape per vehicle id
  // ═══════════════════════════════════════════════════════════

  _drawVehicle(ctx, bodies, cameraX, cameraY, vehicle) {
    const chassis = bodies.find(b => b.label==='chassis');
    const wheels  = bodies.filter(b => b.label==='wheel');
    if (!chassis) return;

    const bod  = vehicle?.palette?.body   || '#888888';
    const acc  = vehicle?.palette?.accent || '#333333';
    const id   = vehicle?.id || '';
    const isBike = vehicle?.type === 'bike';

    // Draw wheels first (they sit behind body visually)
    for (const wheel of wheels) {
      ctx.save();
      ctx.translate(wheel.position.x - cameraX, wheel.position.y - cameraY);
      // Use wheel.angle for rotation (fixes wheel not rotating)
      ctx.rotate(wheel.angle || 0);
      const r = wheel.circleRadius;
      // Make wheels slightly larger for better look
      this._drawWheel(ctx, r * 1.08, acc, id === 'monster_truck' || id === 'jeep_4x4' ||
        id === 'dune_buggy' || id === 'dirt_bike' || id === 'scrambler' ||
        id === 'enduro_bike' || id === 'tank');
      ctx.restore();
    }

    // Draw chassis body with vehicle-specific shape
    ctx.save();
    ctx.translate(chassis.position.x - cameraX, chassis.position.y - cameraY);
    ctx.rotate(chassis.angle);

    // Improve car body proportions for more attractive look
    let w = chassis.bounds.max.x - chassis.bounds.min.x;
    let h = chassis.bounds.max.y - chassis.bounds.min.y;
    // Make cars a bit wider and lower for a sportier look
    if (!isBike) {
      w *= 1.12;
      h *= 0.92;
    }

    switch(id) {
      case 'rusty_hatchback':   this._bodyRustyHatchback(ctx, w, h, bod, acc); break;
      case 'monster_truck':     this._bodyMonsterTruck(ctx, w, h, bod, acc); break;
      case 'rally_racer':       this._bodyRallyRacer(ctx, w, h, bod, acc); break;
      case 'muscle_car':        this._bodyMuscleCar(ctx, w, h, bod, acc); break;
      case 'jeep_4x4':          this._bodyJeep4x4(ctx, w, h, bod, acc); break;
      case 'sports_coupe':      this._bodySportsCoupe(ctx, w, h, bod, acc); break;
      case 'dune_buggy':        this._bodyDuneBuggy(ctx, w, h, bod, acc); break;
      case 'tank':              this._bodyTank(ctx, w, h, bod, acc); break;
      case 'pickup_truck':      this._bodyPickupTruck(ctx, w, h, bod, acc); break;
      case 'electric_car':      this._bodyElectricCar(ctx, w, h, bod, acc); break;
      case 'dirt_bike':         this._bodyDirtBike(ctx, w, h, bod, acc); break;
      case 'chopper':           this._bodyChopper(ctx, w, h, bod, acc); break;
      case 'sport_bike':        this._bodySportBike(ctx, w, h, bod, acc); break;
      case 'scrambler':         this._bodyScrambler(ctx, w, h, bod, acc); break;
      case 'mini_moto':         this._bodyMiniMoto(ctx, w, h, bod, acc); break;
      case 'enduro_bike':       this._bodyEnduroBike(ctx, w, h, bod, acc); break;
      case 'cafe_racer':        this._bodyCafeRacer(ctx, w, h, bod, acc); break;
      case 'bmx':               this._bodyBMX(ctx, w, h, bod, acc); break;
      case 'cruiser_bike':      this._bodyCruiserBike(ctx, w, h, bod, acc); break;
      case 'supermoto':         this._bodySupermoto(ctx, w, h, bod, acc); break;
      default:
        isBike ? this._bodyGenericBike(ctx, w, h, bod, acc)
               : this._bodyGenericCar(ctx, w, h, bod, acc);
    }

    ctx.restore();
  }

  // ── Shared wheel renderer ────────────────────────────────
  _drawWheel(ctx, r, acc, chunky=false) {
    // Tyre
    ctx.fillStyle = '#111';
    ctx.beginPath(); ctx.arc(0,0,r+2,0,Math.PI*2); ctx.fill();
    if (chunky) {
      // chunky off-road tread dashes
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 3;
      ctx.setLineDash([5,4]);
      ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
    } else {
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
    }
    // Rim
    ctx.fillStyle = acc;
    ctx.beginPath(); ctx.arc(0,0, r*(chunky ? 0.60 : 0.62), 0, Math.PI*2); ctx.fill();
    // Spokes (5)
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = chunky ? 2.5 : 1.8;
    const spokeCount = chunky ? 6 : 5;
    for (let i=0; i<spokeCount; i++) {
      const a = (i/spokeCount)*Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(Math.cos(a)*r*0.18, Math.sin(a)*r*0.18);
      ctx.lineTo(Math.cos(a)*r*(chunky?0.70:0.60), Math.sin(a)*r*(chunky?0.70:0.60));
      ctx.stroke();
    }
    // Hub cap
    ctx.fillStyle = '#eee';
    ctx.beginPath(); ctx.arc(0,0,r*0.18,0,Math.PI*2); ctx.fill();
    // Centre dot
    ctx.fillStyle = acc;
    ctx.beginPath(); ctx.arc(0,0,r*0.09,0,Math.PI*2); ctx.fill();
    // Highlight
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.beginPath();
    ctx.ellipse(-r*0.12,-r*0.12, r*0.20, r*0.10, -0.5, 0, Math.PI*2);
    ctx.fill();
  }

  // ════════════════════════════════════════════════════════
  // CAR BODIES — drawn relative to chassis centre (0,0)
  // w = chassis width, h = chassis height
  // Right = front of vehicle (positive X)
  // ════════════════════════════════════════════════════════

  _bodyRustyHatchback(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Main body (boxy)
    ctx.fillStyle = b;
    this._drawRoundedRect(ctx,-hw,-hh,w,h,5); ctx.fill();
    // Tall boxy cab top
    ctx.fillStyle = L(b,20);
    this._drawRoundedRect(ctx,-hw*0.25,-hh-h*0.9,w*0.65,h*0.95,4); ctx.fill();
    // Windshield (nearly vertical)
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.25+w*0.18,-hh-h*0.85);
    ctx.lineTo( hw*0.40,       -hh-h*0.85);
    ctx.lineTo( hw*0.40,       -hh);
    ctx.lineTo(-hw*0.25,       -hh);
    ctx.closePath(); ctx.fill();
    // Rear window
    ctx.fillStyle='rgba(160,220,255,0.35)';
    this._drawRoundedRect(ctx,-hw*0.22,-hh-h*0.80,w*0.22,h*0.74,2); ctx.fill();
    // Accent stripe
    ctx.fillStyle=a;
    this._drawRoundedRect(ctx,-hw,hh*0.2,w,h*0.3,3); ctx.fill();
    // Rust spots
    ctx.fillStyle=D(b,40); ctx.globalAlpha=0.6;
    ctx.beginPath(); ctx.ellipse(-hw+8,hh*0.5,5,3,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(hw*0.5,-hh*0.2,4,2,0,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    // Headlight (square, right/front)
    ctx.fillStyle='rgba(255,255,200,0.95)';
    this._drawRoundedRect(ctx,hw-10,-hh*0.2,8,6,1); ctx.fill();
    // Taillight (left/rear)
    ctx.fillStyle='rgba(220,30,30,0.9)';
    this._drawRoundedRect(ctx,-hw+2,-hh*0.2,9,6,1); ctx.fill();
    // Body outline
    ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=1;
    this._drawRoundedRect(ctx,-hw,-hh,w,h,5); ctx.stroke();
  }

  _bodyMonsterTruck(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Suspension arms (drawn before body)
    ctx.strokeStyle='#555'; ctx.lineWidth=4; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.35,hh); ctx.lineTo(-hw*0.35,hh+h*0.45); ctx.stroke();
    ctx.beginPath(); ctx.moveTo( hw*0.35,hh); ctx.lineTo( hw*0.35,hh+h*0.45); ctx.stroke();
    // Axle bar
    ctx.fillStyle='#444';
    this._drawRoundedRect(ctx,-hw*0.45,hh+h*0.35,w*0.90,h*0.14,3); ctx.fill();
    // Body (sits high)
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,60)); grad.addColorStop(1,D(b,30));
    ctx.fillStyle=grad;
    this._drawRoundedRect(ctx,-hw*0.55,-hh,w*1.10,h*0.85,6); ctx.fill();
    // Cab on top
    ctx.fillStyle=L(b,25);
    this._drawRoundedRect(ctx,-hw*0.30,-hh-h*0.65,w*0.60,h*0.70,5); ctx.fill();
    // Windshield
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.25,-hh-h*0.62); ctx.lineTo(hw*0.25,-hh-h*0.62);
    ctx.lineTo(hw*0.22,-hh-h*0.02); ctx.lineTo(-hw*0.22,-hh-h*0.02);
    ctx.closePath(); ctx.fill();
    // Hood scoop
    ctx.fillStyle=D(a,10);
    ctx.beginPath(); ctx.ellipse(hw*0.15,-hh,w*0.22,h*0.22,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#1a1a1a';
    ctx.beginPath(); ctx.ellipse(hw*0.15,-hh,w*0.13,h*0.12,0,0,Math.PI*2); ctx.fill();
    // Exhaust stacks
    ctx.fillStyle='#888';
    this._drawRoundedRect(ctx,-hw*0.28,-hh-h*1.10,5,h*0.50,2); ctx.fill();
    this._drawRoundedRect(ctx,-hw*0.40,-hh-h*1.20,5,h*0.60,2); ctx.fill();
    // Headlights
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.52,-hh*0.15,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,200,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.52,-hh*0.15,4,0,Math.PI*2); ctx.fill();
    // Taillight
    ctx.fillStyle='rgba(220,30,30,0.9)';
    ctx.beginPath(); ctx.arc(-hw*0.52,-hh*0.15,6,0,Math.PI*2); ctx.fill();
  }

  _bodyRallyRacer(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Low wedge body
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw,hh);   ctx.lineTo(-hw*0.82,-hh*0.1);
    ctx.lineTo(-hw*0.30,-hh*0.55); ctx.lineTo(hw*0.55,-hh*0.60);
    ctx.lineTo(hw,    -hh*0.1);  ctx.lineTo(hw,hh);
    ctx.closePath(); ctx.fill();
    // Cab
    ctx.fillStyle=L(b,20);
    ctx.beginPath();
    ctx.moveTo(-hw*0.28,-hh*0.55); ctx.lineTo(-hw*0.25,-hh-h*0.60);
    ctx.lineTo( hw*0.38,-hh-h*0.62); ctx.lineTo(hw*0.40,-hh*0.55);
    ctx.closePath(); ctx.fill();
    // Windshield (raked)
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.20,-hh*0.50); ctx.lineTo(-hw*0.18,-hh-h*0.55);
    ctx.lineTo( hw*0.35,-hh-h*0.57); ctx.lineTo(hw*0.36,-hh*0.50);
    ctx.closePath(); ctx.fill();
    // Side stripe
    ctx.fillStyle=a; ctx.globalAlpha=0.7;
    this._drawRoundedRect(ctx,-hw,hh*0.35,w,h*0.22,2); ctx.fill();
    ctx.globalAlpha=1;
    // Spoiler (rear / left)
    ctx.fillStyle=D(b,20);
    ctx.fillRect(-hw,-hh*0.55,5,h*0.50);
    ctx.fillStyle=D(a,10);
    this._drawRoundedRect(ctx,-hw-8,-hh*0.65,w*0.15,h*0.14,2); ctx.fill();
    // Rally light bar on roof
    ctx.fillStyle='#222';
    this._drawRoundedRect(ctx,-hw*0.08,-hh-h*0.70,w*0.30,h*0.20,2); ctx.fill();
    for(let i=0;i<4;i++) {
      ctx.fillStyle='#ffcc00';
      ctx.beginPath(); ctx.arc(-hw*0.04+i*w*0.075,-hh-h*0.60,2.5,0,Math.PI*2); ctx.fill();
    }
    // Headlights
    ctx.fillStyle=L(a,70);
    ctx.beginPath(); ctx.arc(hw*0.96,-hh*0.25,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,200,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.96,-hh*0.25,3.5,0,Math.PI*2); ctx.fill();
    // Taillight
    ctx.fillStyle='rgba(220,30,30,0.9)';
    ctx.fillRect(-hw+2,-hh*0.30,3,h*0.55);
    // Dual exhausts
    ctx.fillStyle='#777';
    this._drawRoundedRect(ctx,hw*0.55,hh*0.70,w*0.16,h*0.14,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.55,hh*0.88,w*0.16,h*0.14,2); ctx.fill();
  }

  _bodyMuscleCar(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Long body with fastback
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,65)); grad.addColorStop(1,D(b,25));
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(-hw,hh);
    ctx.lineTo(-hw,-hh*0.1);
    ctx.lineTo(-hw*0.55,-hh*0.65);
    ctx.lineTo( hw*0.35,-hh*0.75);
    ctx.lineTo( hw,    -hh*0.1);
    ctx.lineTo( hw,    hh);
    ctx.closePath(); ctx.fill();
    // Long hood
    ctx.fillStyle=L(b,30);
    this._drawRoundedRect(ctx,hw*0.05,-hh,hw*0.94,h*0.50,3); ctx.fill();
    // Hood scoop
    ctx.fillStyle=D(b,15);
    ctx.beginPath(); ctx.ellipse(hw*0.45,-hh,w*0.20,h*0.22,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.ellipse(hw*0.45,-hh,w*0.12,h*0.12,0,0,Math.PI*2); ctx.fill();
    // Fastback cab
    ctx.fillStyle=L(b,18);
    ctx.beginPath();
    ctx.moveTo(-hw*0.55,-hh*0.65); ctx.lineTo(-hw*0.52,-hh-h*0.80);
    ctx.lineTo( hw*0.28,-hh-h*0.82); ctx.lineTo(hw*0.30,-hh*0.70);
    ctx.closePath(); ctx.fill();
    // Windshield
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.48,-hh*0.62); ctx.lineTo(-hw*0.45,-hh-h*0.72);
    ctx.lineTo( hw*0.26,-hh-h*0.76); ctx.lineTo(hw*0.26,-hh*0.65);
    ctx.closePath(); ctx.fill();
    // Classic stripe
    ctx.fillStyle=a; ctx.globalAlpha=0.6;
    this._drawRoundedRect(ctx,-hw,hh*0.25,w,h*0.24,1); ctx.fill();
    ctx.globalAlpha=1;
    // Quad headlights
    ctx.fillStyle=L(a,80);
    ctx.beginPath(); ctx.arc(hw*0.96,-hh*0.22,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,200,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.96,-hh*0.22,2.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.96,hh*0.06,5,0,Math.PI*2); ctx.fill();
    // Taillight strip
    ctx.fillStyle='rgba(220,40,40,0.9)';
    ctx.fillRect(-hw+2,-hh*0.25,5,h*0.62);
    // Dual side exhaust
    ctx.fillStyle='#888';
    this._drawRoundedRect(ctx,hw*0.10,hh*0.70,w*0.18,h*0.15,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.10,hh*0.88,w*0.18,h*0.15,2); ctx.fill();
  }

  _bodyJeep4x4(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Very boxy body
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,55)); grad.addColorStop(1,D(b,25));
    ctx.fillStyle=grad;
    this._drawRoundedRect(ctx,-hw,-hh,w,h,3); ctx.fill();
    // Flat roof cab (nearly same width)
    ctx.fillStyle=L(b,20);
    this._drawRoundedRect(ctx,-hw*0.88,-hh-h*0.92,w*0.88,h*0.95,2); ctx.fill();
    // Windshield (vertical)
    ctx.fillStyle='rgba(160,220,255,0.45)';
    this._drawRoundedRect(ctx,-hw*0.72,-hh-h*0.86,w*0.72,h*0.88,2); ctx.fill();
    // Windshield divider
    ctx.strokeStyle=D(b,30); ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(0,-hh-h*0.86); ctx.lineTo(0,-hh); ctx.stroke();
    // Spare tyre on rear (left)
    ctx.fillStyle='#1a1a1a';
    ctx.beginPath(); ctx.arc(-hw*0.86,0,h*0.75,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#555'; ctx.lineWidth=1.5; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.arc(-hw*0.86,0,h*0.58,0,Math.PI*2); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#666';
    ctx.beginPath(); ctx.arc(-hw*0.86,0,h*0.26,0,Math.PI*2); ctx.fill();
    // Roof rack
    ctx.fillStyle=D(b,40);
    this._drawRoundedRect(ctx,-hw*0.82,-hh-h*0.96,w*0.82,h*0.12,2); ctx.fill();
    // Snorkel
    ctx.fillStyle='#555';
    ctx.fillRect(hw*0.72,-hh-h*1.30,5,h*1.20);
    // Headlights (round)
    ctx.fillStyle=L(a,70);
    ctx.beginPath(); ctx.arc(hw*0.80,-hh*0.18,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.80,-hh*0.18,4.5,0,Math.PI*2); ctx.fill();
    // Taillight
    ctx.fillStyle='rgba(220,30,30,0.9)';
    this._drawRoundedRect(ctx,-hw+2,-hh*0.35,9,h*0.42,1); ctx.fill();
    // Bull bar
    ctx.strokeStyle='#666'; ctx.lineWidth=4; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.92,-hh); ctx.lineTo(hw*0.92,hh); ctx.stroke();
  }

  _bodySportsCoupe(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Ultra-low wedge
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,70)); grad.addColorStop(1,D(b,15));
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(-hw,hh);
    ctx.lineTo(-hw,-hh*0.05);
    ctx.lineTo(-hw*0.55,-hh*0.55);
    ctx.lineTo( hw*0.62,-hh*0.70);
    ctx.lineTo( hw*0.97,-hh*0.10);
    ctx.lineTo( hw,hh);
    ctx.closePath(); ctx.fill();
    // Sweeping canopy
    ctx.fillStyle=L(b,22);
    ctx.beginPath();
    ctx.moveTo(-hw*0.52,-hh*0.52); ctx.lineTo(-hw*0.45,-hh-h*0.78);
    ctx.lineTo( hw*0.45,-hh-h*0.80); ctx.lineTo(hw*0.50,-hh*0.55);
    ctx.closePath(); ctx.fill();
    // Windshield (very raked)
    ctx.fillStyle='rgba(160,220,255,0.55)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.42,-hh*0.50); ctx.lineTo(-hw*0.38,-hh-h*0.70);
    ctx.lineTo( hw*0.42,-hh-h*0.72); ctx.lineTo(hw*0.45,-hh*0.55);
    ctx.closePath(); ctx.fill();
    // Body shine
    ctx.fillStyle='rgba(255,255,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.20,hh*0.05); ctx.lineTo(hw*0.92,-hh*0.22);
    ctx.lineTo(hw*0.92,hh*0.18);  ctx.lineTo(-hw*0.20,hh*0.40);
    ctx.closePath(); ctx.fill();
    // Side air intake
    ctx.fillStyle='#111';
    ctx.fillRect(hw*0.55,-hh*0.25,h*0.40,h*0.44);
    // Headlights (thin aggressive)
    ctx.fillStyle=L(a,80);
    ctx.beginPath();
    ctx.moveTo(hw*0.92,-hh*0.38); ctx.lineTo(hw,-hh*0.28);
    ctx.lineTo(hw,-hh*0.02);      ctx.lineTo(hw*0.92,-hh*0.08);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath();
    ctx.moveTo(hw*0.93,-hh*0.30); ctx.lineTo(hw*0.99,-hh*0.22);
    ctx.lineTo(hw*0.99,-hh*0.05); ctx.lineTo(hw*0.93,-hh*0.10);
    ctx.closePath(); ctx.fill();
    // Taillight strip (LED)
    ctx.fillStyle=a; ctx.globalAlpha=0.9;
    ctx.fillRect(-hw+2,-hh*0.38,3,h*0.48);
    ctx.globalAlpha=1;
    // Rear wing
    ctx.fillStyle=D(b,20);
    ctx.fillRect(-hw*0.88,-hh*0.60,3,h*0.50);
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,-hw*0.96,-hh*0.65,w*0.12,h*0.10,1); ctx.fill();
    // Dual exhausts
    ctx.fillStyle='#333';
    ctx.beginPath(); ctx.ellipse(hw*0.30,hh*0.92,5,3,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(hw*0.50,hh*0.92,5,3,0,0,Math.PI*2); ctx.fill();
  }

  _bodyDuneBuggy(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Roll cage tubes
    ctx.strokeStyle=D(b,10); ctx.lineWidth=5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.25,hh); ctx.lineTo(-hw*0.25,-hh-h*0.35); ctx.stroke();
    ctx.beginPath(); ctx.moveTo( hw*0.25,hh); ctx.lineTo( hw*0.25,-hh-h*0.35); ctx.stroke();
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(-hw*0.25,-hh-h*0.35); ctx.lineTo(hw*0.25,-hh-h*0.35); ctx.stroke();
    // Diagonal braces
    ctx.lineWidth=3; ctx.strokeStyle=D(b,20);
    ctx.beginPath(); ctx.moveTo(-hw*0.25,-hh-h*0.35); ctx.lineTo(hw*0.25,hh); ctx.stroke();
    ctx.beginPath(); ctx.moveTo( hw*0.25,-hh-h*0.35); ctx.lineTo(-hw*0.25,hh); ctx.stroke();
    // Low body pan
    ctx.fillStyle=b;
    this._drawRoundedRect(ctx,-hw*0.55,hh*0.30,w*1.10,h*0.55,3); ctx.fill();
    // Front nose
    ctx.fillStyle=L(b,20);
    ctx.beginPath();
    ctx.moveTo(hw*0.50,hh*0.30); ctx.lineTo(hw,hh*0.15);
    ctx.lineTo(hw,hh*0.70);      ctx.lineTo(hw*0.50,hh*0.75);
    ctx.closePath(); ctx.fill();
    // Exposed rear engine
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,-hw*0.55,-hh*0.30,w*0.28,h*0.76,2); ctx.fill();
    ctx.fillStyle=a; ctx.globalAlpha=0.5;
    this._drawRoundedRect(ctx,-hw*0.52,-hh*0.18,w*0.22,h*0.54,1); ctx.fill();
    ctx.globalAlpha=1;
    // Bucket seats
    ctx.fillStyle=D(b,20);
    this._drawRoundedRect(ctx,-hw*0.20,-hh*0.40,w*0.20,h*0.82,3); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.04,-hh*0.40,w*0.20,h*0.82,3); ctx.fill();
    // Steering wheel
    ctx.strokeStyle='#333'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.arc(hw*0.22,-hh*0.10,9,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.13,-hh*0.10); ctx.lineTo(hw*0.31,-hh*0.10); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.22,-hh*0.32); ctx.lineTo(hw*0.22,hh*0.12); ctx.stroke();
    // Headlight
    ctx.fillStyle=L(a,70);
    ctx.beginPath(); ctx.arc(hw*0.96,hh*0.30,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.96,hh*0.30,4,0,Math.PI*2); ctx.fill();
    // Flag
    ctx.strokeStyle='#888'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-hw*0.35,hh*0.15); ctx.lineTo(-hw*0.35,-hh-h*0.75); ctx.stroke();
    ctx.fillStyle=a;
    ctx.beginPath(); ctx.moveTo(-hw*0.35,-hh-h*0.75); ctx.lineTo(-hw*0.10,-hh-h*0.65); ctx.lineTo(-hw*0.35,-hh-h*0.55); ctx.fill();
    // Exhaust
    ctx.strokeStyle='#888'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(-hw*0.55,hh*0.10); ctx.quadraticCurveTo(-hw*0.80,hh*0.40,-hw,hh*0.65); ctx.stroke();
  }

  _bodyTank(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Hull
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw*0.92,-hh*0.10); ctx.lineTo(-hw*0.75,-hh);
    ctx.lineTo( hw*0.80,-hh);      ctx.lineTo( hw,    -hh*0.10);
    ctx.lineTo( hw,    hh);
    ctx.lineTo(-hw*0.92,hh);
    ctx.closePath(); ctx.fill();
    // Hull top shine
    ctx.fillStyle='rgba(255,255,255,0.12)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.75,-hh); ctx.lineTo(hw*0.80,-hh);
    ctx.lineTo(hw*0.72,-hh*0.55); ctx.lineTo(-hw*0.68,-hh*0.55);
    ctx.closePath(); ctx.fill();
    // Track (simulate with dark band)
    ctx.fillStyle=D(b,30); ctx.globalAlpha=0.9;
    this._drawRoundedRect(ctx,-hw*0.92,hh*0.25,w*1.84,h*0.55,4); ctx.fill();
    ctx.globalAlpha=1;
    // Road wheels (small circles on track)
    ctx.fillStyle='#333';
    for(let i=0;i<7;i++) {
      const wx = -hw*0.85 + i*w*0.27;
      ctx.beginPath(); ctx.arc(wx,hh*0.55,h*0.35,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#444'; ctx.beginPath(); ctx.arc(wx,hh*0.55,h*0.18,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#333';
    }
    // Turret (ellipse)
    ctx.fillStyle=L(b,15);
    ctx.beginPath(); ctx.ellipse(hw*0.08,-hh*0.70,w*0.42,h*0.68,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(b,22);
    ctx.beginPath(); ctx.ellipse(hw*0.08,-hh*0.86,w*0.36,h*0.52,0,0,Math.PI*2); ctx.fill();
    // Hatch
    ctx.fillStyle=D(b,20);
    ctx.beginPath(); ctx.ellipse(hw*0.25,-hh*1.06,w*0.10,h*0.22,0,0,Math.PI*2); ctx.fill();
    // Cannon barrel (pointing right / forward)
    ctx.fillStyle=D(b,15);
    this._drawRoundedRect(ctx,hw*0.35,-hh*0.82,w*0.72,h*0.28,3); ctx.fill();
    ctx.fillStyle=D(b,30);
    this._drawRoundedRect(ctx,hw*0.35,-hh*0.72,w*0.68,h*0.14,2); ctx.fill();
    // Antenna
    ctx.strokeStyle='#888'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-hw*0.10,-hh*0.95); ctx.lineTo(-hw*0.12,-hh*1.50); ctx.stroke();
    // Headlight
    ctx.fillStyle=L(a,70);
    ctx.beginPath(); ctx.arc(-hw*0.70,-hh*0.18,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(-hw*0.70,-hh*0.18,3,0,Math.PI*2); ctx.fill();
  }

  _bodyPickupTruck(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Truck bed (open)
    ctx.fillStyle=D(b,15);
    this._drawRoundedRect(ctx,-hw,-hh,w*0.56,h,3); ctx.fill();
    ctx.fillStyle=D(b,40);
    this._drawRoundedRect(ctx,-hw+2,hh*0.25,w*0.52,h*0.65,1); ctx.fill();
    // Bed rails
    ctx.fillStyle=D(b,20);
    ctx.fillRect(-hw,-hh,4,h);
    ctx.fillRect(-hw*0.92+w*0.54,-hh,4,h);
    // Cab
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,55)); grad.addColorStop(1,D(b,20));
    ctx.fillStyle=grad;
    this._drawRoundedRect(ctx,hw*0.05,-hh,hw*0.94,h,5); ctx.fill();
    // Cab roof
    ctx.fillStyle=L(b,20);
    this._drawRoundedRect(ctx,hw*0.10,-hh-h*0.75,hw*0.84,h*0.80,4); ctx.fill();
    // Windshield
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(hw*0.14,-hh-h*0.70); ctx.lineTo(hw*0.90,-hh-h*0.70);
    ctx.lineTo(hw*0.90,-hh);         ctx.lineTo(hw*0.10,-hh);
    ctx.closePath(); ctx.fill();
    // Hood
    ctx.fillStyle=L(b,25);
    this._drawRoundedRect(ctx,hw*0.72,-hh,hw*0.28,h*0.62,2); ctx.fill();
    // Grille
    ctx.fillStyle='#111';
    ctx.fillRect(hw*0.90,-hh+h*0.08,hw*0.08,h*0.44);
    for(let i=0;i<3;i++) {
      ctx.strokeStyle='#333'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(hw*0.90,-hh+h*0.18+i*h*0.13); ctx.lineTo(hw*0.98,-hh+h*0.18+i*h*0.13); ctx.stroke();
    }
    // Headlights
    ctx.fillStyle=L(a,80);
    this._drawRoundedRect(ctx,hw*0.82,-hh+h*0.10,7,9,2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    this._drawRoundedRect(ctx,hw*0.83,-hh+h*0.12,4,5,1); ctx.fill();
    // Taillight
    ctx.fillStyle='rgba(220,30,30,0.9)';
    ctx.fillRect(-hw+4,-hh+h*0.05,4,h*0.35);
    // Tow hook
    ctx.strokeStyle='#888'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(-hw,-hh*0.10,4,0,Math.PI*2); ctx.stroke();
  }

  _bodyElectricCar(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Aerodynamic teardrop body
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,70)); grad.addColorStop(1,D(b,10));
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(-hw,hh);
    ctx.quadraticCurveTo(-hw,-hh*0.42,-hw*0.55,-hh*0.60);
    ctx.quadraticCurveTo(-hw*0.10,-hh*0.92,hw*0.55,-hh*0.90);
    ctx.quadraticCurveTo(hw*0.90,-hh*0.70,hw,-hh*0.15);
    ctx.lineTo(hw,hh);
    ctx.closePath(); ctx.fill();
    // Smooth canopy integrated
    ctx.fillStyle=L(b,22);
    ctx.beginPath();
    ctx.moveTo(-hw*0.48,-hh*0.58); ctx.quadraticCurveTo(-hw*0.38,-hh-h*0.65,hw*0.36,-hh-h*0.68);
    ctx.lineTo(hw*0.38,-hh*0.62); ctx.closePath(); ctx.fill();
    // Panoramic glass
    ctx.fillStyle='rgba(160,220,255,0.60)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.38,-hh*0.54); ctx.quadraticCurveTo(-hw*0.28,-hh-h*0.58,hw*0.32,-hh-h*0.60);
    ctx.lineTo(hw*0.34,-hh*0.58); ctx.closePath(); ctx.fill();
    // Body shine
    ctx.fillStyle='rgba(255,255,255,0.16)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.20,hh*0.20); ctx.lineTo(hw*0.90,-hh*0.22);
    ctx.lineTo(hw*0.90,hh*0.15);  ctx.lineTo(-hw*0.20,hh*0.52);
    ctx.closePath(); ctx.fill();
    // Charge port
    ctx.fillStyle=a; ctx.globalAlpha=0.8;
    ctx.beginPath(); ctx.arc(-hw*0.90,-hh*0.08,6,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle='rgba(255,255,255,0.7)';
    ctx.beginPath(); ctx.arc(-hw*0.90,-hh*0.08,3,0,Math.PI*2); ctx.fill();
    // LED headlight strip
    ctx.fillStyle=L(a,80); ctx.globalAlpha=0.9;
    ctx.beginPath();
    ctx.moveTo(hw*0.88,-hh*0.38); ctx.lineTo(hw,-hh*0.26);
    ctx.lineTo(hw,-hh*0.02);      ctx.lineTo(hw*0.88,-hh*0.10);
    ctx.closePath(); ctx.fill();
    ctx.globalAlpha=1;
    // LED tail strip
    ctx.strokeStyle=a; ctx.lineWidth=3; ctx.globalAlpha=0.9;
    ctx.beginPath(); ctx.moveTo(-hw+2,-hh*0.38); ctx.lineTo(-hw+2,hh*0.52); ctx.stroke();
    ctx.globalAlpha=1;
    // Indicator dots
    ctx.fillStyle=a;
    for(let i=0;i<3;i++) {
      ctx.globalAlpha=0.7-i*0.2;
      ctx.beginPath(); ctx.arc(-hw*0.78+i*w*0.10,-hh*0.35,2,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
    // Aero underbody
    ctx.fillStyle=D(b,30);
    this._drawRoundedRect(ctx,-hw*0.88,hh*0.80,w*0.90,h*0.14,2); ctx.fill();
  }

  // ════════════════════════════════════════════════════════
  // BIKE BODIES
  // ════════════════════════════════════════════════════════

  _bodyDirtBike(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'dirt');
    // Tank (tall)
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw*0.25,hh);
    ctx.quadraticCurveTo(-hw*0.20,-hh*0.45, hw*0.05,-hh*0.75);
    ctx.quadraticCurveTo( hw*0.35,-hh*0.92,  hw*0.50,-hh*0.60);
    ctx.lineTo(hw*0.50,hh);
    ctx.closePath(); ctx.fill();
    // Seat tall narrow
    ctx.fillStyle=D(b,25);
    this._drawRoundedRect(ctx,-hw*0.44,-hh*0.35,w*0.22,h*1.35,4); ctx.fill();
    // Number plate
    ctx.fillStyle='white'; ctx.globalAlpha=0.9;
    this._drawRoundedRect(ctx,hw*0.42,-hh*0.48,w*0.16,h*0.50,2); ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle=b; ctx.font=`bold ${Math.max(7,h*0.35)}px Orbitron,monospace`; ctx.textAlign='center';
    ctx.fillText('7',hw*0.50,-hh*0.14);
    // Wide handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=4; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.25,-hh*0.85); ctx.lineTo(hw*0.80,-hh*0.85); ctx.stroke();
    ctx.strokeStyle='#666'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hw*0.52,-hh*0.85); ctx.lineTo(hw*0.52,-hh*0.45); ctx.stroke();
    // Grips
    ctx.fillStyle='#222';
    this._drawRoundedRect(ctx,hw*0.25,-hh*0.92,w*0.08,h*0.14,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.72,-hh*0.92,w*0.08,h*0.14,2); ctx.fill();
    // Round headlight
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.78,-hh*0.38,10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.78,-hh*0.38,6,0,Math.PI*2); ctx.fill();
    // Upswept exhaust
    ctx.strokeStyle='#888'; ctx.lineWidth=6; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.05,hh*0.55); ctx.quadraticCurveTo(-hw*0.20,hh*0.90,-hw*0.45,hh*0.72); ctx.stroke();
    ctx.fillStyle='#555';
    ctx.beginPath(); ctx.ellipse(-hw*0.47,hh*0.70,5,3,0.3,0,Math.PI*2); ctx.fill();
  }

  _bodyChopper(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Long stretched frame
    ctx.strokeStyle=D(b,10); ctx.lineWidth=5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.30,hh); ctx.lineTo(hw*0.50,-hh*0.20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-hw*0.30,hh); ctx.lineTo(-hw*0.20,hh*0.60); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.50,-hh*0.20); ctx.lineTo(hw*0.55,hh*0.60); ctx.stroke();
    // Extended front fork (raked)
    ctx.strokeStyle='#888'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.50,-hh*0.20); ctx.lineTo(hw*0.90,-hh*0.95); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.55,hh*0.60); ctx.lineTo(hw*0.96,hh*0.80); ctx.stroke();
    // Ape hanger handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hw*0.50,-hh*0.20); ctx.lineTo(hw*0.30,-hh*0.88); ctx.stroke();
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hw*0.18,-hh*0.88); ctx.lineTo(hw*0.60,-hh*0.88); ctx.stroke();
    ctx.fillStyle='#333';
    ctx.beginPath(); ctx.arc(hw*0.16,-hh*0.88,4,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(hw*0.62,-hh*0.88,4,0,Math.PI*2); ctx.fill();
    // V-twin engine
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,hw*0.08,-hh*0.08,w*0.40,h,4); ctx.fill();
    ctx.fillStyle=b; ctx.globalAlpha=0.8;
    ctx.beginPath(); ctx.moveTo(hw*0.10,-hh*0.08); ctx.lineTo(hw*0.30,-hh*0.78); ctx.lineTo(hw*0.32,-hh*0.08); ctx.fill();
    ctx.beginPath(); ctx.moveTo(hw*0.30,-hh*0.08); ctx.lineTo(hw*0.48,-hh*0.78); ctx.lineTo(hw*0.50,-hh*0.08); ctx.fill();
    ctx.globalAlpha=1;
    // Fuel tank (teardrop)
    ctx.fillStyle=b;
    ctx.beginPath(); ctx.ellipse(hw*0.28,-hh*0.22,w*0.25,h*0.32,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.2)';
    ctx.beginPath(); ctx.ellipse(hw*0.28,-hh*0.30,w*0.18,h*0.18,0,0,Math.PI*2); ctx.fill();
    // Long low seat
    ctx.fillStyle=D(b,30);
    this._drawRoundedRect(ctx,-hw*0.30,-hh*0.62,w*0.42,h*0.55,5); ctx.fill();
    // Chrome exhaust
    ctx.strokeStyle='#bbb'; ctx.lineWidth=6;
    ctx.beginPath(); ctx.moveTo(hw*0.25,hh*0.70); ctx.quadraticCurveTo(-hw*0.10,hh*0.95,-hw*0.42,hh*0.72); ctx.stroke();
    ctx.fillStyle='#555';
    ctx.beginPath(); ctx.ellipse(-hw*0.44,hh*0.70,4,2.5,0.4,0,Math.PI*2); ctx.fill();
    // Headlight
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.86,hh*0.20,10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.86,hh*0.20,6,0,Math.PI*2); ctx.fill();
  }

  _bodySportBike(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'sport');
    // Full fairing (upper)
    const grad=ctx.createLinearGradient(0,-hh,0,hh);
    grad.addColorStop(0,L(b,70)); grad.addColorStop(1,D(b,20));
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(-hw*0.25,hh*0.62);
    ctx.quadraticCurveTo(hw*0.20,-hh*0.62,hw*0.55,-hh*0.30);
    ctx.lineTo(hw*0.55,hh);
    ctx.lineTo(-hw*0.25,hh);
    ctx.closePath(); ctx.fill();
    // Windscreen
    ctx.fillStyle='rgba(40,80,160,0.60)';
    ctx.beginPath();
    ctx.moveTo(hw*0.36,-hh*0.18); ctx.lineTo(hw*0.62,-hh*0.68);
    ctx.lineTo(hw*0.78,-hh*0.50); ctx.lineTo(hw*0.55,-hh*0.08);
    ctx.closePath(); ctx.fill();
    // Belly pan
    ctx.fillStyle=D(b,15);
    ctx.beginPath();
    ctx.moveTo(-hw*0.22,hh*0.65); ctx.quadraticCurveTo(hw*0.20,hh*0.90,hw*0.55,hh*0.90);
    ctx.lineTo(hw*0.55,hh);       ctx.lineTo(-hw*0.22,hh);
    ctx.closePath(); ctx.fill();
    // Seat hump
    ctx.fillStyle=D(b,20);
    ctx.beginPath(); ctx.ellipse(-hw*0.04,-hh*0.18,w*0.15,h*0.26,0,0,Math.PI*2); ctx.fill();
    // Pointed nose / front fairing
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(hw*0.52,-hh*0.32); ctx.lineTo(hw*0.84,-hh*0.45);
    ctx.lineTo(hw*0.90,hh*0.25);  ctx.lineTo(hw*0.55,hh*0.12);
    ctx.closePath(); ctx.fill();
    // Thin LED headlight
    ctx.fillStyle=L(a,70);
    ctx.beginPath();
    ctx.moveTo(hw*0.80,-hh*0.42); ctx.lineTo(hw*0.92,-hh*0.38);
    ctx.lineTo(hw*0.92,-hh*0.18); ctx.lineTo(hw*0.80,-hh*0.20);
    ctx.closePath(); ctx.fill();
    // Clip-on bars
    ctx.strokeStyle='#888'; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.58,-hh*0.68); ctx.lineTo(hw*0.74,-hh*0.72); ctx.stroke();
    // Number decal
    ctx.fillStyle='white'; ctx.globalAlpha=0.8;
    ctx.beginPath(); ctx.ellipse(-hw*0.01,-hh*0.04,w*0.10,h*0.22,0,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle=b; ctx.font=`bold ${Math.max(6,h*0.28)}px Orbitron,monospace`; ctx.textAlign='center';
    ctx.fillText('46',-hw*0.01,hh*0.02);
    // Taillight
    ctx.fillStyle=a; ctx.globalAlpha=0.9;
    ctx.fillRect(-hw*0.30,-hh*0.32,3,h*0.30);
    ctx.globalAlpha=1;
    // Exhaust (under engine)
    ctx.strokeStyle='#aaa'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.10,hh*0.62); ctx.quadraticCurveTo(-hw*0.10,hh*0.82,-hw*0.28,hh*0.82); ctx.stroke();
    ctx.fillStyle='#444';
    ctx.beginPath(); ctx.ellipse(-hw*0.30,hh*0.82,5,3,0,0,Math.PI*2); ctx.fill();
  }

  _bodyScrambler(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'upright');
    // Round tank (classic)
    ctx.fillStyle=b;
    ctx.beginPath(); ctx.ellipse(hw*0.12,-hh*0.10,w*0.26,h*0.44,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.2)';
    ctx.beginPath(); ctx.ellipse(hw*0.12,-hh*0.18,w*0.18,h*0.25,0,0,Math.PI*2); ctx.fill();
    // Flat padded seat
    ctx.fillStyle=D(b,25);
    this._drawRoundedRect(ctx,-hw*0.44,-hh*0.18,w*0.42,h*0.38,5); ctx.fill();
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,-hw*0.44,-hh*0.24,w*0.42,h*0.22,4); ctx.fill();
    // Engine block
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,hw*0.02,-hh*0.06,w*0.34,h*0.88,3); ctx.fill();
    ctx.fillStyle=a; ctx.globalAlpha=0.4;
    this._drawRoundedRect(ctx,hw*0.05,hh*0.04,w*0.28,h*0.62,2); ctx.fill();
    ctx.globalAlpha=1;
    // Upright handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.42,-hh*0.78); ctx.lineTo(hw*0.78,-hh*0.82); ctx.stroke();
    // Round headlight
    ctx.fillStyle='#222';
    ctx.beginPath(); ctx.arc(hw*0.80,-hh*0.40,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.80,-hh*0.40,9,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.80,-hh*0.40,5,0,Math.PI*2); ctx.fill();
    // Dual exhausts (upswept)
    ctx.strokeStyle='#aaa'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.62); ctx.quadraticCurveTo(-hw*0.18,hh*0.90,-hw*0.44,hh*0.78); ctx.stroke();
    ctx.strokeStyle='#999'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.78); ctx.quadraticCurveTo(-hw*0.18,hh*1.04,-hw*0.44,hh*0.92); ctx.stroke();
    // Front fender
    ctx.fillStyle=D(b,15);
    ctx.beginPath();
    ctx.arc(hw*0.76,hh*0.20,h*0.48,-Math.PI*0.90,-Math.PI*0.10);
    ctx.lineTo(hw*0.85,hh*0.20); ctx.closePath(); ctx.fill();
  }

  _bodyMiniMoto(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'compact');
    // Small round tank
    ctx.fillStyle=b;
    ctx.beginPath(); ctx.ellipse(hw*0.10,-hh*0.12,w*0.18,h*0.33,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.beginPath(); ctx.ellipse(hw*0.10,-hh*0.22,w*0.12,h*0.18,0,0,Math.PI*2); ctx.fill();
    // Small seat
    ctx.fillStyle=D(b,25);
    this._drawRoundedRect(ctx,-hw*0.40,-hh*0.18,w*0.30,h*0.30,4); ctx.fill();
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,-hw*0.40,-hh*0.24,w*0.30,h*0.18,3); ctx.fill();
    // Tiny engine
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,hw*0.05,hh*0.08,w*0.24,h*0.66,2); ctx.fill();
    ctx.fillStyle=a; ctx.globalAlpha=0.45;
    this._drawRoundedRect(ctx,hw*0.08,hh*0.16,w*0.20,h*0.44,1); ctx.fill();
    ctx.globalAlpha=1;
    // Small handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=2.5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.38,-hh*0.65); ctx.lineTo(hw*0.62,-hh*0.68); ctx.stroke();
    // Tiny headlight
    ctx.fillStyle='#222';
    ctx.beginPath(); ctx.arc(hw*0.70,-hh*0.30,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.70,-hh*0.30,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.70,-hh*0.30,3,0,Math.PI*2); ctx.fill();
    // Small exhaust
    ctx.strokeStyle='#999'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.62); ctx.quadraticCurveTo(-hw*0.14,hh*0.85,-hw*0.38,hh*0.72); ctx.stroke();
    ctx.fillStyle='#444';
    ctx.beginPath(); ctx.ellipse(-hw*0.40,hh*0.70,4,2.5,0.3,0,Math.PI*2); ctx.fill();
  }

  _bodyEnduroBike(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'dirt');
    // Side panniers
    ctx.fillStyle=D(b,20);
    this._drawRoundedRect(ctx,-hw*0.50,-hh*0.15,w*0.26,h,3); ctx.fill();
    ctx.fillStyle=D(b,10); ctx.globalAlpha=0.7;
    this._drawRoundedRect(ctx,-hw*0.48,-hh*0.08,w*0.22,h*0.88,2); ctx.fill();
    ctx.globalAlpha=1;
    // Tank (angular rally)
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw*0.20,hh);
    ctx.quadraticCurveTo(-hw*0.18,-hh*0.52,hw*0.10,-hh*0.80);
    ctx.quadraticCurveTo(hw*0.40,-hh*0.95,hw*0.50,-hh*0.60);
    ctx.lineTo(hw*0.50,hh);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.10,-hh*0.42); ctx.quadraticCurveTo(hw*0.10,-hh*0.72,hw*0.42,-hh*0.80);
    ctx.closePath(); ctx.fill();
    // Seat (tall)
    ctx.fillStyle=D(b,25);
    this._drawRoundedRect(ctx,-hw*0.44,-hh*0.45,w*0.16,h*1.45,4); ctx.fill();
    // Tall windscreen / beak
    ctx.fillStyle='rgba(160,220,255,0.50)';
    ctx.beginPath();
    ctx.moveTo(hw*0.42,-hh*0.55); ctx.lineTo(hw*0.52,-hh*0.92);
    ctx.lineTo(hw*0.66,-hh*0.80); ctx.lineTo(hw*0.58,-hh*0.45);
    ctx.closePath(); ctx.fill();
    // Rally headlight (square)
    ctx.fillStyle='#111';
    this._drawRoundedRect(ctx,hw*0.58,-hh*0.60,w*0.22,h*0.56,3); ctx.fill();
    ctx.fillStyle=L(a,60); ctx.globalAlpha=0.9;
    this._drawRoundedRect(ctx,hw*0.60,-hh*0.55,w*0.18,h*0.44,2); ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle='rgba(255,255,220,0.9)';
    this._drawRoundedRect(ctx,hw*0.63,-hh*0.50,w*0.10,h*0.25,1); ctx.fill();
    // Wide handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=3.5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.32,-hh*0.88); ctx.lineTo(hw*0.80,-hh*0.92); ctx.stroke();
    // High exhaust
    ctx.strokeStyle='#aaa'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.02,hh*0.55); ctx.quadraticCurveTo(-hw*0.22,hh*0.90,-hw*0.44,hh*0.78); ctx.stroke();
    ctx.fillStyle='#555';
    ctx.beginPath(); ctx.ellipse(-hw*0.46,hh*0.76,5,3,0.3,0,Math.PI*2); ctx.fill();
  }

  _bodyCafeRacer(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'upright');
    // Long elongated tank
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw*0.24,hh);
    ctx.quadraticCurveTo(-hw*0.20,-hh*0.62,hw*0.20,-hh*0.78);
    ctx.quadraticCurveTo(hw*0.46,-hh*0.90,hw*0.52,-hh*0.52);
    ctx.lineTo(hw*0.52,hh);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.20)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.15,-hh*0.52); ctx.quadraticCurveTo(hw*0.15,-hh*0.70,hw*0.44,-hh*0.70);
    ctx.closePath(); ctx.fill();
    // Pin stripe
    ctx.strokeStyle=a; ctx.lineWidth=1.5; ctx.globalAlpha=0.7;
    ctx.beginPath(); ctx.moveTo(-hw*0.14,-hh*0.30); ctx.quadraticCurveTo(hw*0.18,-hh*0.52,hw*0.50,-hh*0.42); ctx.stroke();
    ctx.globalAlpha=1;
    // Seat hump (signature cafe racer)
    ctx.fillStyle=D(b,20);
    ctx.beginPath();
    ctx.moveTo(-hw*0.46,-hh*0.22); ctx.quadraticCurveTo(-hw*0.38,-hh*0.62,-hw*0.20,-hh*0.62);
    ctx.quadraticCurveTo(-hw*0.12,-hh*0.62,-hw*0.12,-hh*0.22);
    ctx.quadraticCurveTo(-hw*0.12,hh*0.28,-hw*0.20,hh*0.28);
    ctx.quadraticCurveTo(-hw*0.38,hh*0.28,-hw*0.46,hh*0.10);
    ctx.closePath(); ctx.fill();
    // Low clip-on bars
    ctx.strokeStyle='#888'; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.40,-hh*0.70); ctx.lineTo(hw*0.60,-hh*0.72); ctx.stroke();
    // Round headlight (classic)
    ctx.fillStyle='#1a1a1a';
    ctx.beginPath(); ctx.arc(hw*0.72,-hh*0.34,13,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.72,-hh*0.34,10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.72,-hh*0.34,6,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#888'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(hw*0.72,-hh*0.34,12,0,Math.PI*2); ctx.stroke();
    // Classic wrapped exhaust
    ctx.strokeStyle='#bbb'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.10,hh*0.62); ctx.quadraticCurveTo(-hw*0.16,hh*0.88,-hw*0.36,hh*0.80); ctx.stroke();
    ctx.fillStyle='#555';
    ctx.beginPath(); ctx.ellipse(-hw*0.38,hh*0.78,4,2.5,0.3,0,Math.PI*2); ctx.fill();
    // Small taillight
    ctx.fillStyle='rgba(220,30,30,0.9)';
    this._drawRoundedRect(ctx,-hw*0.44,-hh*0.18,5,h*0.16,1); ctx.fill();
  }

  _bodyBMX(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Thick diamond frame tubes
    ctx.strokeStyle=b; ctx.lineWidth=6; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.18); ctx.lineTo(hw*0.26,-hh*0.36); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.18); ctx.lineTo(-hw*0.18,hh*0.80); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.26,-hh*0.36); ctx.lineTo(hw*0.28,hh*0.80); ctx.stroke();
    ctx.strokeStyle=D(b,10); ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.22); ctx.lineTo(hw*0.26,hh*0.18); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.18); ctx.lineTo(hw*0.28,hh*0.70); ctx.stroke();
    // Seat tube
    ctx.strokeStyle=b; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.02,-hh*0.36); ctx.lineTo(hw*0.02,hh*0.18); ctx.stroke();
    // Tiny saddle
    ctx.fillStyle='#222';
    ctx.beginPath(); ctx.ellipse(hw*0.02,-hh*0.42,w*0.08,h*0.10,0,0,Math.PI*2); ctx.fill();
    // Wide BMX handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=4; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.12,-hh*0.62); ctx.lineTo(hw*0.56,-hh*0.68); ctx.stroke();
    ctx.strokeStyle='#666'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hw*0.28,-hh*0.62); ctx.lineTo(hw*0.26,-hh*0.36); ctx.stroke();
    // Crossbar
    ctx.strokeStyle='#666'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.moveTo(hw*0.16,-hh*0.50); ctx.lineTo(hw*0.50,-hh*0.55); ctx.stroke();
    // Grips
    ctx.fillStyle='#222';
    this._drawRoundedRect(ctx,hw*0.10,-hh*0.72,w*0.08,h*0.18,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.48,-hh*0.76,w*0.08,h*0.18,2); ctx.fill();
    // Pegs (4)
    ctx.fillStyle='#aaa';
    this._drawRoundedRect(ctx,-hw*0.30,hh*0.74,w*0.12,h*0.18,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.18,hh*0.74,w*0.12,h*0.18,2); ctx.fill();
    this._drawRoundedRect(ctx,-hw*0.30,hh*0.14,w*0.12,h*0.18,2); ctx.fill();
    this._drawRoundedRect(ctx,hw*0.18,hh*0.14,w*0.12,h*0.18,2); ctx.fill();
    // Chain sprocket
    ctx.strokeStyle='#666'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(hw*0.04,hh*0.18,w*0.08,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle='#444';
    ctx.beginPath(); ctx.arc(hw*0.04,hh*0.18,w*0.04,0,Math.PI*2); ctx.fill();
    // Chain
    ctx.strokeStyle='#555'; ctx.lineWidth=2; ctx.setLineDash([3,2]);
    ctx.beginPath(); ctx.moveTo(hw*0.04,hh*0.18); ctx.lineTo(-hw*0.18,hh*0.80); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.04,hh*0.18); ctx.lineTo(hw*0.28,hh*0.80); ctx.stroke();
    ctx.setLineDash([]);
  }

  _bodyCruiserBike(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    // Long low frame
    ctx.strokeStyle=D(b,10); ctx.lineWidth=5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.30,hh*0.26); ctx.lineTo(hw*0.55,-hh*0.20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-hw*0.30,hh*0.26); ctx.lineTo(-hw*0.26,hh*0.80); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.55,-hh*0.20); ctx.lineTo(hw*0.58,hh*0.80); ctx.stroke();
    // Teardrop tank
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(hw*0.04,hh);
    ctx.quadraticCurveTo(hw*0.04,-hh*0.52,hw*0.40,-hh*0.55);
    ctx.quadraticCurveTo(hw*0.58,-hh*0.55,hw*0.58,-hh*0.20);
    ctx.lineTo(hw*0.58,hh);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.22)';
    ctx.beginPath();
    ctx.moveTo(hw*0.12,-hh*0.32); ctx.quadraticCurveTo(hw*0.28,-hh*0.48,hw*0.50,-hh*0.46);
    ctx.closePath(); ctx.fill();
    // V-twin engine
    ctx.fillStyle=D(b,10);
    this._drawRoundedRect(ctx,hw*0.08,hh*0.20,w*0.46,h*0.78,4); ctx.fill();
    ctx.fillStyle=b; ctx.globalAlpha=0.9;
    ctx.beginPath(); ctx.moveTo(hw*0.12,hh*0.20); ctx.lineTo(hw*0.24,-hh*0.42); ctx.lineTo(hw*0.26,hh*0.20); ctx.fill();
    ctx.beginPath(); ctx.moveTo(hw*0.30,hh*0.20); ctx.lineTo(hw*0.44,-hh*0.42); ctx.lineTo(hw*0.46,hh*0.20); ctx.fill();
    ctx.globalAlpha=1;
    // Long seat
    ctx.fillStyle=D(b,30);
    this._drawRoundedRect(ctx,-hw*0.32,-hh*0.30,w*0.48,h*0.38,5); ctx.fill();
    ctx.fillStyle=D(b,12);
    this._drawRoundedRect(ctx,-hw*0.32,-hh*0.38,w*0.48,h*0.22,4); ctx.fill();
    // Large rear fender
    ctx.fillStyle=D(b,15);
    ctx.beginPath(); ctx.arc(-hw*0.26,hh*0.20,h*0.72,-Math.PI,-Math.PI*0.05); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='#ccc'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(-hw*0.26,hh*0.20,h*0.62,-Math.PI,-Math.PI*0.15); ctx.stroke();
    // Front fender
    ctx.fillStyle=D(b,15);
    ctx.beginPath(); ctx.arc(hw*0.58,hh*0.25,h*0.65,-Math.PI*0.92,-Math.PI*0.08); ctx.closePath(); ctx.fill();
    // Chrome exhausts (long)
    ctx.strokeStyle='#bbb'; ctx.lineWidth=6;
    ctx.beginPath(); ctx.moveTo(hw*0.36,hh*0.62); ctx.quadraticCurveTo(-hw*0.02,hh*0.90,-hw*0.30,hh*0.82); ctx.stroke();
    ctx.fillStyle='#555';
    ctx.beginPath(); ctx.ellipse(-hw*0.32,hh*0.80,5,3,0.4,0,Math.PI*2); ctx.fill();
    // Pullback bars
    ctx.strokeStyle='#aaa'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hw*0.55,-hh*0.70); ctx.lineTo(hw*0.35,-hh*0.90); ctx.stroke();
    ctx.lineWidth=4.5;
    ctx.beginPath(); ctx.moveTo(hw*0.24,-hh*0.90); ctx.lineTo(hw*0.56,-hh*0.90); ctx.stroke();
    ctx.fillStyle='#333';
    ctx.beginPath(); ctx.arc(hw*0.22,-hh*0.90,5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(hw*0.58,-hh*0.90,5,0,Math.PI*2); ctx.fill();
    // Round headlight
    ctx.fillStyle='#222';
    ctx.beginPath(); ctx.arc(hw*0.74,-hh*0.28,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60);
    ctx.beginPath(); ctx.arc(hw*0.74,-hh*0.28,9,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,220,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.74,-hh*0.28,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#aaa'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(hw*0.74,-hh*0.28,11,0,Math.PI*2); ctx.stroke();
  }

  _bodySupermoto(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    this._bikeFrame(ctx,w,h,b,a,'upright');
    // Trellis frame (visible triangles)
    ctx.strokeStyle=a; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-hw*0.20,hh*0.30); ctx.lineTo(hw*0.48,-hh*0.22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-hw*0.20,hh*0.30); ctx.lineTo(-hw*0.16,hh*0.82); ctx.stroke();
    ctx.strokeStyle=D(b,20); ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.30); ctx.lineTo(-hw*0.16,hh*0.82); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.30); ctx.lineTo(-hw*0.18,hh*0.30); ctx.stroke();
    // Small fairing/tank
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(-hw*0.18,hh*0.32);
    ctx.quadraticCurveTo(-hw*0.14,-hh*0.72,hw*0.28,-hh*0.78);
    ctx.quadraticCurveTo(hw*0.50,-hh*0.82,hw*0.50,-hh*0.22);
    ctx.lineTo(hw*0.50,hh*0.32);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.20)';
    ctx.beginPath();
    ctx.moveTo(-hw*0.06,-hh*0.58); ctx.quadraticCurveTo(hw*0.18,-hh*0.70,hw*0.42,-hh*0.66);
    ctx.closePath(); ctx.fill();
    // Compact seat
    ctx.fillStyle='#333';
    this._drawRoundedRect(ctx,-hw*0.38,-hh*0.25,w*0.16,h*0.44,4); ctx.fill();
    ctx.fillStyle='#444';
    this._drawRoundedRect(ctx,-hw*0.38,-hh*0.30,w*0.16,h*0.25,3); ctx.fill();
    // Number board
    ctx.fillStyle=a;
    this._drawRoundedRect(ctx,hw*0.54,-hh*0.12,w*0.24,h*0.56,2); ctx.fill();
    ctx.fillStyle=b; ctx.font=`bold ${Math.max(6,h*0.32)}px Orbitron,monospace`; ctx.textAlign='center';
    ctx.fillText('1',hw*0.66,hh*0.16);
    // Flat track handlebars
    ctx.strokeStyle='#888'; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hw*0.38,-hh*0.72); ctx.lineTo(hw*0.72,-hh*0.78); ctx.stroke();
    // SM headlight (oval)
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.ellipse(hw*0.64,-hh*0.42,w*0.10,h*0.30,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=L(a,60); ctx.globalAlpha=0.9;
    ctx.beginPath(); ctx.ellipse(hw*0.64,-hh*0.42,w*0.07,h*0.20,0,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    // Upswept exhaust
    ctx.strokeStyle='#bbb'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.moveTo(hw*0.08,hh*0.60); ctx.quadraticCurveTo(-hw*0.14,hh*0.90,-hw*0.30,hh*0.78); ctx.stroke();
    ctx.fillStyle='#444';
    ctx.beginPath(); ctx.ellipse(-hw*0.32,hh*0.75,4,2.5,0.4,0,Math.PI*2); ctx.fill();
    // Rear sprocket (visible)
    ctx.strokeStyle=a; ctx.lineWidth=2; ctx.setLineDash([4,2]);
    ctx.beginPath(); ctx.arc(-hw*0.16,hh*0.82,h*0.30,0,Math.PI*2); ctx.stroke();
    ctx.setLineDash([]);
  }

  // ── Shared bike frame skeleton ───────────────────────
  _bikeFrame(ctx, w, h, b, a, style) {
    const hw=w/2, hh=h/2;
    ctx.strokeStyle=D(b,10); ctx.lineCap='round';
    switch(style) {
      case 'dirt':
        ctx.lineWidth=5;
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh); ctx.lineTo(hw*0.48,-hh*0.62); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh); ctx.lineTo(-hw*0.18,hh*0.62); ctx.stroke();
        ctx.lineWidth=4;
        ctx.beginPath(); ctx.moveTo(-hw*0.18,hh*0.62); ctx.lineTo(hw*0.48,-hh*0.62); ctx.stroke();
        // Fork (long travel)
        ctx.strokeStyle='#777'; ctx.lineWidth=5;
        ctx.beginPath(); ctx.moveTo(hw*0.48,-hh*0.62); ctx.lineTo(hw*0.58,-hh*0.82); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(hw*0.48,-hh*0.62); ctx.lineTo(hw*0.62,hh*0.78); ctx.stroke();
        break;
      case 'sport':
        ctx.lineWidth=4;
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.60); ctx.lineTo(hw*0.40,-hh*0.28); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.60); ctx.lineTo(-hw*0.18,hh*0.82); ctx.stroke();
        ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(-hw*0.18,hh*0.62); ctx.lineTo(hw*0.40,-hh*0.28); ctx.stroke();
        ctx.strokeStyle='#777'; ctx.lineWidth=4;
        ctx.beginPath(); ctx.moveTo(hw*0.40,-hh*0.28); ctx.lineTo(hw*0.52,-hh*0.68); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(hw*0.40,-hh*0.28); ctx.lineTo(hw*0.52,hh*0.82); ctx.stroke();
        break;
      default: // upright / compact
        ctx.lineWidth=4;
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.18); ctx.lineTo(hw*0.44,-hh*0.25); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-hw*0.22,hh*0.18); ctx.lineTo(-hw*0.18,hh*0.80); ctx.stroke();
        ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(-hw*0.18,hh*0.50); ctx.lineTo(hw*0.44,-hh*0.25); ctx.stroke();
        ctx.strokeStyle='#777'; ctx.lineWidth=4;
        ctx.beginPath(); ctx.moveTo(hw*0.44,-hh*0.25); ctx.lineTo(hw*0.52,-hh*0.68); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(hw*0.44,-hh*0.25); ctx.lineTo(hw*0.54,hh*0.80); ctx.stroke();
    }
  }

  // ── Fallbacks ────────────────────────────────────────
  _bodyGenericCar(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    ctx.fillStyle=b;
    this._drawRoundedRect(ctx,-hw,-hh,w,h,7); ctx.fill();
    ctx.fillStyle=a;
    this._drawRoundedRect(ctx,-hw,hh*0.1,w,h*0.28,4); ctx.fill();
    ctx.fillStyle='rgba(160,220,255,0.55)';
    this._drawRoundedRect(ctx,-hw*0.2,-hh*0.95,w*0.55,h*0.75,5); ctx.fill();
    ctx.strokeStyle=a; ctx.lineWidth=1.5;
    this._drawRoundedRect(ctx,-hw*0.2,-hh*0.95,w*0.55,h*0.75,5); ctx.stroke();
    ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=1;
    this._drawRoundedRect(ctx,-hw,-hh,w,h,7); ctx.stroke();
    ctx.fillStyle='rgba(255,240,150,0.95)';
    ctx.beginPath(); ctx.arc(hw*0.48,hh*0.05,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,50,50,0.9)';
    ctx.beginPath(); ctx.arc(-hw*0.48,hh*0.05,3,0,Math.PI*2); ctx.fill();
  }

  _bodyGenericBike(ctx, w, h, b, a) {
    const hw=w/2, hh=h/2;
    ctx.fillStyle=b;
    ctx.beginPath();
    ctx.moveTo(0,-hh*0.7); ctx.lineTo(hw*0.48,0); ctx.lineTo(0,hh*0.35); ctx.lineTo(-hw*0.48,0);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle=a; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hw*0.25,-hh*0.5); ctx.lineTo(hw*0.4,-hh*0.2); ctx.stroke();
    ctx.fillStyle=a;
    this._drawRoundedRect(ctx,-hw*0.28,-hh*0.55,hw*0.32*2,hh*0.22*2,3); ctx.fill();
    ctx.strokeStyle='#aaa'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hw*0.24,-hh*0.1); ctx.lineTo(hw*0.45,hh*0.38); ctx.stroke();
    ctx.fillStyle='rgba(255,240,150,0.9)';
    ctx.beginPath(); ctx.arc(hw*0.42,-hh*0.15,4,0,Math.PI*2); ctx.fill();
  }

  // ═══════════════════════════════════════════════════════
  // PICKUP ITEMS & BACKGROUNDS (unchanged from original)
  // ═══════════════════════════════════════════════════════

  _drawCoin(ctx, x, y) {
    ctx.save(); ctx.translate(x,y);
    const r=10;
    const grd=ctx.createRadialGradient(-4,-4,2,0,0,r);
    grd.addColorStop(0,'#fff9c4'); grd.addColorStop(0.4,'#ffe082'); grd.addColorStop(1,'#fbc02d');
    ctx.fillStyle=grd;
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,r-2,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }

  _drawFuel(ctx, x, y) {
    ctx.save(); ctx.translate(x,y); ctx.rotate(-0.1);
    ctx.fillStyle='#ff7043';
    this._drawRoundedRect(ctx,-12,-18,24,30,4); ctx.fill();
    ctx.fillStyle='#ffccbc'; ctx.fillRect(-5,-22,10,6);
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-6,-6); ctx.lineTo(0,4); ctx.lineTo(6,-6); ctx.stroke();
    ctx.restore();
  }

  _drawBoost(ctx, x, y) {
    ctx.save(); ctx.translate(x,y); ctx.rotate(0.1);
    ctx.fillStyle='#40c4ff';
    this._drawRoundedRect(ctx,-10,-14,20,26,4); ctx.fill();
    ctx.strokeStyle='#e1f5fe'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-6,4); ctx.lineTo(0,-6); ctx.lineTo(6,4); ctx.stroke();
    ctx.restore();
  }

  _drawFinishFlag(ctx, x, y) {
    ctx.save(); ctx.translate(x, y+80);
    ctx.fillStyle='#4e342e'; ctx.fillRect(-3,-80,6,80);
    const flagH=40, flagW=40;
    const offset=Math.sin(Date.now()/250)*3;
    ctx.translate(0,-70);
    ctx.beginPath(); ctx.moveTo(0,0);
    ctx.quadraticCurveTo(flagW*0.4,offset,flagW,6);
    ctx.lineTo(flagW,flagH); ctx.lineTo(0,flagH-2); ctx.closePath(); ctx.clip();
    for(let i=0;i<4;i++) for(let j=0;j<4;j++) {
      ctx.fillStyle=(i+j)%2===0?'#ffffff':'#000000';
      ctx.fillRect((flagW/4)*i,(flagH/4)*j,flagW/4,flagH/4);
    }
    ctx.restore();
  }

  // ═══════════════════════════════════════════════════════
  // BACKGROUND DRAWING (unchanged)
  // ═══════════════════════════════════════════════════════

  _drawBackground({ theme, cameraX }) {
    const ctx=this.ctx, w=this.width, h=this.height, t=Date.now()/1000;
    switch(theme) {
      case 'pastelFields': case 'pastelHills': case 'farm': case 'meadow': case 'plains': case 'orchard':
        this._sky(ctx,w,h,'#b8f0ff','#d4aaff','#a8e6c4');
        this._sun(ctx,w*0.82,h*0.12,38,'#fff9c4','#ffdd00');
        this._clouds(ctx,w,h,cameraX,0.06,[[0.10,0.12,80,30],[0.35,0.08,100,25],[0.65,0.18,70,22],[0.85,0.10,90,28]],'#ffffffcc');
        this._hillLayer(ctx,w,h,cameraX*0.15,h*0.68,70,1.4,'#6fcf97');
        this._hillLayer(ctx,w,h,cameraX*0.28,h*0.76,45,2.1,'#27ae60');
        break;
      case 'beach':
        this._sky(ctx,w,h,'#87ceeb','#c8e8f8','#f0d870');
        this._sun(ctx,w*0.75,h*0.10,42,'#fff9c4','#ffd700');
        this._clouds(ctx,w,h,cameraX,0.05,[[0.15,0.12,110,28],[0.55,0.09,85,22],[0.78,0.16,95,24]],'#ffffffbb');
        { const og=ctx.createLinearGradient(0,h*0.54,0,h*0.72); og.addColorStop(0,'#40c9e0'); og.addColorStop(1,'#1e7ab8'); ctx.fillStyle=og; ctx.fillRect(0,h*0.54,w,h*0.18); }
        this._hillLayer(ctx,w,h,cameraX*0.20,h*0.72,30,1.5,'#f5cba0');
        break;
      case 'cliffs':
        this._sky(ctx,w,h,'#87afd4','#b8d0e8','#6898b8');
        this._sun(ctx,w*0.80,h*0.13,35,'#fff9c4','#fbbf2e');
        this._clouds(ctx,w,h,cameraX,0.07,[[0.12,0.14,100,30],[0.50,0.10,80,25],[0.80,0.17,90,26]],'#ffffffcc');
        this._hillLayer(ctx,w,h,cameraX*0.12,h*0.58,90,0.8,'#5d7a8a');
        this._hillLayer(ctx,w,h,cameraX*0.22,h*0.70,55,1.3,'#4a6175');
        break;
      case 'lake':
        this._sky(ctx,w,h,'#6bb8e8','#a8d4f0','#80b8d8');
        this._sun(ctx,w*0.78,h*0.11,36,'#fff9c4','#ffd700');
        this._clouds(ctx,w,h,cameraX,0.05,[[0.10,0.11,95,26],[0.45,0.08,75,22],[0.72,0.15,85,24]],'#ffffffcc');
        { const lg=ctx.createLinearGradient(0,h*0.60,0,h*0.76); lg.addColorStop(0,'rgba(110,185,230,0.85)'); lg.addColorStop(1,'rgba(50,120,180,0.70)'); ctx.fillStyle=lg; ctx.fillRect(0,h*0.60,w,h*0.16); }
        this._hillLayer(ctx,w,h,cameraX*0.18,h*0.72,50,1.6,'#4e8a68');
        break;
      case 'forest': case 'jungle': case 'rainforest': {
        const j=theme!=='forest';
        this._sky(ctx,w,h,j?'#1a5c3a':'#2c7a4b',j?'#2e8b57':'#3a9a5e','#1a3d28');
        ctx.save(); ctx.globalAlpha=0.2; { const mg=ctx.createLinearGradient(0,h*0.5,0,h); mg.addColorStop(0,'transparent'); mg.addColorStop(1,'#a8d8a8'); ctx.fillStyle=mg; ctx.fillRect(0,0,w,h); } ctx.restore();
        this._treeSilhouette(ctx,w,h,cameraX,0.12,h*0.45,60,30,'#1a4a28',false);
        this._treeSilhouette(ctx,w,h,cameraX,0.22,h*0.55,50,25,'#0f3a1e',false);
        break; }
      case 'mountain':
        this._sky(ctx,w,h,'#4a6fa5','#7bb3d4','#c8dce8');
        this._sun(ctx,w*0.70,h*0.10,30,'#fff9c4','#ffd700');
        this._clouds(ctx,w,h,cameraX,0.08,[[0.20,0.12,100,30],[0.60,0.09,80,24],[0.85,0.16,90,26]],'#ffffffaa');
        this._mountainLayer(ctx,w,h,cameraX*0.10,h*0.50,130,0.6,'#8eaec4','#f5f5f5');
        this._mountainLayer(ctx,w,h,cameraX*0.20,h*0.64,90,0.9,'#6a8ea8',null);
        break;
      case 'desert':
        this._sky(ctx,w,h,'#f5a623','#ffd27f','#fff0b3');
        this._sun(ctx,w*0.85,h*0.09,48,'#fff9c4','#ff9900');
        ctx.save(); ctx.globalAlpha=0.07+Math.sin(t*3)*0.04; ctx.fillStyle='#ff8800'; ctx.fillRect(0,h*0.55,w,h*0.15); ctx.restore();
        this._hillLayer(ctx,w,h,cameraX*0.15,h*0.72,40,0.8,'#c79a60');
        this._hillLayer(ctx,w,h,cameraX*0.28,h*0.80,25,1.2,'#d4a96a');
        break;
      case 'snow':
        this._sky(ctx,w,h,'#b0c8e8','#d8e8f5','#eef4fb');
        this._sun(ctx,w*0.72,h*0.11,30,'#ffffffaa','#c8ddf0');
        this._clouds(ctx,w,h,cameraX,0.06,[[0.10,0.10,110,35],[0.45,0.08,90,30],[0.75,0.15,100,28]],'#fff');
        this._snowflakes(ctx,w,h,cameraX,t,60);
        this._mountainLayer(ctx,w,h,cameraX*0.10,h*0.55,110,0.7,'#d8ecf8','#ffffff');
        this._mountainLayer(ctx,w,h,cameraX*0.20,h*0.68,75,1.1,'#c0daf0',null);
        break;
      case 'arctic':
        this._sky(ctx,w,h,'#80b4d8','#b8d8f0','#ddeeff');
        ctx.save(); ctx.globalAlpha=0.16+Math.sin(t*0.8)*0.07; { const ag=ctx.createLinearGradient(0,0,w,h*0.5); ag.addColorStop(0,'#00ff88'); ag.addColorStop(0.5,'#00ccff'); ag.addColorStop(1,'#aa00ff'); ctx.fillStyle=ag; ctx.fillRect(0,0,w,h*0.5); } ctx.restore();
        this._snowflakes(ctx,w,h,cameraX,t,40);
        this._mountainLayer(ctx,w,h,cameraX*0.08,h*0.52,120,0.5,'#a8d0e8','#ffffff');
        break;
      case 'canyon':
        this._sky(ctx,w,h,'#e8a050','#c05020','#802000');
        this._sun(ctx,w*0.15,h*0.10,35,'#fff9c4','#ff6600');
        this._hillLayer(ctx,w,h,cameraX*0.10,h*0.42,120,0.5,'#8b4513');
        this._hillLayer(ctx,w,h,cameraX*0.18,h*0.58,80,0.7,'#a0522d');
        this._hillLayer(ctx,w,h,cameraX*0.28,h*0.72,50,1.0,'#cd853f');
        break;
      case 'volcano':
        this._sky(ctx,w,h,'#1a0500','#4d1200','#8b2500');
        { const lg=ctx.createLinearGradient(0,h*0.6,0,h); lg.addColorStop(0,'transparent'); lg.addColorStop(1,'rgba(255,60,0,0.55)'); ctx.fillStyle=lg; ctx.fillRect(0,0,w,h); }
        this._volcanoShape(ctx,w,h,cameraX*0.12,'#3a1000');
        this._ashParticles(ctx,w,h,cameraX,t,'#555555');
        break;
      case 'swamp':
        this._sky(ctx,w,h,'#2a3318','#3b4a20','#546230');
        ctx.save(); ctx.globalAlpha=0.18+Math.sin(t*0.5)*0.05; ctx.fillStyle='#8fba6e'; ctx.fillRect(0,h*0.45,w,h*0.55); ctx.restore();
        this._treeSilhouette(ctx,w,h,cameraX,0.14,h*0.48,50,12,'#1e2c10',true);
        this._treeSilhouette(ctx,w,h,cameraX,0.24,h*0.60,40,10,'#162209',true);
        break;
      case 'storm':
        this._sky(ctx,w,h,'#1a1e2a','#2c3040','#3e4555');
        { const flash=Math.pow(Math.max(0,Math.sin(t*0.7+1.5)),20); if(flash>0.1){ctx.save();ctx.globalAlpha=flash*0.4;ctx.fillStyle='#aaaaff';ctx.fillRect(0,0,w,h);ctx.restore();} }
        this._clouds(ctx,w,h,cameraX,0.09,[[0.05,0.05,200,60],[0.40,0.08,180,55],[0.70,0.04,160,50]],'#222530cc');
        this._hillLayer(ctx,w,h,cameraX*0.15,h*0.65,60,1.0,'#2c3040');
        break;
      case 'space': case 'asteroid':
        this._sky(ctx,w,h,'#020510','#04071a','#06091f');
        this._stars(ctx,w,h,cameraX,180,t);
        { const px=w*0.80-cameraX*0.01,py=h*0.18,pr=45; const pg=ctx.createRadialGradient(px-12,py-12,5,px,py,pr); const c1=theme==='space'?'#4060c0':'#806040'; const c2=theme==='space'?'#203080':'#604020'; pg.addColorStop(0,c1);pg.addColorStop(0.6,c2);pg.addColorStop(1,'#101010'); ctx.fillStyle=pg;ctx.beginPath();ctx.arc(px,py,pr,0,Math.PI*2);ctx.fill(); if(theme==='asteroid'){ctx.save();ctx.strokeStyle='rgba(180,140,80,0.55)';ctx.lineWidth=8;ctx.beginPath();ctx.ellipse(px,py,pr*1.8,pr*0.35,0.15*Math.PI,0,Math.PI*2);ctx.stroke();ctx.restore();} }
        break;
      case 'moon':
        this._sky(ctx,w,h,'#030308','#050510','#0a0a18');
        this._stars(ctx,w,h,cameraX,220,t);
        { const ex=w*0.20-cameraX*0.008,ey=h*0.15,er=50; const eg=ctx.createRadialGradient(ex-14,ey-14,6,ex,ey,er); eg.addColorStop(0,'#4488ff');eg.addColorStop(0.4,'#2255cc');eg.addColorStop(1,'#0d2255'); ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ex,ey,er,0,Math.PI*2);ctx.fill(); }
        break;
      case 'cave': case 'nightmare':
        this._sky(ctx,w,h,'#050508','#0a0a10','#080810');
        ctx.save();ctx.globalAlpha=0.12+Math.sin(t*0.6)*0.04;ctx.fillStyle=theme==='nightmare'?'#800000':'#00004a';ctx.fillRect(0,0,w,h);ctx.restore();
        this._stalactites(ctx,w,h,cameraX,theme==='nightmare'?'#1a0000':'#0a0a1a');
        break;
      case 'underwater':
        this._sky(ctx,w,h,'#001a2e','#00304d','#00426a');
        ctx.save();ctx.globalAlpha=0.06+Math.sin(t*2)*0.03;
        for(let i=0;i<8;i++){const rx=((w*0.13*i-cameraX*0.03)%(w*1.1)+w*1.1)%(w*1.1)-w*0.05;ctx.fillStyle='#80e0ff';ctx.beginPath();ctx.moveTo(rx,0);ctx.lineTo(rx-20,h*0.65);ctx.lineTo(rx+20,h*0.65);ctx.closePath();ctx.fill();}
        ctx.restore();
        this._bubbles(ctx,w,h,cameraX,t);
        break;
      case 'lava':
        this._sky(ctx,w,h,'#100000','#300500','#600800');
        { const lg=ctx.createLinearGradient(0,h*0.5,0,h); lg.addColorStop(0,'transparent'); lg.addColorStop(1,'rgba(255,80,0,0.55)'); ctx.fillStyle=lg; ctx.fillRect(0,0,w,h); }
        this._volcanoShape(ctx,w,h,cameraX*0.14,'#1a0800');
        this._ashParticles(ctx,w,h,cameraX,t,'#ff4400');
        break;
      case 'inferno':
        this._sky(ctx,w,h,'#0a0000','#220400','#440800');
        { const ig=ctx.createLinearGradient(0,h*0.4,0,h); ig.addColorStop(0,'transparent'); ig.addColorStop(1,'rgba(255,30,0,0.65)'); ctx.fillStyle=ig; ctx.fillRect(0,0,w,h); }
        this._ashParticles(ctx,w,h,cameraX,t,'#ff3300');
        this._ashParticles(ctx,w,h,cameraX,t+Math.PI,'#ff8800');
        break;
      case 'chaos': case 'final':
        this._sky(ctx,w,h,'#08000f','#120520','#1e0830');
        this._stars(ctx,w,h,cameraX,100,t);
        ctx.save();ctx.globalAlpha=0.14+Math.sin(t*1.2)*0.07;{ const wg=ctx.createLinearGradient(0,0,w,h); wg.addColorStop(0,'#ff00ff');wg.addColorStop(0.5,'#0080ff');wg.addColorStop(1,'#ff4400'); ctx.fillStyle=wg;ctx.fillRect(0,0,w,h); }ctx.restore();
        break;
      default:
        this._sky(ctx,w,h,'#5ee7df','#b490ca','#355c7d');
        this._sun(ctx,w*0.80,h*0.12,36,'#fff9c4','#ffd700');
        this._clouds(ctx,w,h,cameraX,0.06,[[0.15,0.12,90,26],[0.55,0.09,75,22],[0.80,0.16,85,24]],'#ffffffcc');
        this._hillLayer(ctx,w,h,cameraX*0.15,h*0.68,60,1.4,'#6fcf97');
    }
  }

  _sky(ctx,w,h,top,mid,bot){const g=ctx.createLinearGradient(0,0,0,h);g.addColorStop(0,top);g.addColorStop(0.55,mid);g.addColorStop(1,bot);ctx.fillStyle=g;ctx.fillRect(0,0,w,h);}
  _sun(ctx,x,y,r,ic,oc){const glow=ctx.createRadialGradient(x,y,r*0.3,x,y,r*2.8);glow.addColorStop(0,oc+'66');glow.addColorStop(1,'transparent');ctx.fillStyle=glow;ctx.beginPath();ctx.arc(x,y,r*2.8,0,Math.PI*2);ctx.fill();const disc=ctx.createRadialGradient(x-r*0.3,y-r*0.3,r*0.1,x,y,r);disc.addColorStop(0,ic);disc.addColorStop(1,oc);ctx.fillStyle=disc;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();}
  _stars(ctx,w,h,cameraX,count,t){ctx.save();for(let i=0;i<count;i++){const s=i*9973.3;const sx=(((s*0.137%1)*w*3-cameraX*0.02)%(w*3)+w*3)%(w*3)-w;const sy=(s*0.251%1)*h*0.88;const sr=0.7+(s*0.07%1)*1.5;ctx.globalAlpha=(0.4+Math.sin(t*(1+s*0.001)+s)*0.4)*0.95;ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(sx,sy,sr,0,Math.PI*2);ctx.fill();}ctx.restore();}
  _clouds(ctx,w,h,cameraX,parallax,defs,color){ctx.save();ctx.fillStyle=color;for(const[xf,yf,cw,ch]of defs){const cx=(((xf*w*2-cameraX*parallax)%(w*1.6))+w*1.6)%(w*1.6)-w*0.1;const cy=h*yf;ctx.save();ctx.globalAlpha=0.85;ctx.beginPath();ctx.ellipse(cx,cy,cw*0.5,ch*0.5,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(cx-cw*0.30,cy+ch*0.15,cw*0.35,ch*0.40,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(cx+cw*0.32,cy+ch*0.18,cw*0.38,ch*0.42,0,0,Math.PI*2);ctx.fill();ctx.restore();}ctx.restore();}
  _hillLayer(ctx,w,h,offsetX,baseY,amplitude,freq,color){ctx.beginPath();for(let x=0;x<=w;x+=4){const ox=x+offsetX;const y=baseY-Math.abs(Math.sin(ox*0.008*freq)*amplitude+Math.sin(ox*0.013*freq+1.2)*amplitude*0.4);x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fillStyle=color;ctx.fill();}
  _mountainLayer(ctx,w,h,offsetX,baseY,amplitude,freq,color,snowColor){const pts=[];ctx.beginPath();for(let x=0;x<=w;x+=4){const ox=x+offsetX;const y=baseY-Math.abs(Math.sin(ox*0.005*freq)*amplitude+Math.cos(ox*0.009*freq+0.5)*amplitude*0.55);pts.push({x,y});x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fillStyle=color;ctx.fill();if(snowColor){const threshold=baseY-amplitude*0.72;ctx.beginPath();let inSnow=false;for(const{x,y}of pts){if(y<threshold){if(!inSnow){ctx.moveTo(x,threshold);inSnow=true;}ctx.lineTo(x,y);}else if(inSnow){ctx.lineTo(x,threshold);inSnow=false;}}ctx.fillStyle=snowColor+'cc';ctx.fill();}}
  _treeSilhouette(ctx,w,h,cameraX,parallax,baseY,treeH,treeW,color,dead){ctx.fillStyle=color;const offset=cameraX*parallax;const spacing=treeW*2.6;const count=Math.ceil(w/spacing)+5;for(let i=0;i<count;i++){const tx=((i*spacing*1.35-offset)%(w*1.6)+w*1.6)%(w*1.6)-w*0.1;if(dead){ctx.fillRect(tx-treeW*0.1,baseY-treeH,treeW*0.2,treeH);ctx.fillRect(tx-treeW*0.4,baseY-treeH*0.7,treeW*0.8,treeW*0.15);ctx.fillRect(tx-treeW*0.25,baseY-treeH*0.45,treeW*0.5,treeW*0.12);}else{ctx.beginPath();ctx.moveTo(tx,baseY-treeH);ctx.lineTo(tx-treeW*0.55,baseY);ctx.lineTo(tx+treeW*0.55,baseY);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(tx,baseY-treeH*1.25);ctx.lineTo(tx-treeW*0.4,baseY-treeH*0.35);ctx.lineTo(tx+treeW*0.4,baseY-treeH*0.35);ctx.closePath();ctx.fill();}}}
  _volcanoShape(ctx,w,h,offsetX,color){const vx=((w*0.70-offsetX)%(w*1.5)+w*1.5)%(w*1.5);ctx.beginPath();ctx.moveTo(vx-w*0.36,h);ctx.lineTo(vx-28,h*0.30);ctx.lineTo(vx+28,h*0.30);ctx.lineTo(vx+w*0.36,h);ctx.closePath();ctx.fillStyle=color;ctx.fill();}
  _stalactites(ctx,w,h,cameraX,color){ctx.fillStyle=color;const offset=cameraX*0.25;const count=Math.ceil(w/60)+4;for(let i=0;i<count;i++){const sx=((i*72+(i%3)*18-offset)%(w*1.5)+w*1.5)%(w*1.5)-20;const sh=40+(i*37%62);ctx.beginPath();ctx.moveTo(sx-18,0);ctx.lineTo(sx+18,0);ctx.lineTo(sx,sh);ctx.closePath();ctx.fill();}}
  _snowflakes(ctx,w,h,cameraX,t,count){ctx.save();for(let i=0;i<count;i++){const s=i*7919.1;const sx=(((s*0.23%1)*w*2-cameraX*0.04+t*(28+s*0.002%20))%(w*1.3)+w*1.3)%(w*1.3)-w*0.1;const sy=((s*0.17%1)*h+t*(18+s*0.001%30))%h;ctx.globalAlpha=0.35+(s*0.1%1)*0.5;ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(sx,sy,1+(s*0.05%1)*2,0,Math.PI*2);ctx.fill();}ctx.restore();}
  _ashParticles(ctx,w,h,cameraX,t,color){ctx.save();ctx.fillStyle=color;for(let i=0;i<35;i++){const s=i*6547.3;const ax=(((s*0.31%1)*w*1.5-cameraX*0.05+t*(14+s*0.001%24))%(w*1.4)+w*1.4)%(w*1.4)-w*0.15;const ay=h-((s*0.19%1)*h*0.8+t*(22+s*0.002%38))%h;ctx.globalAlpha=0.2+(s*0.07%1)*0.5;ctx.beginPath();ctx.arc(ax,ay,1.5+(s*0.04%1)*2.5,0,Math.PI*2);ctx.fill();}ctx.restore();}
  _bubbles(ctx,w,h,cameraX,t){ctx.save();for(let i=0;i<22;i++){const s=i*8431.7;const bx=(s*0.25%1)*w;const by=h-((s*0.13%1)*h*0.9+t*(28+s*0.002%48))%h;ctx.globalAlpha=0.25+(s*0.08%1)*0.3;ctx.strokeStyle='#80e0ff';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(bx,by,2+(s*0.06%1)*5,0,Math.PI*2);ctx.stroke();}ctx.restore();}
}
// ===== hud.js =====
// hud.js - HUD gauges and text overlays

class Hud {
  constructor() {
    this.coinEl = document.getElementById("hud-coin-count");
    this.distCurrentEl = document.getElementById("hud-distance-current");
    this.distBestEl = document.getElementById("hud-distance-best");

    this.rpmCanvas = document.getElementById("gauge-rpm");
    this.fuelCanvas = document.getElementById("gauge-fuel");
    this.boostCanvas = document.getElementById("gauge-boost");

    this.rpmCtx = this.rpmCanvas.getContext("2d");
    this.fuelCtx = this.fuelCanvas.getContext("2d");
    this.boostCtx = this.boostCanvas.getContext("2d");

    this.lowFuel = false;
  }

  setLowFuel(enabled) {
    this.lowFuel = enabled;
    const hud = document.getElementById("hud");
    if (hud) {
      hud.classList.toggle("flash-low-fuel", enabled);
    }
  }

  update({ coins, distance, bestDistance, rpm, fuel, fuelMax, boost, boostMax }) {
    if (this.coinEl) this.coinEl.textContent = Math.floor(coins).toString();
    if (this.distCurrentEl) this.distCurrentEl.textContent = `${distance.toFixed(1)} m`;
    if (this.distBestEl) this.distBestEl.textContent = `Best: ${bestDistance.toFixed(1)} m`;

    this.drawGauge(this.rpmCtx, this.rpmCanvas, rpm / 600, "RPM");
    this.drawGauge(this.fuelCtx, this.fuelCanvas, fuel / (fuelMax || 1), "Fuel");
    this.drawGauge(this.boostCtx, this.boostCanvas, boost / (boostMax || 1), "Boost");
  }

  drawGauge(ctx, canvas, value, label) {
    if (!ctx || !canvas) return;
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);

    const cx = w / 2;
    const cy = h / 2;
    const r = Math.min(w, h) / 2 - 6;

    ctx.save();
    ctx.translate(cx, cy);

    ctx.beginPath();
    ctx.arc(0, 0, r, Math.PI * 0.75, Math.PI * 2.25);
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.lineWidth = 5;
    ctx.stroke();

    const clamped = Math.max(0, Math.min(1, value));
    ctx.beginPath();
    ctx.arc(
      0,
      0,
      r,
      Math.PI * 0.75,
      Math.PI * 0.75 + clamped * Math.PI * 1.5
    );
    const grad = ctx.createLinearGradient(-r, 0, r, 0);
    grad.addColorStop(0, "#4facfe");
    grad.addColorStop(1, "#00f2fe");
    ctx.strokeStyle = grad;
    ctx.lineWidth = 6;
    ctx.stroke();

    const needleAngle = Math.PI * 0.75 + clamped * Math.PI * 1.5;
    ctx.rotate(needleAngle);
    ctx.beginPath();
    ctx.moveTo(-4, 0);
    ctx.lineTo(r - 6, 0);
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.rotate(-needleAngle);

    ctx.beginPath();
    ctx.arc(0, 0, 4, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();

    ctx.fillStyle = "#ffffff";
    ctx.font = "10px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(label, 0, r * 0.35);

    ctx.restore();
  }
}


// ===== input.js =====
// input.js - keyboard + touch input handler

class InputManager {
  constructor(canvas) {
    this.canvas = canvas;
    this.gas = false;
    this.brake = false;
    this.boost = false;

    this._bindEvents();
  }

  _bindEvents() {
    window.addEventListener("keydown", (e) => {
      if (e.code === "ArrowRight" || e.code === "KeyD") this.gas = true;
      if (e.code === "ArrowLeft" || e.code === "KeyA") this.brake = true;
      if (e.code === "Space") this.boost = true;
    });

    window.addEventListener("keyup", (e) => {
      if (e.code === "ArrowRight" || e.code === "KeyD") this.gas = false;
      if (e.code === "ArrowLeft" || e.code === "KeyA") this.brake = false;
      if (e.code === "Space") this.boost = false;
    });

    const btnGas = document.getElementById("btn-gas");
    const btnBrake = document.getElementById("btn-brake");

    const pressGas = (e) => {
      e.preventDefault();
      this.gas = true;
    };
    const releaseGas = (e) => {
      e.preventDefault();
      this.gas = false;
    };
    const pressBrake = (e) => {
      e.preventDefault();
      this.brake = true;
    };
    const releaseBrake = (e) => {
      e.preventDefault();
      this.brake = false;
    };

    if (btnGas) {
      btnGas.addEventListener("touchstart", pressGas);
      btnGas.addEventListener("touchend", releaseGas);
      btnGas.addEventListener("touchcancel", releaseGas);
      btnGas.addEventListener("mousedown", pressGas);
      window.addEventListener("mouseup", releaseGas);
    }
    if (btnBrake) {
      btnBrake.addEventListener("touchstart", pressBrake);
      btnBrake.addEventListener("touchend", releaseBrake);
      btnBrake.addEventListener("touchcancel", releaseBrake);
      btnBrake.addEventListener("mousedown", pressBrake);
      window.addEventListener("mouseup", releaseBrake);
    }

    const onTouch = (e) => {
      if (!this.canvas) return;
      const rect = this.canvas.getBoundingClientRect();
      this.gas = false;
      this.brake = false;
      for (const touch of e.touches) {
        const x = touch.clientX - rect.left;
        if (x < rect.width * 0.4) this.brake = true;
        else if (x > rect.width * 0.6) this.gas = true;
      }
    };
    const clearTouch = () => {
      this.gas = false;
      this.brake = false;
    };

    this.canvas.addEventListener("touchstart", onTouch);
    this.canvas.addEventListener("touchmove", onTouch);
    this.canvas.addEventListener("touchend", clearTouch);
    this.canvas.addEventListener("touchcancel", clearTouch);
  }

  isGasPressed() {
    return this.gas;
  }

  isBrakePressed() {
    return this.brake;
  }

  isBoostPressed() {
    return this.boost;
  }
}


// ===== ui.js =====
// ui.js — Menus, screens, transitions, vehicle and level selection
// Enhanced version — 100% original code, free to publish (no copyright claims)


/* ─── Particle burst helper (upgrade screen sparkles) ─── */
function _burst(x, y, color) {
  const palette = [color, '#ffd700', '#ffffff', '#a78bfa', '#34d399'];
  for (let i = 0; i < 16; i++) {
    const el = document.createElement('div');
    el.className = 'burst-particle';
    const size  = 4 + Math.random() * 7;
    const angle = (Math.PI * 2 * i) / 16 + Math.random() * 0.4;
    const dist  = 35 + Math.random() * 70;
    const tx    = Math.cos(angle) * dist;
    const ty    = Math.sin(angle) * dist;
    const dur   = 500 + Math.random() * 400;
    el.style.cssText = `left:${x}px;top:${y}px;width:${size}px;height:${size}px;
      background:${palette[i % palette.length]};transform:translate(-50%,-50%);
      box-shadow:0 0 6px ${palette[i % palette.length]};`;
    el.animate(
      [
        { transform: 'translate(-50%,-50%) scale(1)',                                   opacity: 1 },
        { transform: `translate(calc(-50% + ${tx}px),calc(-50% + ${ty}px)) scale(0)`, opacity: 0 },
      ],
      { duration: dur, easing: 'ease-out', fill: 'forwards' }
    );
    document.body.appendChild(el);
    setTimeout(() => el.remove(), dur + 100);
  }
}

/* ─── Spawn ambient particles in upgrade stage ─────────── */
let _stageParticleTimer = null;
function _startStageParticles() {
  _stopStageParticles();
  _stageParticleTimer = setInterval(() => {
    const stage = document.querySelector('.upgr-stage');
    if (!stage) return;
    const p = document.createElement('div');
    p.className = 'burst-particle';
    const size   = 2 + Math.random() * 4;
    const colors = ['#63caff','#a78bfa','#34d399','#ffd700','#fb923c'];
    const col    = colors[Math.floor(Math.random() * colors.length)];
    p.style.cssText = `
      width:${size}px;height:${size}px;
      left:${10 + Math.random() * 80}%;
      top:${20 + Math.random() * 55}%;
      background:${col};
      box-shadow:0 0 6px ${col};
      position:absolute;
      animation:sparkle ${1.5 + Math.random() * 2}s ease-in-out ${Math.random() * 1}s infinite;
    `;
    stage.appendChild(p);
    setTimeout(() => p.remove(), 5000);
  }, 900);
}
function _stopStageParticles() {
  if (_stageParticleTimer) { clearInterval(_stageParticleTimer); _stageParticleTimer = null; }
  document.querySelectorAll('.upgr-stage .burst-particle').forEach(p => p.remove());
}

function initUI(api) {
  console.log('Initializing UI...');

  const mainMenu    = document.getElementById("screen-main-menu");
  const levelSelect = document.getElementById("screen-level-select");
  const garage      = document.getElementById("screen-garage");
  const pauseScreen = document.getElementById("screen-pause");
  const adScreen    = document.getElementById("screen-ad");
  const gameoverScreen = document.getElementById("screen-gameover");

  if (!mainMenu || !levelSelect || !garage) {
    console.error('Critical UI elements missing!');
    return;
  }

  const screens = { main: mainMenu, level: levelSelect, garage, pause: pauseScreen, ad: adScreen, gameover: gameoverScreen };

  function showScreen(name) {
    Object.values(screens).forEach(el => el && el.classList.remove("active"));
    if (screens[name]) screens[name].classList.add("active");

    const btnBrake = document.getElementById("btn-brake");
    const btnGas   = document.getElementById("btn-gas");
    const hudGauges= document.getElementById("hud-gauges");
    const isGameplay = name === null || name === undefined;
    if (btnBrake)  btnBrake.style.visibility  = isGameplay ? "visible" : "hidden";
    if (btnGas)    btnGas.style.visibility    = isGameplay ? "visible" : "hidden";
    if (hudGauges) hudGauges.style.visibility = isGameplay ? "visible" : "hidden";
  }

  showScreen("main");

  if (!vehicles || vehicles.length === 0) {
    console.error('Vehicles array is empty or not loaded!');
  } else {
    console.log('Loaded', vehicles.length, 'vehicles');
  }

  const btnPlay        = document.getElementById("btn-play");
  const btnGarage      = document.getElementById("btn-garage");
  const btnLevels      = document.getElementById("btn-levels");
  const btnSettings    = document.getElementById("btn-settings");
  const btnLeaderboard = document.getElementById("btn-leaderboard");

  if (btnPlay) {
    btnPlay.onclick = () => {
      console.log('Play button clicked');
      try {
        const sel = api.getCurrentSelection();
        api.startRun({ levelId: sel.levelId, vehicleId: sel.vehicleId });
        showScreen(null);
      } catch (error) {
        console.error('Error starting game:', error);
        alert('Failed to start game. Check console for details.');
      }
    };
  } else { console.error('Play button not found!'); }

  if (btnGarage) {
    btnGarage.onclick = () => { showScreen("garage"); renderGarage(); };
  } else { console.error('Garage button not found!'); }

  if (btnLevels)      btnLevels.onclick      = () => { showScreen("level"); renderLevelSelect(); };
  if (btnSettings)    btnSettings.onclick    = () => { window.location.href='settings.html'; };
  if (btnLeaderboard) btnLeaderboard.onclick = () => { alert('Local leaderboard: Your best distance is ' + (new Storage(localStorage).getBestDistanceOverall().toFixed(1)) + ' m'); };

  document.querySelectorAll(".btn-back").forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target");
      Object.values(screens).forEach(el => el && el.classList.remove("active"));
      const el = document.getElementById(targetId);
      if (el) el.classList.add("active");
    });
  });

  const btnPause = document.getElementById("btn-pause");
  if (btnPause) btnPause.onclick = () => { window.dispatchEvent(new Event("game:pause")); showScreen("pause"); };

  const btnResume  = document.getElementById("btn-resume");
  const btnRestart = document.getElementById("btn-restart");
  const btnQuit    = document.getElementById("btn-quit");
  if (btnResume)  btnResume.onclick  = () => { showScreen(null); window.dispatchEvent(new Event("game:resume")); };
  if (btnRestart) btnRestart.onclick = () => { showScreen(null); window.dispatchEvent(new Event("game:restart")); };
  if (btnQuit)    btnQuit.onclick    = () => { showScreen("main"); window.dispatchEvent(new Event("game:quit")); };

  const gameoverTitle   = document.getElementById("gameover-title");
  const gameoverSummary = document.getElementById("gameover-summary");
  const gameoverStars   = document.getElementById("gameover-stars");
  const btnAdContinue   = document.getElementById("btn-ad-continue");
  const adSlot          = document.getElementById("ad-slot-interstitial");

  let pendingResult = null;

  const btnGoRestart = document.getElementById("btn-gameover-restart");
  const btnGoLevels  = document.getElementById("btn-gameover-levels");
  const btnGoMain    = document.getElementById("btn-gameover-main");

  if (btnGoRestart) btnGoRestart.onclick = () => { showScreen(null); window.dispatchEvent(new Event("game:restart")); };
  if (btnGoLevels)  btnGoLevels.onclick  = () => { showScreen("level"); renderLevelSelect(); window.dispatchEvent(new Event("game:quit")); };
  if (btnGoMain)    btnGoMain.onclick    = () => { showScreen("main"); window.dispatchEvent(new Event("game:quit")); };

  function showGameoverFromResult(d) {
    if (!d) return;
    if (gameoverTitle)   gameoverTitle.textContent   = d.reachedFinish ? "Level Complete! 🏆" : "Game Over 💥";
    if (gameoverSummary) gameoverSummary.textContent = `Distance: ${d.distance.toFixed(1)} m  |  Best: ${d.bestDistance.toFixed(1)} m  |  Coins: +${d.coinsEarned}`;
    if (gameoverStars)   gameoverStars.textContent   = "★".repeat(d.stars) + "☆".repeat(3 - d.stars);
    showScreen("gameover");
  }

  function showAdThenGameover(resultDetail) {
    pendingResult = resultDetail;
    const platform = api.platform;
    if (platform && platform.isPlatform()) {
      platform.requestInterstitialAd(() => { showGameoverFromResult(pendingResult); pendingResult = null; });
    } else {
      if (!adScreen || !adSlot) { showGameoverFromResult(pendingResult); return; }
      showScreen("ad");
      let finished = false;
      const done = () => {
        if (finished) return; finished = true;
        showGameoverFromResult(pendingResult); pendingResult = null;
      };
      if (btnAdContinue) btnAdContinue.onclick = () => done();
      setTimeout(done, 2000);
    }
  }

  window.addEventListener("game:run-ended", ev => {
    const d = ev.detail;
    if (!d) return;
    showAdThenGameover(d);
  });

  /* ── Level select theme icons & difficulty meta ──────── */
  const THEME_ICONS = {
    pastelFields:'🛣️', pastelHills:'⛰️', beach:'🏖️', farm:'🌾', cliffs:'🪨',
    meadow:'🌿', plains:'🌄', orchard:'🍎', lake:'🏞️', forest:'🌲',
    mountain:'🗻', desert:'🏜️', jungle:'🌴', snow:'❄️', canyon:'🏔️',
    volcano:'🌋', arctic:'🧊', rainforest:'🌧️', swamp:'🐸', storm:'⛈️',
    asteroid:'☄️', cave:'🌑', underwater:'🐠', space:'🚀', lava:'🔥',
    nightmare:'😱', chaos:'💥', moon:'🌙', inferno:'☠️', final:'🏆',
  };
  const DIFF_META = {
    easy:     { label:'Easy',     color:'#4ade80', glow:'rgba(74,222,128,0.25)'  },
    normal:   { label:'Normal',   color:'#60a5fa', glow:'rgba(96,165,250,0.25)'  },
    hard:     { label:'Hard',     color:'#f87171', glow:'rgba(248,113,113,0.25)' },
    advanced: { label:'Advanced', color:'#c084fc', glow:'rgba(192,132,252,0.28)' },
  };

  const levelGrid = document.getElementById("level-grid");

  function renderLevelSelect() {
    if (!levelGrid) return;
    const data = api.getLevels();
    const st   = api.storage;
    levelGrid.innerHTML = "";
    let lastDiff = null;

    for (const level of data) {
      if (level.difficulty !== lastDiff) {
        lastDiff = level.difficulty;
        const meta = DIFF_META[level.difficulty] || DIFF_META.easy;
        const hdr  = document.createElement('div');
        hdr.className = 'level-section-header';
        hdr.style.setProperty('--diff-color', meta.color);
        hdr.innerHTML = `<span class="diff-dot"></span>${meta.label}<span class="diff-line"></span>`;
        levelGrid.appendChild(hdr);
      }

      const unlocked = isLevelUnlocked(level.id, st);
      const stars    = st.getLevelStars(level.id) || 0;
      const icon     = THEME_ICONS[level.theme] || '🎮';
      const meta     = DIFF_META[level.difficulty] || DIFF_META.easy;

      const div = document.createElement('button');
      div.className = `level-tile ${level.difficulty}${unlocked ? '' : ' locked'}`;
      div.style.setProperty('--diff-color', meta.color);
      div.style.setProperty('--diff-glow',  meta.glow);
      div.setAttribute('aria-label', `Level ${level.id}: ${level.name}`);

      const starsHtml = Array.from({length:3}, (_,i) =>
        `<span class="star${i < stars ? ' earned' : ''}">${i < stars ? '★' : '☆'}</span>`
      ).join('');

      if (unlocked) {
        div.innerHTML = `
          <div class="lt-icon">${icon}</div>
          <div class="lt-num">${level.id}</div>
          <div class="lt-name">${level.name}</div>
          <div class="lt-stars">${starsHtml}</div>
          <div class="lt-play-hint">▶ Play</div>`;
        div.onclick = () => {
          api.selectLevel(level.id);
          const selVehicle = api.getCurrentSelection().vehicleId;
          api.storage.setLastSelected(level.id, selVehicle);
          api.startRun({ levelId: level.id, vehicleId: selVehicle });
          showScreen(null);
        };
      } else {
        div.innerHTML = `
          <div class="lt-icon lt-lock">🔒</div>
          <div class="lt-num">${level.id}</div>
          <div class="lt-name">${level.name}</div>
          <div class="lt-stars">${starsHtml}</div>`;
      }
      levelGrid.appendChild(div);
    }
  }

  const btnWatchAdCoins    = document.getElementById("btn-watch-ad-coins");
  const btnGameoverAdCoins = document.getElementById("btn-gameover-ad-coins");

  /* ── Stat colour/label maps ──────────────────────────── */
  const _statColors = {
    speed:           'linear-gradient(90deg,#f7971e,#ffd200)',
    acceleration:    'linear-gradient(90deg,#11998e,#38ef7d)',
    fuelEfficiency:  'linear-gradient(90deg,#36d1dc,#5b86e5)',
    grip:            'linear-gradient(90deg,#a18cd1,#fbc2eb)',
    traction:        'linear-gradient(90deg,#ff512f,#dd2476)',
  };
  const _statLabels = { speed:'Speed', acceleration:'Accel', fuelEfficiency:'Efficiency', grip:'Grip', traction:'Traction' };
  const _statKeys   = ['speed','acceleration','fuelEfficiency','grip','traction'];

  /* ── Upgrade tile definitions ────────────────────────── */
  const UPGRADE_DEFS = [
    {
      key:'engine', label:'ENGINE', maxLevel:10,
      color:'#f97316',
      icon:`<svg viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <rect x='8' y='14' width='26' height='20' rx='4' fill='#f97316' opacity='0.9'/>
        <rect x='15' y='6' width='6' height='10' rx='2' fill='#fb923c'/>
        <rect x='23' y='6' width='6' height='10' rx='2' fill='#fb923c'/>
        <rect x='2'  y='18' width='8' height='10' rx='2' fill='#fed7aa'/>
        <rect x='38' y='18' width='8' height='10' rx='2' fill='#fed7aa'/>
        <circle cx='21' cy='24' r='4.5' fill='#fff7ed' opacity='0.85'/>
        <circle cx='21' cy='24' r='2.2' fill='#f97316'/>
        <rect x='15' y='34' width='18' height='4' rx='2' fill='#fdba74'/>
      </svg>`
    },
    {
      key:'suspension', label:'SUSPEN.', maxLevel:10,
      color:'#a78bfa',
      icon:`<svg viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <rect x='20' y='2' width='8' height='44' rx='4' fill='#a78bfa' opacity='0.18'/>
        <polyline points='16,5 32,5 16,13 32,13 16,21 32,21 16,29 32,29 16,37 32,37' stroke='#a78bfa' stroke-width='3' fill='none' stroke-linecap='round' stroke-linejoin='round'/>
        <rect x='12' y='2' width='24' height='6' rx='3' fill='#c4b5fd'/>
        <rect x='12' y='40' width='24' height='6' rx='3' fill='#c4b5fd'/>
      </svg>`
    },
    {
      key:'tires', label:'TIRES', maxLevel:10,
      color:'#34d399',
      icon:`<svg viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <circle cx='24' cy='24' r='21' fill='#1e293b' stroke='#34d399' stroke-width='2.5'/>
        <circle cx='24' cy='24' r='14' fill='#0f172a'/>
        <circle cx='24' cy='24' r='7'  fill='#1e293b'/>
        <circle cx='24' cy='24' r='3.5' fill='#34d399' opacity='0.85'/>
        <line x1='24' y1='3'  x2='24' y2='10' stroke='#34d399' stroke-width='2.5' stroke-linecap='round'/>
        <line x1='24' y1='38' x2='24' y2='45' stroke='#34d399' stroke-width='2.5' stroke-linecap='round'/>
        <line x1='3'  y1='24' x2='10' y2='24' stroke='#34d399' stroke-width='2.5' stroke-linecap='round'/>
        <line x1='38' y1='24' x2='45' y2='24' stroke='#34d399' stroke-width='2.5' stroke-linecap='round'/>
        <line x1='7.5'  y1='7.5'  x2='12.5' y2='12.5' stroke='#34d399' stroke-width='2'  stroke-linecap='round'/>
        <line x1='40.5' y1='40.5' x2='35.5' y2='35.5' stroke='#34d399' stroke-width='2'  stroke-linecap='round'/>
        <line x1='40.5' y1='7.5'  x2='35.5' y2='12.5' stroke='#34d399' stroke-width='2'  stroke-linecap='round'/>
        <line x1='7.5'  y1='40.5' x2='12.5' y2='35.5' stroke='#34d399' stroke-width='2'  stroke-linecap='round'/>
      </svg>`
    },
    {
      key:'fuel', label:'4WD', maxLevel:10,
      color:'#fb923c',
      icon:`<svg viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <circle cx='10' cy='10' r='7' fill='none' stroke='#fb923c' stroke-width='2.5'/>
        <circle cx='38' cy='10' r='7' fill='none' stroke='#fb923c' stroke-width='2.5'/>
        <circle cx='10' cy='38' r='7' fill='none' stroke='#fb923c' stroke-width='2.5'/>
        <circle cx='38' cy='38' r='7' fill='none' stroke='#fb923c' stroke-width='2.5'/>
        <circle cx='10' cy='10' r='3' fill='#fed7aa'/>
        <circle cx='38' cy='10' r='3' fill='#fed7aa'/>
        <circle cx='10' cy='38' r='3' fill='#fed7aa'/>
        <circle cx='38' cy='38' r='3' fill='#fed7aa'/>
        <line x1='10' y1='17' x2='10' y2='31' stroke='#fb923c' stroke-width='2'/>
        <line x1='38' y1='17' x2='38' y2='31' stroke='#fb923c' stroke-width='2'/>
        <line x1='17' y1='10' x2='31' y2='10' stroke='#fb923c' stroke-width='2'/>
        <line x1='17' y1='38' x2='31' y2='38' stroke='#fb923c' stroke-width='2'/>
        <circle cx='24' cy='24' r='5' fill='#fb923c' opacity='0.9'/>
      </svg>`
    },
  ];

  const UPGRADE_COSTS = [200, 400, 700, 1200, 1800, 2600, 3600, 4900, 6500, 8500];

  /* ── Garage render ───────────────────────────────────── */
  function renderGarage() {
    const garageGrid  = document.getElementById('garage-grid');
    const garageCoins = document.getElementById('garage-coins');
    if (!garageGrid) return;

    const st         = api.storage;
    const selectedId = api.getCurrentSelection ? api.getCurrentSelection().vehicleId : null;

    if (garageCoins) garageCoins.textContent = `⚡ ${st.getCoins().toLocaleString()} coins`;
    garageGrid.innerHTML = '';

    vehicles.forEach(v => {
      if (v.defaultUnlocked && !st.isVehicleUnlocked(v.id)) st.unlockVehicle(v.id);
      const unlocked  = st.isVehicleUnlocked(v.id) || v.defaultUnlocked;
      const selected  = selectedId === v.id;
      const canAfford = st.getCoins() >= v.cost;

      const svgFn   = svgMap[v.id];
      const svgHTML = svgFn ? svgFn(v) : '';

      const card = document.createElement('div');
      card.className   = `gcard${unlocked ? '' : ' gcard-locked'}${selected ? ' gcard-selected' : ''}`;
      card.dataset.type      = v.type;
      card.dataset.id        = v.id;
      card.dataset.unlocked  = unlocked  ? '1' : '0';
      card.dataset.cost      = v.cost;
      card.dataset.canAfford = canAfford ? '1' : '0';
      card.style.cursor      = 'pointer';

      card.innerHTML = `
        <div class="gcard-bar" style="background:linear-gradient(90deg,${v.palette.body},${v.palette.accent})"></div>
        <div class="gcard-stage">
          ${!unlocked ? '<div class="gcard-lock">🔒</div>' : ''}
          ${selected  ? '<div class="gcard-selected-badge">✓ IN USE</div>' : ''}
          <div class="gcard-svg">${svgHTML}</div>
        </div>
        <div class="gcard-body">
          <div class="gcard-header">
            <div>
              <div class="gcard-name">${v.name}</div>
              <div class="gcard-type">${v.type === 'car' ? '🚗 Car' : '🏍️ Bike'}</div>
            </div>
            <div class="gcard-badge ${v.cost === 0 ? 'gfree' : 'gpaid'}">${v.cost === 0 ? 'FREE' : `⚡ ${v.cost}`}</div>
          </div>
          <div class="gcard-stats">
            ${_statKeys.map(k => `
              <div class="gcard-stat">
                <div class="gcard-stat-label">${_statLabels[k]}</div>
                <div class="gcard-stat-track">
                  <div class="gcard-stat-fill" style="width:${v.stats[k]*10}%;background:${_statColors[k]}"></div>
                </div>
              </div>`).join('')}
          </div>
          <div class="gcard-action">
            ${selected
              ? `<button class="gcard-btn gcard-btn-selected" disabled>✓ Selected</button>`
              : unlocked
                ? `<button class="gcard-btn gcard-btn-select" data-id="${v.id}">▶ Select</button>`
                : `<button class="gcard-btn gcard-btn-unlock${canAfford ? '' : ' cant-afford'}" data-id="${v.id}" data-cost="${v.cost}">
                     ${canAfford ? `Unlock ⚡${v.cost}` : `⚡${v.cost} coins needed`}
                   </button>`
            }
          </div>
        </div>`;
      garageGrid.appendChild(card);
    });

    // Tab filter
    document.querySelectorAll('.garage-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.garage-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const f = tab.dataset.filter;
        document.querySelectorAll('.gcard').forEach(c => {
          c.style.display = (f === 'all' || c.dataset.type === f) ? '' : 'none';
        });
      };
    });

    // Card tap: select / unlock / open upgrade screen
    garageGrid.onclick = e => {
      const selBtn  = e.target.closest('.gcard-btn-select');
      const unlBtn  = e.target.closest('.gcard-btn-unlock');
      const anyCard = e.target.closest('.gcard');
      const st      = api.storage;

      function doSelect(id) {
        api.selectVehicle(id);
        if (api.getCurrentSelection) {
          const sel = api.getCurrentSelection();
          api.storage.setLastSelected(sel.levelId, id);
        }
        renderGarage();
      }

      if (selBtn) { doSelect(selBtn.dataset.id); return; }

      if (unlBtn && !unlBtn.classList.contains('cant-afford')) {
        const id = unlBtn.dataset.id, cost = Number(unlBtn.dataset.cost);
        if (st.getCoins() >= cost) { st.addCoins(-cost); st.unlockVehicle(id); renderGarage(); }
        return;
      }

      if (anyCard) {
        const id         = anyCard.dataset.id;
        const isUnlocked = anyCard.dataset.unlocked === '1';
        const v          = vehicles.find(x => x.id === id);
        if (!v) return;
        if (isUnlocked) {
          openUpgradeScreen(v);
        } else {
          // shake if can't afford
          if (anyCard.dataset.canAfford !== '1') {
            anyCard.classList.add('gcard-shake');
            setTimeout(() => anyCard.classList.remove('gcard-shake'), 440);
          }
          openUnlockModal(v);
        }
      }
    };
  }

  /* ── Unlock Modal ────────────────────────────────────── */
  const _modalEl = document.createElement('div');
  _modalEl.id = 'unlock-modal';
  _modalEl.className = 'umodal-overlay';
  _modalEl.innerHTML = `
    <div class="umodal">
      <button class="umodal-close" id="umodal-close">✕</button>
      <div class="umodal-svg"  id="umodal-svg"></div>
      <div class="umodal-name" id="umodal-name"></div>
      <div class="umodal-type" id="umodal-type"></div>
      <div class="umodal-price-row">
        <span class="umodal-original" id="umodal-original"></span>
        <span class="umodal-current"  id="umodal-current"></span>
      </div>
      <div class="umodal-adsaved" id="umodal-adsaved"></div>
      <div class="umodal-btns">
        <button class="umodal-btn umodal-btn-ad"  id="umodal-btn-ad">📺 Watch Ad&nbsp;&nbsp;−50 coins</button>
        <button class="umodal-btn umodal-btn-buy" id="umodal-btn-buy"></button>
      </div>
      <div class="umodal-hint" id="umodal-hint"></div>
    </div>`;
  document.body.appendChild(_modalEl);
  _modalEl.style.display = 'none';

  let _modalVehicle = null;

  function _updateModalPrice() {
    if (!_modalVehicle) return;
    const v        = _modalVehicle;
    const discount = api.storage.getVehicleDiscount(v.id);
    const final    = Math.max(0, v.cost - discount);
    const coins    = api.storage.getCoins();
    const adsN     = Math.floor(discount / 50);

    const origEl  = document.getElementById('umodal-original');
    const curEl   = document.getElementById('umodal-current');
    const savedEl = document.getElementById('umodal-adsaved');
    const buyBtn  = document.getElementById('umodal-btn-buy');
    const hint    = document.getElementById('umodal-hint');

    origEl.textContent   = discount > 0 ? `⚡ ${v.cost}` : '';
    origEl.style.display = discount > 0 ? 'inline' : 'none';
    curEl.textContent    = final === 0 ? '🎉 FREE!' : `⚡ ${final} coins`;
    curEl.className      = final === 0 ? 'umodal-current free' : 'umodal-current';
    savedEl.textContent  = adsN > 0 ? `📺 ${adsN} ad${adsN > 1 ? 's' : ''} watched · ${discount} coins saved` : '';

    if (final === 0) {
      buyBtn.textContent = '🎉 Unlock for Free!';
      buyBtn.disabled    = false;
      buyBtn.className   = 'umodal-btn umodal-btn-buy afford';
    } else if (coins >= final) {
      buyBtn.textContent = `⚡ Buy for ${final} coins`;
      buyBtn.disabled    = false;
      buyBtn.className   = 'umodal-btn umodal-btn-buy afford';
    } else {
      buyBtn.textContent = `Need ${final - coins} more coins`;
      buyBtn.disabled    = true;
      buyBtn.className   = 'umodal-btn umodal-btn-buy no-afford';
    }
    hint.textContent = `You have ⚡ ${coins.toLocaleString()} coins`;
  }

  function openUnlockModal(v) {
    _modalVehicle = v;
    const svgFn = svgMap[v.id];
    document.getElementById('umodal-svg').innerHTML  = svgFn ? svgFn(v) : '';
    document.getElementById('umodal-name').textContent = v.name;
    document.getElementById('umodal-type').textContent = v.type === 'car' ? '🚗 Car' : '🏍️ Bike';
    _updateModalPrice();
    _modalEl.style.display = 'flex';
  }

  function closeUnlockModal() { _modalEl.style.display = 'none'; _modalVehicle = null; }

  document.getElementById('umodal-close').onclick = closeUnlockModal;
  _modalEl.addEventListener('click', e => { if (e.target === _modalEl) closeUnlockModal(); });

  document.getElementById('umodal-btn-ad').onclick = async () => {
    if (!_modalVehicle) return;
    const btn      = document.getElementById('umodal-btn-ad');
    const platform = api.platform;
    btn.disabled   = true;
    btn.textContent = '⏳ Loading ad...';
    try {
      let success = false;
      if (platform && platform.isPlatform()) {
        const result = await platform.requestRewardedAd({ size: 'medium' });
        success = result.success;
      } else {
        await new Promise(r => setTimeout(r, 1200));
        success = true;
      }
      if (success) { api.storage.addVehicleDiscount(_modalVehicle.id, 50); _updateModalPrice(); }
    } catch {/* ignore */} finally {
      btn.disabled    = false;
      btn.textContent = '📺 Watch Ad  −50 coins';
    }
  };

  document.getElementById('umodal-btn-buy').onclick = () => {
    if (!_modalVehicle) return;
    const v        = _modalVehicle;
    const discount = api.storage.getVehicleDiscount(v.id);
    const final    = Math.max(0, v.cost - discount);
    if (api.storage.getCoins() >= final) {
      api.storage.addCoins(-final);
      api.storage.unlockVehicle(v.id);
      closeUnlockModal();
      renderGarage();
    }
  };

  /* ═══════════════════════════════════════════════════════
     UPGRADE SCREEN — FULL SPECTACULAR VERSION
  ═══════════════════════════════════════════════════════ */
  const _upgrEl = document.createElement('div');
  _upgrEl.id = 'upgr-screen';

  _upgrEl.innerHTML = `
    <!-- Atmospheric background layers -->
    <div class="upgr-nebula upgr-nb1"></div>
    <div class="upgr-nebula upgr-nb2"></div>
    <div class="upgr-nebula upgr-nb3"></div>
    <div class="upgr-stars"></div>

    <!-- TOP BAR -->
    <div class="upgr-topbar">
      <button class="upgr-back-btn" id="upgr-back-btn">&#8249;</button>
      <div class="upgr-title-zone">
        <span class="upgr-screen-label">GARAGE</span>
        <span class="upgr-screen-title">&#9881; UPGRADES</span>
      </div>
      <div class="upgr-coin-display">
        <svg viewBox="0 0 22 22" width="22" height="22" style="animation:coinSpin 3s linear infinite;display:block;">
          <defs>
            <radialGradient id="ucg" cx="38%" cy="32%">
              <stop offset="0%"   stop-color="#ffe97a"/>
              <stop offset="60%"  stop-color="#ffd700"/>
              <stop offset="100%" stop-color="#b8860b"/>
            </radialGradient>
          </defs>
          <circle cx="11" cy="11" r="10" fill="url(#ucg)" stroke="#a0720a" stroke-width="1"/>
          <text x="11" y="15.5" text-anchor="middle" font-size="9" fill="#7a4800" font-weight="bold" font-family="Arial">$</text>
        </svg>
        <span id="upgr-coins-val">0</span>
      </div>
    </div>

    <!-- UPGRADE TILES -->
    <div class="upgr-tiles-panel">
      <div class="upgr-tiles-row" id="upgr-tiles-row"></div>
    </div>

    <!-- VEHICLE STAGE -->
    <div class="upgr-stage">
      <div class="upgr-svg-wrap" id="upgr-svg-wrap"></div>
      <div class="upgr-vname-bar">
        <span class="upgr-check-icon" id="upgr-check-icon">&#10003;</span>
        <span class="upgr-vname" id="upgr-vname"></span>
      </div>
    </div>

    <!-- SELECT BUTTON -->
    <button class="upgr-select-btn" id="upgr-select-btn">SELECT</button>
  `;

  document.body.appendChild(_upgrEl);
  _upgrEl.style.display = 'none';

  // Inject coinSpin keyframe if not already in stylesheet
  if (!document.getElementById('upgr-keyframe-style')) {
    const ks = document.createElement('style');
    ks.id = 'upgr-keyframe-style';
    ks.textContent = `@keyframes coinSpin { from{transform:rotateY(0deg)} to{transform:rotateY(360deg)} }
      @keyframes sparkle { 0%{transform:scale(0) rotate(0deg);opacity:1;} 100%{transform:scale(1.5) rotate(180deg);opacity:0;} }`;
    document.head.appendChild(ks);
  }

  let _upgrVehicle = null;

  function _upgrRefreshCoins() {
    const el = document.getElementById('upgr-coins-val');
    if (el) el.textContent = api.storage.getCoins().toLocaleString();
  }

  function _renderUpgradeTiles() {
    const row = document.getElementById('upgr-tiles-row');
    if (!row || !_upgrVehicle) return;
    const coins = api.storage.getCoins();

    row.innerHTML = UPGRADE_DEFS.map(def => {
      const lvl    = api.storage.getUpgradeLevel(_upgrVehicle.id, def.key);
      const maxed  = lvl >= def.maxLevel;
      const cost   = maxed ? 0 : UPGRADE_COSTS[lvl];
      const afford = !maxed && coins >= cost;
      const pct    = Math.round((lvl / def.maxLevel) * 100);

      return `
        <div class="upgr-tile${maxed ? ' upgr-tile-max' : ''}" data-key="${def.key}">
          <div class="upgr-tile-icon">${def.icon}</div>
          <div class="upgr-tile-label">${def.label}</div>
          <div class="upgr-tile-lvl">${lvl}<span class="upgr-tile-max-lv">/${def.maxLevel}</span></div>
          <div class="upgr-tile-bar">
            <div class="upgr-tile-fill" style="--target-w:${pct}%;width:${pct}%"></div>
          </div>
          <div class="upgr-tile-cost ${maxed ? 'maxed' : afford ? 'can-afford' : 'no-coins'}">
            ${maxed
              ? `<span class="upgr-max-badge">MAX &#10003;</span>`
              : `<svg viewBox="0 0 16 16" width="12" height="12">
                   <circle cx="8" cy="8" r="7.5" fill="#ffd700"/>
                   <text x="8" y="12" text-anchor="middle" font-size="7" fill="#8a5000" font-weight="bold">$</text>
                 </svg>
                 <span>${cost.toLocaleString()}</span>`}
          </div>
        </div>`;
    }).join('');
  }

  function _refreshUpgrSelectBtn() {
    const btn  = document.getElementById('upgr-select-btn');
    const badge= document.getElementById('upgr-check-icon');
    if (!btn || !_upgrVehicle) return;
    const isSel = api.getCurrentSelection?.().vehicleId === _upgrVehicle.id;
    btn.textContent = isSel ? '\u2713  SELECTED' : 'SELECT';
    btn.className   = isSel ? 'upgr-select-btn upgr-selected-active' : 'upgr-select-btn';
    if (badge) badge.style.opacity = isSel ? '1' : '0.2';
  }

  function openUpgradeScreen(v) {
    _upgrVehicle = v;
    const svgFn = svgMap[v.id];
    document.getElementById('upgr-svg-wrap').innerHTML = svgFn ? svgFn(v) : '';
    document.getElementById('upgr-vname').textContent  = v.name.toUpperCase();
    _upgrRefreshCoins();
    _renderUpgradeTiles();
    _refreshUpgrSelectBtn();
    _upgrEl.style.display = 'flex';
    _startStageParticles();
  }

  function closeUpgradeScreen() {
    _upgrEl.style.display = 'none';
    _upgrVehicle = null;
    _stopStageParticles();
    renderGarage();
  }

  document.getElementById('upgr-back-btn').onclick = closeUpgradeScreen;

  document.getElementById('upgr-select-btn').onclick = () => {
    if (!_upgrVehicle) return;
    const isSel = api.getCurrentSelection?.().vehicleId === _upgrVehicle.id;
    if (!isSel) {
      api.selectVehicle(_upgrVehicle.id);
      if (api.getCurrentSelection) {
        const sel = api.getCurrentSelection();
        api.storage.setLastSelected(sel.levelId, _upgrVehicle.id);
      }
      _refreshUpgrSelectBtn();
      renderGarage();

      // Celebratory burst on select
      const btn  = document.getElementById('upgr-select-btn');
      const rect = btn.getBoundingClientRect();
      _burst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#34d399');
    }
  };

  /* ── Tile click: upgrade with burst effect ───────────── */
  document.getElementById('upgr-tiles-row').addEventListener('click', e => {
    const tile = e.target.closest('.upgr-tile');
    if (!tile || !_upgrVehicle) return;

    const key  = tile.dataset.key;
    const def  = UPGRADE_DEFS.find(d => d.key === key);
    if (!def) return;

    const lvl = api.storage.getUpgradeLevel(_upgrVehicle.id, key);
    if (lvl >= def.maxLevel) {
      tile.classList.add('upgr-tile-bounce');
      setTimeout(() => tile.classList.remove('upgr-tile-bounce'), 400);
      return;
    }

    const cost = UPGRADE_COSTS[lvl];
    if (api.storage.getCoins() < cost) {
      tile.classList.add('upgr-tile-shake');
      setTimeout(() => tile.classList.remove('upgr-tile-shake'), 400);
      return;
    }

    api.storage.upgradeVehicle(_upgrVehicle.id, key, cost);
    _upgrRefreshCoins();
    _renderUpgradeTiles();

    // Particle burst at tile centre
    const rect = tile.getBoundingClientRect();
    _burst(rect.left + rect.width / 2, rect.top + rect.height / 2, def.color || '#63caff');
  });

  /* ── Rewarded ad — garage ────────────────────────────── */
  if (btnWatchAdCoins) {
    btnWatchAdCoins.onclick = async () => {
      const platform = api.platform;
      if (!platform || !platform.isPlatform()) { alert('Rewarded ads are only available on Poki or CrazyGames.'); return; }
      btnWatchAdCoins.disabled    = true;
      btnWatchAdCoins.textContent = 'Loading ad...';
      try {
        const result = await platform.requestRewardedAd({ size: 'medium' });
        if (result.success) { api.storage.addCoins(50); alert('You earned 50 coins!'); }
        else alert('Ad was not completed.');
      } catch (err) {
        console.error('Rewarded ad error:', err);
        alert('Failed to load ad. Please try again.');
      } finally {
        btnWatchAdCoins.disabled    = false;
        btnWatchAdCoins.textContent = 'Watch Ad for 50 Coins';
      }
    };
  }

  /* ── Rewarded ad — gameover ──────────────────────────── */
  if (btnGameoverAdCoins) {
    btnGameoverAdCoins.onclick = async () => {
      const platform = api.platform;
      if (!platform || !platform.isPlatform()) { alert('Rewarded ads are only available on Poki or CrazyGames.'); return; }
      btnGameoverAdCoins.disabled    = true;
      btnGameoverAdCoins.textContent = 'Loading ad...';
      try {
        const result = await platform.requestRewardedAd({ size: 'medium' });
        if (result.success) {
          api.storage.addCoins(50);
          alert('You earned 50 coins!');
          if (pendingResult) { pendingResult.coinsEarned += 50; showGameoverFromResult(pendingResult); }
        } else alert('Ad was not completed.');
      } catch (err) {
        console.error('Rewarded ad error:', err);
        alert('Failed to load ad. Please try again.');
      } finally {
        btnGameoverAdCoins.disabled    = false;
        btnGameoverAdCoins.textContent = 'Watch Ad for 50 Coins';
      }
    };
  }

  /* ── Level unlock logic ──────────────────────────────── */
  function isLevelUnlocked(levelId, storage) {
    if (levelId === 1) return true;
    if (levelId <= 3)  return true;
    const prevStars = storage.getLevelStars(levelId - 1) || 0;
    const totalStarsBefore = Object.entries(storage.getAll().levelStars || {})
      .filter(([id]) => Number(id) < levelId)
      .reduce((acc, [, s]) => acc + s, 0);
    return prevStars >= 2 || totalStarsBefore >= levelId;
  }
}
// ===== main.js =====
// main.js — Game controller and main loop
// Enhanced version — 100% original code, free to publish (no copyright claims)












/* ─── Game state enum ───────────────────────────────── */
const GAME_STATE = {
  IDLE:     "idle",
  RUNNING:  "running",
  PAUSED:   "paused",
  GAMEOVER: "gameover",
};

/* ─── Canvas setup ──────────────────────────────────── */
const canvas = document.getElementById("game-canvas");
const ctx    = canvas.getContext("2d");

/* ─── Core singletons ───────────────────────────────── */
let engine;
let world;
let renderer;
let hud;
let input;
let storage;
let audioManager;
let particles;
let platform;

/* ─── Game state ─────────────────────────────────────── */
let currentState    = GAME_STATE.IDLE;
let currentLevelId  = 1;
let currentVehicleId= getDefaultVehicleId();

let lastTimestamp = 0;
let cameraX = 0;
let cameraY = 0;
let runData = null;

/* ─── Restore last saved selections ──────────────────── */
function restoreSelections() {
  const saved = storage.getAll();
  if (saved.lastSelectedVehicle) currentVehicleId = saved.lastSelectedVehicle;
  if (saved.lastSelectedLevel)   currentLevelId   = saved.lastSelectedLevel;
}

/* ─── Apply per-vehicle upgrade boosts ───────────────── */
function applyUpgrades(vehicle, st) {
  const eLv = st.getUpgradeLevel(vehicle.id, 'engine');
  const sLv = st.getUpgradeLevel(vehicle.id, 'suspension');
  const tLv = st.getUpgradeLevel(vehicle.id, 'tires');
  const fLv = st.getUpgradeLevel(vehicle.id, 'fuel');
  return {
    ...vehicle,
    stats: {
      ...vehicle.stats,
      torque:         vehicle.stats.torque         * (1 + 0.13 * eLv),
      fuelCapacity:   vehicle.stats.fuelCapacity    * (1 + 0.15 * fLv),
      fuelEfficiency: vehicle.stats.fuelEfficiency  * (1 + 0.08 * fLv),
    },
    wheelRadius:      vehicle.wheelRadius      * (1 + 0.06 * tLv),
    wheelYOffset:     vehicle.wheelYOffset     * (1 + 0.06 * tLv),
    suspensionLength: vehicle.suspensionLength * (1 + 0.10 * sLv),
  };
}

/* ─── Canvas resize ──────────────────────────────────── */
function resizeCanvas() {
  const dpr  = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width  * dpr;
  canvas.height = rect.height * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  if (renderer) renderer.resize(rect.width, rect.height);
}

/* ─── Core initialisation ────────────────────────────── */
async function initCore() {
  try {
    engine       = createEngine();
    world        = createWorld(engine);
    storage      = new Storage(window.localStorage);
    audioManager = new AudioManager();
    particles    = new ParticleSystem();
    platform     = new PlatformIntegration();

    // Platform SDK init (Poki / CrazyGames) — non-blocking
    platform.init(audioManager).catch(err => {
      console.warn('Platform SDK init failed (non-critical):', err);
    });

    renderer = new GameRenderer(ctx, world, particles);
    hud      = new Hud();
    input    = new InputManager(canvas);

    restoreSelections();

    initUI({
      startRun,
      restartRun,
      quitToMenu,
      selectLevel,
      selectVehicle,
      getProgress:        () => storage.getAll(),
      getVehicles:        () => vehicles,
      getLevels:          () => levels,
      getCurrentSelection:() => ({ levelId: currentLevelId, vehicleId: currentVehicleId }),
      storage,
      platform,
    });

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    console.log('Game initialised successfully');

    // Auto-start level from URL param
    if (window._pendingLevel) {
      const lvId = window._pendingLevel;
      window._pendingLevel = null;
      const saved = storage.getAll();
      const vid = saved.lastSelectedVehicle || currentVehicleId;
      setTimeout(() => {
        try { startRun({ levelId: lvId, vehicleId: vid }); showScreen(null); } catch(e) {}
      }, 200);
    }
  } catch (error) {
    console.error('Failed to initialise game:', error);
    alert('Game initialisation failed. Please check console for details.');
  }
}

/* ─── Start a run ────────────────────────────────────── */
function startRun({ levelId, vehicleId }) {
  try {
    currentLevelId   = levelId   ?? currentLevelId;
    currentVehicleId = vehicleId ?? currentVehicleId;

    const level = getLevelById(currentLevelId);
    if (!level) { console.error('Level not found:', currentLevelId); return; }

    const vehicle = vehicles.find(v => v.id === currentVehicleId) || vehicles[0];
    if (!vehicle) { console.error('Vehicle not found:', currentVehicleId); return; }

    setWorldGravity(world, level.gravity);

    const { terrainBodies, coinBodies, fuelBodies, boostBodies, finishX } =
      createTerrainForLevel(world, level);

    const upgV            = applyUpgrades(vehicle, storage);
    const vehicleInstance = attachVehicleToWorld(world, upgV, level);

    runData = {
      level,
      vehicle: upgV,
      terrainBodies,
      coinBodies,
      fuelBodies,
      boostBodies,
      finishX,
      vehicleInstance,
      fuel:           upgV.stats.fuelCapacity,
      boost:          0,
      rpm:            0,
      coinsCollected: 0,
      distance:       0,
      bestDistance:   storage.getBestDistance(currentLevelId) || 0,
      isFinished:     false,
      causeOfEnd:     null,
    };

    cameraX       = vehicleInstance.chassis.position.x;
    cameraY       = vehicleInstance.chassis.position.y;
    lastTimestamp = performance.now();

    audioManager.startEngine();
    audioManager.startMusic(level.theme);

    if (platform) platform.gameplayStart();

    currentState = GAME_STATE.RUNNING;
    console.log('Game started successfully');
  } catch (error) {
    console.error('Error starting run:', error);
    alert('Failed to start game: ' + error.message);
  }
}

/* ─── Restart / Quit ─────────────────────────────────── */
function restartRun() {
  clearWorld();
  startRun({ levelId: currentLevelId, vehicleId: currentVehicleId });
}

function quitToMenu() {
  clearWorld();
  audioManager.stopEngine();
  audioManager.stopMusic();
  currentState = GAME_STATE.IDLE;
  if (platform) platform.gameplayStop();
}

function selectLevel(levelId)   { currentLevelId   = levelId; }
function selectVehicle(vehicleId) {
  currentVehicleId = vehicleId;
  storage.setLastSelected(currentLevelId, vehicleId);
}

/* ─── Clear physics world ────────────────────────────── */
function clearWorld() {
  if (!world || typeof Matter === 'undefined') return;
  try {
    const allBodies = Matter.Composite.allBodies(world);
    for (const b of allBodies) Matter.World.remove(world, b);
  } catch (error) { console.warn('Error clearing world:', error); }
}

/* ─── Per-frame update ───────────────────────────────── */
function update(dt) {
  if (!runData || currentState !== GAME_STATE.RUNNING) return;

  const v            = runData.vehicleInstance;
  const gas          = input.isGasPressed();
  const brake        = input.isBrakePressed();
  const boostPressed = input.isBoostPressed();

  const control = { gas, brake, boost: boostPressed && runData.boost > 0 };
  const result  = stepPhysics(engine, world, v, runData, control, dt);

  runData.rpm            = result.rpm;
  runData.fuel           = result.fuel;
  runData.boost          = result.boost;
  runData.coinsCollected+= result.collectedCoins;
  runData.distance       = Math.max(runData.distance, result.distance);

  if (control.gas && runData.rpm > 80) {
    particles.spawnExhaust(v.wheelB.position.x, v.wheelB.position.y);
  }

  hud.setLowFuel(!!result.lowFuel);

  // Smooth camera follow
  cameraX += (v.chassis.position.x - cameraX) * 0.10;
  cameraY += (v.chassis.position.y - cameraY) * 0.05;

  hud.update({
    coins:       storage.getCoins() + runData.coinsCollected,
    distance:    runData.distance,
    bestDistance:Math.max(runData.bestDistance, runData.distance),
    rpm:         runData.rpm,
    fuel:        runData.fuel,
    fuelMax:     runData.vehicle.stats.fuelCapacity,
    boost:       runData.boost,
    boostMax:    100,
  });

  renderer.update(dt, {
    cameraX,
    cameraY,
    levelTheme: runData.level.theme,
    vehicle:    runData.vehicle,
  });

  audioManager.updateEngine(runData.rpm, gas);

  // Feedback effects
  if (result.collectedCoins > 0) {
    particles.spawnSparkle(v.chassis.position.x, v.chassis.position.y - 40);
    audioManager.playCoin();
  }
  if (result.collectedFuel) audioManager.playFuel();
  if (result.usedBoost)     audioManager.playBoost();

  if (result.ended) handleRunEnd(result);
}

/* ─── Run end handler ────────────────────────────────── */
function handleRunEnd(result) {
  currentState = GAME_STATE.GAMEOVER;
  audioManager.stopEngine();
  audioManager.stopMusic();

  const totalCoins = storage.getCoins() + runData.coinsCollected;
  storage.setCoins(totalCoins);

  const newBest = Math.max(runData.bestDistance, runData.distance);
  storage.setBestDistance(currentLevelId, newBest);

  let stars = 1;
  if (runData.distance >= runData.finishX * 0.8) stars = 2;
  if (result.reachedFinish) stars = 3;
  storage.setLevelStars(currentLevelId, Math.max(storage.getLevelStars(currentLevelId) || 0, stars));

  if (result.reachedFinish) audioManager.playWin();
  else                      audioManager.playCrash();

  window.dispatchEvent(
    new CustomEvent("game:run-ended", {
      detail: {
        levelId:       currentLevelId,
        vehicleId:     currentVehicleId,
        distance:      runData.distance,
        bestDistance:  newBest,
        coinsEarned:   runData.coinsCollected,
        stars,
        reachedFinish: result.reachedFinish,
        cause:         result.cause,
      },
    })
  );
}

/* ─── Main loop ──────────────────────────────────────── */
function loop(timestamp) {
  requestAnimationFrame(loop);

  if (!lastTimestamp) lastTimestamp = timestamp;
  let dt = (timestamp - lastTimestamp) / 1000;
  if (dt > 0.05) dt = 0.05; // cap at 50 ms to avoid spiral of death
  lastTimestamp = timestamp;

  if (currentState === GAME_STATE.RUNNING) {
    update(dt);
  } else {
    renderer.clearFrame();
  }
}

/* ─── Global event listeners ─────────────────────────── */
window.addEventListener("game:pause",   () => {
  if (currentState === GAME_STATE.RUNNING) { currentState = GAME_STATE.PAUSED; audioManager.suspend(); }
});
window.addEventListener("game:resume",  () => {
  if (currentState === GAME_STATE.PAUSED) { currentState = GAME_STATE.RUNNING; audioManager.resume(); }
});
window.addEventListener("game:restart", () => restartRun());
window.addEventListener("game:quit",    () => quitToMenu());

/* ─── Entry point ────────────────────────────────────── */
window.addEventListener("DOMContentLoaded", () => {
  // Guard: file:// protocol
  if (window.location.protocol === 'file:') {
    document.body.innerHTML = `
      <div style="padding:40px;text-align:center;font-family:sans-serif;background:#060b1a;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;">
        <div>
          <h1 style="color:#f97316;font-size:2rem;margin-bottom:16px;">⚠️ Web Server Required</h1>
          <p style="font-size:1.1rem;margin-bottom:24px;opacity:0.8;">This game must be run from a web server, not directly from file://</p>
          <div style="background:rgba(255,255,255,0.05);padding:24px;border-radius:14px;text-align:left;max-width:580px;margin:0 auto;border:1px solid rgba(255,255,255,0.1);">
            <p style="margin:10px 0;"><strong>Python:</strong> <code style="background:#1a2540;padding:4px 10px;border-radius:6px;">python -m http.server 8000</code></p>
            <p style="margin:10px 0;"><strong>Node.js:</strong> <code style="background:#1a2540;padding:4px 10px;border-radius:6px;">npx serve</code></p>
            <p style="margin:10px 0;"><strong>VS Code:</strong> Install the "Live Server" extension</p>
            <p style="margin-top:18px;opacity:0.6;">Then open: <code style="background:#1a2540;padding:4px 10px;border-radius:6px;">http://localhost:8000/index.html</code></p>
          </div>
        </div>
      </div>`;
    return;
  }

  // Guard: Matter.js
  if (typeof Matter === 'undefined') {
    console.error('Matter.js not loaded!');
    document.body.innerHTML = '<div style="padding:20px;color:#f97316;"><h1>Error</h1><p>Matter.js physics library failed to load. Please check your internet connection.</p></div>';
    return;
  }

  // Guard: canvas
  if (!canvas || !ctx) { console.error('Canvas not found!'); return; }

  console.log('Starting game initialisation...');

  // Handle ?level=X from levels.html
  const urlParams = new URLSearchParams(window.location.search);
  const lvParam = urlParams.get('level');
  if (lvParam) {
    const lvId = parseInt(lvParam, 10);
    if (lvId >= 1 && lvId <= 30) {
      // Start run after init completes
      setTimeout(() => {
        try {
          const sel = typeof getCurrentSelection === 'function' ? {vehicleId:'rusty_hatchback'} : {vehicleId:'rusty_hatchback'};
          window._pendingLevel = lvId;
        } catch(e) {}
      }, 100);
    }
  }
  initCore().catch(error => {
    console.error('Critical initialisation error:', error);
    alert('Game failed to initialise. Please check console for details.');
  });
  requestAnimationFrame(loop);
});
</script>
</body>
</html>